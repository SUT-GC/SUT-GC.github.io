---
layout: post
title: "Elasticsearch å­¦ä¹ ç¬”è®°"
description: "Elasticsearch å­¦ä¹ ç¬”è®°"
categories: [å­¦ä¹ ]
tags: [elasticsearch]
---

* Kramdown table of contents
{:toc .toc}

# elasticsearch å­¦ä¹ ç¬”è®°

## 1 åŸºæœ¬æ¦‚å¿µ

### 1.1 æ¥è¿‘å®æ—¶ï¼ˆNRTï¼‰

Elasticsearch æ˜¯ä¸€ä¸ªæ¥è¿‘å®æ—¶çš„æœç´¢å¹³å°ï¼Œä»ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£åˆ°è¿™ä¸ªæ–‡æ¡£è¢«æœç´¢åˆ°æœ‰ä¸€ä¸ªå¾ˆå°çš„å»¶è¿Ÿï¼ˆé€šå¸¸æ˜¯1sï¼‰

### 1.2 é›†ç¾¤ï¼ˆClusterï¼‰

ä¸€ä¸ªé›†ç¾¤å°±æ˜¯ç”±ä¸€ä¸ªèŠ‚ç‚¹ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä»–ä»¬å…±åŒæŒæœ‰ä½ å…¨éƒ¨çš„æ•°æ®ï¼Œå¹¶ä¸”ä¸€èµ·æä¾›ç´¢å¼•ä¸æœç´¢åŠŸèƒ½ã€‚ä¸€ä¸ªé›†ç¾¤ç”±ä¸€ä¸ªå”¯ä¸€çš„åå­—æ ‡è¯†ï¼Œä¸€ä¸ªèŠ‚ç‚¹é€šå¸¸æŒ‡å®šæŸä¸ªé›†ç¾¤çš„åå­—æ¥åŠ å…¥è¿™ä¸ªé›†ç¾¤ã€‚

> ä¸€ä¸ªé›†ç¾¤ä¸­åªåŒ…å«ä¸€ä¸ªèŠ‚ç‚¹æ˜¯åˆæ³•çš„ã€‚å¦å¤–ä½ å¯ä»¥æ‹¥æœ‰å¤šä¸ªé›†ç¾¤ï¼Œä»¥åå­—åˆ’åˆ†

### 1.3 èŠ‚ç‚¹ï¼ˆNodeï¼‰

ä¸€ä¸ªèŠ‚ç‚¹ç›´è§‚ç‚¹è¯´å°±æ˜¯ä¸€ä¸ªé›†ç¾¤ä¸­çš„ä¸€å°æœåŠ¡å™¨ï¼Œä½œä¸ºé›†ç¾¤çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå­˜å‚¨ä½ çš„æ•°æ®ï¼Œå‚ä¸é›†ç¾¤çš„ç´¢å¼•å’Œæœç´¢åŠŸèƒ½ã€‚å®ƒä¹Ÿæ˜¯ç”¨ä¸€ä¸ªåå­—æ¥æ ‡è¯†çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªåå­—æ˜¯éšæœºçš„Marvelè§’è‰²çš„åå­—ï¼Œè¿™ä¸ªåå­—ä¼šåœ¨èŠ‚ç‚¹å¯åŠ¨çš„æ—¶å€™è¢«åˆ†é…ã€‚
ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥é€šè¿‡é…ç½®é›†ç¾¤åç§°çš„æ–¹å¼åŠ å…¥ä¸€ä¸ªæŒ‡å®šçš„é›†ç¾¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¢«åŠ å…¥åå«"elasticsearch"çš„é›†ç¾¤å½“ä¸­ã€‚

### 1.4 ç´¢å¼•ï¼ˆIndexï¼‰

ä¸€ä¸ªç´¢å¼•å°±æ˜¯ä¸€ä¸ªæ‹¥æœ‰ç›¸ä¼¼ç‰¹å¾çš„æ–‡æ¡£é›†åˆã€‚æ¯”å¦‚è¯´å­¦ç”Ÿæ•°æ®ç´¢å¼•ï¼Œè®¢å•æ•°æ®ç´¢å¼•ã€‚ä¸€ä¸ªç´¢å¼•ç”±ä¸€ä¸ªåå­—æ¥æ ‡è¯†ï¼ˆå¿…é¡»å…¨æ˜¯å°å†™å­—æ¯ï¼‰ï¼Œå¹¶ä¸”å½“æˆ‘ä»¬å¯¹è¿™ä¸ªç´¢å¼•ä¸­çš„æ–‡æ¡£è¿›è¡Œæœç´¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤çš„æ—¶å€™éƒ½ä¼šç”¨åˆ°è¿™ä¸ªåå­—ã€‚åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œä½ èƒ½å¤Ÿåˆ›å»ºä»»æ„å¤šçš„ç´¢å¼•ã€‚

### 1.5 ç±»å‹ï¼ˆTypeï¼‰

åœ¨ä¸€ä¸ªç´¢å¼•ä¸­ï¼Œä½ å¯ä»¥æŒ‡å®šå¤šä¸ªç±»å‹ã€‚ä¸€ä¸ªç±»å‹æ˜¯ç´¢å¼•çš„ä¸€ä¸ªé€»è¾‘ä¸Šçš„åˆ†ç±»ï¼Œé€šå¸¸ä¼šä»¥ä¸€ç»„ç›¸åŒå­—æ®µçš„æ–‡æ¡£å®šä¹‰ä¸€ä¸ªç±»å‹ã€‚æ¯”å¦‚æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªåšå®¢ç³»ç»Ÿï¼Œé‚£ä¹ˆè¿™ä¸ªåšå®¢ç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œåšå®¢ç³»ç»Ÿä¸­çš„ç”¨æˆ·æ•°æ®å®šä¹‰ä¸€ä¸ªç±»å‹ï¼Œåšå®¢æ•°æ®å¯ä»¥å®šä¹‰ä¸€ä¸ªç±»å‹ã€‚

### 1.6 æ–‡æ¡£ï¼ˆDocumentï¼‰

ä¸€ä¸ªæ–‡æ¡£æ˜¯ä¸€ä¸ªå¯ä»¥è¢«ç´¢å¼•çš„åŸºç¡€ä¿¡æ¯å•å…ƒï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªå®¢æˆ·æ–‡æ¡£ï¼Œäº§å“æ–‡æ¡£ï¼Œè®¢å•æ–‡æ¡£ï¼Œæ–‡æ¡£ä»¥jsonçš„å½¢å¼å­˜å‚¨ã€‚åœ¨ä¸€ä¸ªindex/typeä¸­å¯ä»¥æœ‰å¤šä¸ªæ–‡æ¡£ï¼Œä½†æ˜¯æ³¨æ„ï¼Œä¸€ä¸ªæ–‡æ¡£ç‰©ç†ä¸Šå­˜åœ¨äºä¸€ä¸ªç´¢å¼•ä¸­ï¼Œä½†æ˜¯æ–‡æ¡£å¿…é¡»è¢«ç´¢å¼•ï¼èµ‹äºˆä¸€ä¸ªç´¢å¼•çš„type

### 1.7 åˆ†ç‰‡å’Œå¤åˆ¶ ï¼ˆShards and Replicasï¼‰

ä¸€ä¸ªç´¢å¼•å¯ä»¥å­˜å‚¨è¶…å‡ºå•ä¸ªèŠ‚ç‚¹ç¡¬ä»¶é™åˆ¶çš„å¤§é‡æ•°æ®ã€‚æ¯”å¦‚ä¸€ä¸ªå…·æœ‰10äº¿æ–‡æ¡£çš„ç´¢å¼•å æ®1TBçš„ç£ç›˜ç©ºé—´ï¼Œä½†æ˜¯ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¸èƒ½æä¾›è¿™ä¹ˆå¤§çš„å­˜å‚¨ç©ºé—´ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒElasticsearchæä¾›äº†å°†ç´¢å¼•åˆ’åˆ†æˆå¤šä¸ªåˆ†ç‰‡çš„èƒ½åŠ›ã€‚å½“åˆ›å»ºç´¢å¼•çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šåˆ›å»ºå¤šå°‘åˆ†ç‰‡æ•°é‡ã€‚æ¯ä¸ªåˆ†ç‰‡æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå…·æœ‰åŠŸèƒ½å®Œå–„å¹¶ä¸”ç‹¬ç«‹çš„â€œç´¢å¼•â€ã€‚

åˆ†ç‰‡ä¹‹æ‰€ä»¥é‡è¦ï¼Œä¸»è¦åŸå› æœ‰ï¼š

* å…è®¸æ°´å¹³åˆ†å‰²ï¼æ‰©å±•å®¹é‡
* å…è®¸åœ¨åˆ†ç‰‡ä¹‹ä¸Šè¿›è¡Œåˆ†å¸ƒå¼ï¼Œå¹¶è¡Œæ“ä½œï¼Œæé«˜æ€§èƒ½ï¼ååé‡

åœ¨ç½‘ç»œç¯å¢ƒé‡Œï¼ŒæŸä¸ªåˆ†ç‰‡å®Œå…¨æœ‰å¯èƒ½å¤„äºç¦»çº¿æ´»ç€æ¶ˆå¤±çš„çŠ¶æ€ï¼Œæ•…éšœè½¬ç§»æœºåˆ¶æ˜¯éå¸¸é‡è¦çš„ï¼Œå› æ­¤Elasticsearch å…è®¸æˆ‘ä»¬åˆ›å»ºåˆ†ç‰‡çš„ä¸€ä»½æ´»ç€å¤šä»½æ‹·è´ï¼Œè¿™å«å¤åˆ¶ã€‚

å¤åˆ¶é‡è¦çš„åŸå› ï¼š

* é«˜å¯ç”¨
* æœç´¢å¯ä»¥åœ¨æ‰€æœ‰çš„å¤åˆ¶ä¸Šå¹¶è¡Œæ“ä½œï¼Œå¤åˆ¶å¯ä»¥æ‰©å±•æœç´¢é‡

é»˜è®¤æƒ…å†µä¸‹ï¼ŒEs(Elasticsearchçš„ç®€ç§°ï¼‰ä¸ºæˆ‘ä»¬æ¯ä¸ªç´¢å¼•åˆ›å»º5ä¸ªä¸»åˆ†ç‰‡å’Œä¸€ä¸ªå¤åˆ¶ï¼Œè¿™å°±æ„å‘³ç€é›†ç¾¤ä¸­è‡³å°‘æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç´¢å¼•ä¼šå°†æœ‰5ä¸ªä¸»åˆ†ç‰‡å’Œå¦å¤–5ä¸ªå¤åˆ¶åˆ†ç‰‡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç´¢å¼•ä¸€å…±æœ‰10ä¸ªåˆ†ç‰‡ã€‚

> ps è¿™é‡Œç´¢å¼•ï¼Œç±»å‹ï¼Œæ–‡æ¡£ï¼Œåˆ†ç‰‡å¤åˆ¶çš„æ¦‚å¿µå¯èƒ½æœ‰ç‚¹æ¨¡ç³Šçš„åŒå­¦ï¼Œæˆ‘å¯ä»¥ä¸¾ä¸€ä¸ªç›¸ä¼¼çš„ğŸŒ°    
> 
> ES        ---- >       Mysql
> Index     ---- >       database
> Type      ---- >       table
> Document  ---- >       table.rows
> Shards    ---- >       sharding
> Replicas  ---- >       master and slave
>   
> ä»…ä»…æ˜¯åšæ¦‚å¿µä¸Šçš„ç†è§£å¸®åŠ©ï¼Œä¸¤è€…å¹¶ä¸æ˜¯ä¸€ç§ä¸œè¥¿


---

## 2. å®‰è£…

Elasticsearch éœ€è¦ java7ä»¥åŠä»¥ä¸Šç‰ˆæœ¬

ç”¨ä¸‹é¢çš„å‘½ä»¤ä¸‹è½½ Elasticsearch 1.4.2 tar åŒ…

 ```
 curl -L -O https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.4.2.tar.gz
 ```

å°†å…¶è§£å‹å¹¶ä¸”å¯åŠ¨å•ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤

```
tar -xvf elasticsearch-1.4.2.tar.gz
cd elasticsearch-1.4.2/bin
./elasticsearch
```

æˆ‘ä»¬å¯ä»¥è¦†ç›–é›†ç¾¤æˆ–è€…èŠ‚ç‚¹çš„åå­—å¯åŠ¨

```
./elasticsearch --cluster.name my_cluster_name --node.name my_node_name
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearchä½¿ç”¨9200æ¥æä¾›REST API çš„è®¿é—®ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œè¿™ä¸ªç«¯å£æ˜¯å¯ä»¥è¢«é…ç½®çš„

å…¶äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿå¯ä»¥ä» [å®˜ç½‘](https://www.elastic.co/downloads/elasticsearch)

---

## 3 æ“ä½œé›†ç¾¤

### 3.1 rest æ¥å£

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªæ­£å¸¸è¿è¡Œçš„èŠ‚ç‚¹ï¼ˆå’Œé›†ç¾¤ï¼‰ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦å»ç†è§£å¦‚æœä¸å…¶é€šä¿¡ã€‚å¹¸è¿çš„æ˜¯ï¼ŒESæä¾›äº†éå¸¸å…¨é¢å¼ºå¤§çš„REST API, åˆ©ç”¨è¿™ä¸ªREST API å¯ä»¥ä¸é›†ç¾¤äº¤äº’ï¼Œä¸‹é¢æˆ‘ä»¬æç‚¹äº‹æƒ…ã€‚

### 3.2 é›†ç¾¤å¥åº·

æˆ‘ä»¬ä½¿ç”¨Curlæˆ–è€…ä»»ä½•ä¸€ä¸ªå¯ä»¥åˆ›å»ºHTTP/RESTè°ƒç”¨çš„å·¥å…·æ¥ä½¿ç”¨è¯¥åŠŸèƒ½

å‘½ä»¤

GET `localhost:9200/_cat/health?v` 

å“åº”

```
epoch      timestamp cluster       status node.total node.data shards pri relo init unassign 
1489252285 02:11:25  elasticsearch green           1         1      0   0    0    0        0 
```

> ä¸‹é¢é»˜è®¤æ­¤æ ¼å¼ï¼ˆä¸Šä¸€ä¸ªæ˜¯è¯·æ±‚ï¼Œä¸‹ä¸€ä¸ªæ˜¯å“åº”) âš ï¸


æˆ‘ä»¬æŸ¥åˆ°é›†ç¾¤åå­—æ˜¯"elasticsearch",çŠ¶æ€green

* green ä¸€åˆ‡æ­£å¸¸ï¼ˆé›†ç¾¤åŠŸèƒ½é½å…¨ï¼‰
* yello æ‰€æœ‰æ•°æ®æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯æŸäº›å¤åˆ¶æ²¡æœ‰åˆ†é…ï¼ˆåŠŸèƒ½é½å…¨ï¼‰
* red ç”±äºæŸäº›åŸå› ï¼Œæ•°æ®ä¸å¯ç”¨

ä¸Šé¢çš„å“åº”ä¸­ï¼Œå¯ä»¥çœ‹å‡º ä¸€ä¸ªé›†ç¾¤ï¼Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ²¡æœ‰åˆ†ç‰‡ï¼Œç”±äºæˆ‘ä»¬é»˜è®¤é…ç½®ï¼Œæ‰€ä»¥esä½¿ç”¨`å¤šæ’­`çš„å‘ç°å…¶ä»–èŠ‚ç‚¹ã€‚

### 3.3 åˆ—å‡ºæ‰€æœ‰èŠ‚ç‚¹

GET `localhost:9200/_cat/nodes?v`

```
host      ip        heap.percent ram.percent load node.role master name    
localhost 127.0.0.1           10          90 0.15 d         *      Vulture 
```


### 3.4 åˆ—å‡ºæ‰€æœ‰ç´¢å¼•

GET `localhost:9200/_cat/indices?v`

```
health index pri rep docs.count docs.deleted store.size pri.store.size
```

æ²¡æœ‰ç´¢å¼•

### 3.5 åˆ›å»ºç´¢å¼•

PUT `localhost:9200/test?pretty` 

```json
{
  "acknowledged" : true
}
```

> pretty ç¾ä¸½çš„ç”¨jsonæ‰“å°è¿”å›

GET `localhost:9200/_cat/indices?v`

```
health status index pri rep docs.count docs.deleted store.size pri.store.size 
yellow open   test    5   1          0            0       575b           575b
```

> yellow ä»£è¡¨æ²¡æœ‰å¤åˆ¶ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒESä¼šåˆ†é…ä¸€ä¸ªå¤åˆ¶ï¼Œä½†æ˜¯ç°åœ¨åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥å¤åˆ¶ç”¨ä¸äº†

### 3.5 ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£

å› ä¸ºå¦‚æœç´¢å¼•ä¸€ä¸ªæ–‡æ¡£ï¼Œå¿…é¡»æœ‰ä¸ªç±»å‹(Type),æˆ‘ä»¬æŠŠä¸€ä¸ªå­¦ç”Ÿä¿¡æ¯ç´¢å¼•å…¥test

PUT `localhost:9200/test/student/1`

```
curl -i -X PUT \
   -H "Content-Type:application/json" \
   -d \
'{
  "name":"igouc"
}' \
 'http://localhost:9200/test/student/1'
```

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 1,
    "created": true
}
```

> 1 ä»£è¡¨idä¸º 1

ç´¢å¼•è¿™ä¸ªæ–‡æ¡£

GET `localhost:9200/test/student/1?pretty`

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 1,
    "found": true,
    "_source":{
        "name": "igouc"
    }
}
```

é™¤äº†foundå­—æ®µ-ï¼ˆæŒ‡æ˜æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªIDä¸º1çš„æ–‡æ¡£ï¼‰å’Œ_sourceå­—æ®µï¼ˆè¿”å›æˆ‘ä»¬å‰ä¸€æ­¥ä¸­ç´¢å¼•çš„å®Œæ•´JSONæ–‡æ¡£ï¼‰ä¹‹å¤–ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ã€‚

### 3.6 åˆ é™¤ä¸€ä¸ªæ–‡æ¡£

* åˆ é™¤ç´¢å¼• `curl -XDELETE 'localhost:9200/test?pretty'`

```json
{
  "acknowledged" : true
}
```

* åˆ é™¤ç±»å‹ `curl -XDELETE 'localhost:9200/test/student?pretty'`

```json
{
  "acknowledged" : true
}
```

* åˆ é™¤æ–‡æ¡£ `curl -XDELETE 'localhost:9200/test/student/1?pretty'`

```json
{
  "name": "igouc"
}
```

### 3.7 è®¿é—®æ ¼å¼

ä»”ç»†ç ”ç©¶ä»¥ä¸Šçš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è®¿é—®Elasticsearchä¸­æ•°æ®çš„ä¸€ä¸ªæ¨¡å¼ã€‚è¿™ä¸ªæ¨¡å¼å¯ä»¥è¢«æ€»ç»“ä¸ºï¼š

```
<REST Verb> <Node>:<Port>/<Index>/<Type>/<ID>
```

---

## 4 ä¿®æ”¹æ•°æ®

Elasticsearchæä¾›äº†è¿‘ä¹å®æ—¶çš„æ•°æ®æ“ä½œå’Œæœç´¢åŠŸèƒ½ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»ä½ ç´¢å¼•/æ›´æ–°/åˆ é™¤ä½ çš„æ•°æ®åŠ¨ä½œå¼€å§‹åˆ°å®ƒå‡ºç°åœ¨ä½ çš„æœç´¢ç»“æœä¸­ï¼Œå¤§æ¦‚ä¼šæœ‰1ç§’é’Ÿçš„å»¶è¿Ÿã€‚è¿™å’Œå…¶å®ƒçš„SQLå¹³å°ä¸åŒï¼Œå®ƒä»¬çš„æ•°æ®åœ¨ä¸€ä¸ªäº‹åŠ¡å®Œæˆä¹‹åå°±ä¼šç«‹å³å¯ç”¨ã€‚

### 4.1 ç´¢å¼•ï¼æ›¿æ¢æ–‡æ¡£

```
curl -i -X PUT \
   -H "Content-Type:application/json" \
   -d \
'{
  "name":"igouc4"
}' \
 'http://localhost:9200/test/student/1?pretty'
```

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 2,
    "created": false
}
```

> æ³¨æ„created == false

GET `localhost:9200/test/student/1`

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 2,
    "found": true,
    "_source":{
        "name": "igouc4"
    }
}
```

å¦‚æœä¸æŒ‡å®šæœ€åçš„idï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ†é…idï¼Œæ³¨æ„è¦ç”¨POSTâš ï¸

```
curl -i -X POST \
   -H "Content-Type:application/json" \
   -d \
'{
  "name":"igouc5"
}' \
 'http://localhost:9200/test/student/?pretty'
```

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "AVq-d-gpHptku1SmEgQL",
    "_version": 1,
    "created": true
}
```

> æ­¤æ—¶çš„idæ˜¯éšæœºçš„

### 4.2 æ›´æ–°æ–‡æ¡£

```
curl -i -X POST \
   -H "Content-Type:application/json" \
   -d \
'{
  "doc":{"name":"igouc6"}
}' \
 'http://localhost:9200/test/student/1/_update?pretty'
```

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 4
}
```

GET `localhost:9200/test/student/1?pretty`

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 4,
    "found": true,
    "_source":{
       "name": "igouc6"
    }
}
```

> æ›´æ–°æ–‡æ¡£ï¼ŒElasticsearchå…ˆåˆ é™¤æ—§æ–‡æ¡£ï¼Œç„¶åå†ç´¢å¼•æ›´æ–°çš„æ–°æ–‡æ¡£ã€‚ä¸”ç”¨POST

æ›´æ–°ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ç®€å•çš„è„šæœ¬æ¥è¿›è¡Œ

```
curl -i -X POST \
   -H "Content-Type:application/json" \
   -d \
'{
  "script":"ctx._source.name += 2"
}' \
 'http://localhost:9200/test/student/1/_update?pretty'
```

```
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 5
}
```

GET `localhost:9200/test/student/1?pretty`

```json
{
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 5,
    "found": true,
    "_source":{
        "name": "igouc62"
    }
}
```

### 4.3 åˆ é™¤æ•°æ®

åˆ é™¤æ–‡æ¡£æ˜¯éå¸¸ç›´è§‚çš„

DELETE `localhost:9200/test/student/1?pretty`

```json
{
    "found": true,
    "_index": "test",
    "_type": "student",
    "_id": "1",
    "_version": 6
}
```

æŒ‡å®šåˆ é™¤æ¡ä»¶

```
curl -i -X DELETE \
   -H "Content-Type:application/json" \
   -d \
'{
  "query": { "match": { "name": "igouc2" } }
}' \
 'http://localhost:9200/test/student/_query?pretty'
```

```
{
    "_indices":{
        "test":{
            "_shards":{
                "total": 5,
                "successful": 5,
                "failed": 0
            }
        }
    }
}
```

### 4.4 æ‰¹å¤„ç†

ä¸‹é¢ä¸¤ä¸ªä»…ä»…æ˜¯æŒ‡ä»¤ï¼Œæ²¡æœ‰å“åº”

```
curl -XPOST 'localhost:9200/customer/external/_bulk?pretty' -d '
{"index":{"_id":"1"}}
{"name": "John Doe" }
{"index":{"_id":"2"}}
{"name": "Jane Doe" }
'
```

```
curl -XPOST 'localhost:9200/customer/external/_bulk?pretty' -d '
{"update":{"_id":"1"}}
{"doc": { "name": "John Doe becomes Jane Doe" } }
{"delete":{"_id":"2"}}
'
```

>bulk APIæŒ‰é¡ºåºæ‰§è¡Œè¿™äº›åŠ¨ä½œã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªåŠ¨ä½œå› ä¸ºæŸäº›åŸå› å¤±è´¥äº†ï¼Œå®ƒå°†ä¼šç»§ç»­å¤„ç†åé¢çš„åŠ¨ä½œã€‚å½“bulk APIè¿”å›æ—¶ï¼Œå®ƒå°†æä¾›æ¯ä¸ªåŠ¨ä½œçš„çŠ¶æ€ï¼ˆæŒ‰ç…§åŒæ ·çš„é¡ºåºï¼‰ï¼Œæ‰€ä»¥ä½ èƒ½å¤Ÿçœ‹åˆ°æŸä¸ªåŠ¨ä½œæˆåŠŸä¸å¦ã€‚âš ï¸


## 5 æ“ä½œæ•°æ®

æˆ‘ä»¬æœ‰ä¸¤ç§åŸºæœ¬çš„æœç´¢æ–¹å¼ï¼š

* RESTè¯·æ±‚ URIä¸­å‘é€è¯·æ±‚å‚æ•°
* RESTè¯·æ±‚ å°†è¯·æ±‚å‚æ•°æ”¾åœ¨è¯·æ±‚ä½“ä¸­

ä¸‹é¢ æˆ‘ä»¬ä»…ä»…ä½¿ç”¨ä¸€æ¬¡ å°†è¯·æ±‚å‚æ•°æ”¾å…¥URIä¸­ï¼Œå…¶ä½™éƒ½å°†å‚æ•°æ”¾å…¥è¯·æ±‚ä½“ï¼Œä»¥ä¾¿ç¾è§‚

GET `localhost:9200/bank/_search?q=*$pretty`

```
{
  "took" : 9,
  "timed_out" : false,
  "_shards" : {
    "total" : 5,
    "successful" : 5,
    "failed" : 0
  },
  "hits" : {
    "total" : 1000,
    "max_score" : 1.0,
    "hits" : [ {
      "_index" : "bank",
      "_type" : "account",
      "_id" : "4",
      "_score" : 1.0,
      "_source":{"account_number":4,"balance":27658,"firstname":"Rodriquez","lastname":"Flores","age":31,"gender":"F","address":"986 Wyckoff Avenue","employer":"Tourmania","email":"rodriquezflores@tourmania.com","city":"Eastvale","state":"HI"}
    }, {
      "_index" : "bank",
      "_type" : "account",
      "_id" : "9",
      "_score" : 1.0,
      "_source":{"account_number":9,"balance":24776,"firstname":"Opal","lastname":"Meadows","age":39,"gender":"M","address":"963 Neptune Avenue","employer":"Cedward","email":"opalmeadows@cedward.com","city":"Olney","state":"OH"}
    }, {
      "_index" : "bank",
      "_type" : "account",
      "_id" : "11",
      "_score" : 1.0,
      "_source":{"account_number":11,"balance":20203,"firstname":"Jenkins","lastname":"Haney","age":20,"gender":"M","address":"740 Ferry Place","employer":"Qimonk","email":"jenkinshaney@qimonk.com","city":"Steinhatchee","state":"GA"}
    }, {
      "_index" : "bank",
      "_type" : "account",
      "_id" : "16",
      "_score" : 1.0,
      "_source":{"account_number":16,"balance":35883,"firstname":"Adrian","lastname":"Pitts","age":34,"gender":"F","address":"963 Fay Court","employer":"Combogene","email":"adrianpitts@combogene.com","city":"Remington","state":"SD"}
    },
  .
  .
  .
  .
}
```


æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªè¯·æ±‚çš„å“åº”ä½“

* took è¿™ä¸ªæŸ¥è¯¢æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼ˆmsï¼‰
* timed_out æ˜¯å¦è¶…æ—¶
* _shards æŒ‡å‡ºäº†å¤šå°‘åˆ†ç‰‡è¢«æœç´¢äº†ï¼ŒåŒæ—¶ä¹ŸæŒ‡å‡ºäº†æˆåŠŸï¼å¤±è´¥çš„åˆ†ç‰‡æ•°é‡
* hits æœç´¢ç»“æœ
* hits.total åŒ¹é…æŸ¥è¯¢æ¡ä»¶çš„æ–‡æ¡£çš„æ€»æ•°ç›®
* hits.hits çœŸæ­£çš„æœç´¢ç»“æœæ•°ç»„ï¼ˆé»˜è®¤æ˜¯å‰10ä¸ªæ–‡æ¡£ï¼‰
* _score åŒ¹é…åº¦ï¼Œå¾—åˆ†è¶Šé«˜ï¼Œç›¸å…³æ€§è¶Šå¤§
* 


å¦‚æœæˆ‘ä»¬æ˜¯ä½¿ç”¨è¯·æ±‚ä½“çš„è¯ï¼Œåº”è¯¥è¿™æ ·ï¼š

```
POST localhost:9200/bank/_search?pretty

body:
{
  "query":{"match_all":{}}
}
```

æˆ‘ä»¬æ¥åˆ†æä¸‹è¿™ä¸ªè¯·æ±‚ä½“

* query é«˜é€Ÿæˆ‘ä»¬å®šä¹‰è¯·æ±‚ä½“
* match_all é«˜é€Ÿæˆ‘ä»¬æƒ³è¦è¿è¡Œçš„æŸ¥è¯¢ç±»å‹

å½“ç„¶é™¤äº†ä¸Šé¢çš„å‚æ•°ï¼Œè¿˜å¯ä»¥æŒ‡å®šè¿”å›çš„æ¡æ•°ï¼ˆé»˜è®¤10æ¡ï¼‰

```
POST localhost:9200/bank/_search?pretty

body:
{
  "query":{"match_all":{}},
  "from":10,
  "size":1
}

```

ä¸Šé¢çš„è¿™æ¡è¡¨ç¤ºä»ç¬¬10æ¡æŸ¥è¯¢1æ¡

```
POST localhost:9200/bank/_search?pretty

body:
{
  "query":{"match_all":{}},
  "sort":{"account_number":{"order":"desc"}}
}
```

ç°åœ¨æˆ‘ä»¬å·²ç»æ¥è§¦äº†ä¸€äº›ç®€å•çš„æœç´¢è¯­å¥ï¼Œä¸‹é¢æˆ‘ä»¬æ‰§è¡Œä¸€äº›ç‰¹æ®Šçš„æœç´¢

é»˜è®¤æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯è¿”å›æ‰€æœ‰çš„å­—æ®µï¼Œæˆ‘ä»¬ä¸‹é¢å¯ä»¥ ç”¨`_source`æŒ‡å®šè¿”å›çš„å­—æ®µ

```
POST localhost:9200/bank/_search?pretty

body
{
  "query":{"match_all":{}},
  "_source":["account_number", "balance", "firstname"]
}
```

ç°åœ¨è®©æˆ‘ä»¬è¿›å…¥åˆ°æŸ¥è¯¢éƒ¨åˆ†ã€‚ä¹‹å‰ï¼Œæˆ‘ä»¬å­¦ä¹ äº†match_allæŸ¥è¯¢æ˜¯æ€æ ·åŒ¹é…åˆ°æ‰€æœ‰çš„æ–‡æ¡£çš„ã€‚ç°åœ¨æˆ‘ä»¬ä»‹ç»ä¸€ç§æ–°çš„æŸ¥è¯¢ï¼Œå«åšmatchæŸ¥è¯¢ï¼Œè¿™å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç®€å•çš„å­—æ®µæœç´¢æŸ¥è¯¢ï¼ˆæ¯”å¦‚å¯¹æŸä¸ªæˆ–æŸäº›ç‰¹å®šå­—æ®µçš„æœç´¢ï¼‰

ä¸‹é¢è¿™ä¸ªä¾‹å­è¿”å›è´¦æˆ·ç¼–å·ä¸º 20 çš„æ–‡æ¡£ï¼š

```
POST localhost:9200/bank/_search?pretty

body:
{
  "query":{"match":{"account_number":999}}
}
```

ä¸‹é¢è¿™ä¸ªä¾‹å­è¿”å›åœ°å€ä¸­åŒ…å«è¯è¯­(term)â€œmillâ€çš„æ‰€æœ‰è´¦æˆ·ï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": { "match": { "address": "mill" } }
}'
```

ä¸‹é¢è¿™ä¸ªä¾‹å­è¿”å›åœ°å€ä¸­åŒ…å«è¯è¯­â€œmillâ€ æˆ–è€…â€œlaneâ€ çš„è´¦æˆ·ï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": { "match": { "address": "mill lane" } }
}'
```

ä¸‹é¢è¿™ä¸ªä¾‹å­æ˜¯matchçš„å˜ä½“ï¼ˆmatch_phraseï¼‰ï¼Œå®ƒä¼šå»åŒ¹é…çŸ­è¯­â€œmill laneâ€ï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": { "match_phrase": { "address": "mill lane" } }
}'
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹å¸ƒå°”æŸ¥è¯¢ã€‚å¸ƒå°”æŸ¥è¯¢å…è®¸æˆ‘ä»¬åˆ©ç”¨å¸ƒå°”é€»è¾‘å°†è¾ƒå°çš„æŸ¥è¯¢ç»„åˆæˆè¾ƒå¤§çš„æŸ¥è¯¢ã€‚

ç°åœ¨è¿™ä¸ªä¾‹å­ç»„åˆäº†ä¸¤ä¸ªmatchæŸ¥è¯¢ï¼Œè¿™ä¸ªç»„åˆæŸ¥è¯¢è¿”å›åŒ…å«â€œmillâ€ å’Œâ€œlaneâ€ çš„æ‰€æœ‰çš„è´¦æˆ·

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": {
    "bool": {
      "must": [
        { "match": { "address": "mill" } },
        { "match": { "address": "lane" } }
      ]
    }
  }
}'
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œbool mustè¯­å¥æŒ‡æ˜äº†ï¼Œå¯¹äºä¸€ä¸ªæ–‡æ¡£ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢éƒ½å¿…é¡»ä¸ºçœŸï¼Œè¿™ä¸ªæ–‡æ¡£æ‰èƒ½å¤ŸåŒ¹é…æˆåŠŸã€‚

ç›¸åçš„ï¼Œ ä¸‹é¢çš„ä¾‹å­ç»„åˆäº†ä¸¤ä¸ªmatchæŸ¥è¯¢ï¼Œå®ƒè¿”å›çš„æ˜¯åœ°å€ä¸­åŒ…å«â€œmillâ€ æˆ–è€…â€œlaneâ€çš„æ‰€æœ‰çš„è´¦æˆ·:

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": {
    "bool": {
      "should": [
        { "match": { "address": "mill" } },
        { "match": { "address": "lane" } }
      ]
    }
  }
}'
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­bool shouldè¯­å¥æŒ‡æ˜ï¼Œå¯¹äºä¸€ä¸ªæ–‡æ¡£ï¼ŒæŸ¥è¯¢åˆ—è¡¨ä¸­ï¼Œåªè¦æœ‰ä¸€ä¸ªæŸ¥è¯¢åŒ¹é…ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡æ¡£å°±è¢«çœ‹æˆæ˜¯åŒ¹é…çš„ã€‚

ç°åœ¨è¿™ä¸ªä¾‹å­ç»„åˆäº†ä¸¤ä¸ªæŸ¥è¯¢ï¼Œå®ƒè¿”å›åœ°å€ä¸­æ—¢ä¸åŒ…å«â€œmillâ€ï¼ŒåŒæ—¶ä¹Ÿä¸åŒ…å«â€œlaneâ€çš„æ‰€æœ‰çš„è´¦æˆ·ä¿¡æ¯ï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": {
    "bool": {
      "must_not": [
        { "match": { "address": "mill" } },
        { "match": { "address": "lane" } }
      ]
    }
  }
}'
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œbool must_notè¯­å¥æŒ‡æ˜ï¼Œå¯¹äºä¸€ä¸ªæ–‡æ¡£ï¼ŒæŸ¥è¯¢åˆ—è¡¨ä¸­çš„çš„æ‰€æœ‰æŸ¥è¯¢éƒ½å¿…é¡»éƒ½ä¸ä¸ºçœŸï¼Œè¿™ä¸ªæ–‡æ¡£æ‰è¢«è®¤ä¸ºæ˜¯åŒ¹é…çš„ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªboolæŸ¥è¯¢é‡Œä¸€èµ·ä½¿ç”¨mustã€shouldã€must_notã€‚ æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å°†boolæŸ¥è¯¢æ”¾åˆ°è¿™æ ·çš„boolè¯­å¥ä¸­æ¥æ¨¡æ‹Ÿå¤æ‚çš„ã€å¤šå±‚çº§çš„å¸ƒå°”é€»è¾‘ã€‚

ä¸‹é¢è¿™ä¸ªä¾‹å­è¿”å›40å²ä»¥ä¸Šå¹¶ä¸”ä¸ç”Ÿæ´»åœ¨IDï¼ˆahoï¼‰çš„äººçš„è´¦æˆ·ï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": {
    "bool": {
      "must": [
        { "match": { "age": "40" } }
      ],
      "must_not": [
        { "match": { "state": "ID" } }
      ]
    }
  }
}'

```

Elasticsearchä¸­çš„æ‰€æœ‰çš„æŸ¥è¯¢éƒ½ä¼šè§¦å‘ç›¸å…³åº¦å¾—åˆ†çš„è®¡ç®—ã€‚å¯¹äºé‚£äº›æˆ‘ä»¬ä¸éœ€è¦ç›¸å…³åº¦å¾—åˆ†çš„åœºæ™¯ä¸‹ï¼ŒElasticsearchä»¥è¿‡æ»¤å™¨çš„å½¢å¼æä¾›äº†å¦ä¸€ç§æŸ¥è¯¢åŠŸèƒ½ã€‚è¿‡æ»¤å™¨åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äºæŸ¥è¯¢ï¼Œä½†æ˜¯å®ƒä»¬æœ‰éå¸¸å¿«çš„æ‰§è¡Œé€Ÿåº¦ï¼Œè¿™ç§å¿«çš„æ‰§è¡Œé€Ÿåº¦ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› ï¼š

* è¿‡æ»¤å™¨ä¸ä¼šè®¡ç®—ç›¸å…³åº¦çš„å¾—åˆ†ï¼Œæ‰€ä»¥å®ƒä»¬åœ¨è®¡ç®—ä¸Šæ›´å¿«ä¸€äº›
* è¿‡æ»¤å™¨å¯ä»¥è¢«ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œè¿™ä½¿å¾—åœ¨é‡å¤çš„æœç´¢æŸ¥è¯¢ä¸Šï¼Œå…¶è¦æ¯”ç›¸åº”çš„æŸ¥è¯¢å¿«å‡ºè®¸å¤šã€‚

ä¸ºäº†ç†è§£è¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç»â€œè¢«è¿‡æ»¤â€ çš„æŸ¥è¯¢ï¼Œè¿™ä½¿å¾—ä½ å¯ä»¥å°†ä¸€ä¸ªæŸ¥è¯¢ï¼ˆå¦‚match_all,matchï¼Œboolç­‰ï¼‰å’Œä¸€ä¸ªè¿‡æ»¤å™¨ç»“åˆèµ·æ¥ã€‚ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹èŒƒå›´è¿‡æ»¤å™¨ï¼Œå®ƒå…è®¸æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªåŒºé—´çš„å€¼æ¥è¿‡æ»¤æ–‡æ¡£ã€‚è¿™é€šå¸¸è¢«ç”¨åœ¨æ•°å­—å’Œæ—¥æœŸçš„è¿‡æ»¤ä¸Šã€‚

è¿™ä¸ªä¾‹å­ä½¿ç”¨ä¸€ä¸ªè¢«è¿‡æ»¤çš„æŸ¥è¯¢ï¼Œå…¶è¿”å›å€¼æ˜¯å­˜æ¬¾åœ¨20000åˆ°30000ä¹‹é—´ï¼ˆé—­åŒºé—´)çš„æ‰€æœ‰è´¦æˆ·ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æƒ³è¦æ‰¾åˆ°å­˜æ¬¾å¤§äºç­‰äº20000å¹¶ä¸”å°äºç­‰äº30000çš„è´¦æˆ·ã€‚

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "query": {
    "filtered": {
      "query": { "match_all": {} },
      "filter": {
        "range": {
          "balance": {
            "gte": 20000,
            "lte": 30000
          }
        }
      }
    }
  }
}'
```

åˆ†æä¸Šé¢çš„ä¾‹å­ï¼Œè¢«è¿‡æ»¤çš„æŸ¥è¯¢åŒ…å«ä¸€ä¸ªmatch_allæŸ¥è¯¢ï¼ˆæŸ¥è¯¢éƒ¨åˆ†ï¼‰å’Œä¸€ä¸ªè¿‡æ»¤å™¨ï¼ˆfilteréƒ¨åˆ†ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æŸ¥è¯¢éƒ¨åˆ†ä¸­æ”¾å…¥å…¶ä»–æŸ¥è¯¢ï¼Œåœ¨filteréƒ¨åˆ†æ”¾å…¥å…¶å®ƒè¿‡æ»¤å™¨ã€‚ åœ¨ä¸Šé¢çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œç”±äºæ‰€æœ‰çš„åœ¨è¿™ä¸ªèŒƒå›´ä¹‹å†…çš„æ–‡æ¡£éƒ½æ˜¯å¹³ç­‰çš„ï¼ˆæˆ–è€…è¯´ç›¸å…³åº¦éƒ½æ˜¯ä¸€æ ·çš„ï¼‰ï¼Œ æ²¡æœ‰ä¸€ä¸ªæ–‡æ¡£æ¯”å¦ä¸€ä¸ªæ–‡æ¡£æ›´ç›¸å…³ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä½¿ç”¨èŒƒå›´è¿‡æ»¤å™¨å°±éå¸¸åˆé€‚äº†

é€šå¸¸æƒ…å†µä¸‹ï¼Œè¦å†³å®šæ˜¯ä½¿ç”¨è¿‡æ»¤å™¨è¿˜æ˜¯ä½¿ç”¨æŸ¥è¯¢ï¼Œä½ å°±éœ€è¦é—®è‡ªå·±æ˜¯å¦éœ€è¦ç›¸å…³åº¦å¾—åˆ†ã€‚å¦‚æœç›¸å…³åº¦æ˜¯ä¸é‡è¦çš„ï¼Œä½¿ç”¨è¿‡æ»¤å™¨ï¼Œå¦åˆ™ä½¿ç”¨æŸ¥è¯¢ã€‚å¦‚æœä½ æœ‰SQLèƒŒæ™¯ï¼ŒæŸ¥è¯¢å’Œè¿‡æ»¤å™¨ åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äºSELECT WHEREè¯­å¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿‡æ»¤å™¨æ¯”æŸ¥è¯¢ç”¨å¾—æ›´å¤šã€‚

é™¤äº†match_all, match, bool,filteredå’ŒrangeæŸ¥è¯¢ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶å®ƒç±»å‹çš„æŸ¥è¯¢/è¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬è¿™é‡Œä¸ä¼šæ¶‰åŠã€‚ç”±äºæˆ‘ä»¬å·²ç»å¯¹å®ƒä»¬çš„å·¥ä½œåŸç†æœ‰äº†åŸºæœ¬çš„ç†è§£ï¼Œå°†å…¶åº”ç”¨åˆ°å…¶å®ƒç±»å‹çš„æŸ¥è¯¢ã€è¿‡æ»¤å™¨ä¸Šä¹Ÿä¸æ˜¯ä»¶éš¾äº‹ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨esä¸Šåšèšåˆæ“ä½œï¼š

èšåˆæä¾›äº†åˆ†ç»„å¹¶ç»Ÿè®¡æ•°æ®çš„èƒ½åŠ›ã€‚ç†è§£èšåˆçš„æœ€ç®€å•çš„æ–¹å¼æ˜¯å°†å…¶ç²—ç•¥åœ°ç­‰åŒä¸ºSQLçš„GROUP BYå’ŒSQLèšåˆå‡½æ•°ã€‚åœ¨Elasticsearchä¸­ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªå“åº”ä¸­åŒæ—¶è¿”å›å‘½ä¸­çš„æ•°æ®å’Œèšåˆç»“æœã€‚ä½ å¯ä»¥ä½¿ç”¨ç®€å•çš„APIåŒæ—¶è¿è¡ŒæŸ¥è¯¢å’Œå¤šä¸ªèšåˆå¹¶ä¸€æ¬¡è¿”å›ï¼Œè¿™é¿å…äº†æ¥å›çš„ç½‘ç»œé€šä¿¡ï¼Œæ˜¯éå¸¸å¼ºå¤§å’Œé«˜æ•ˆçš„ã€‚

ä½œä¸ºå¼€å§‹çš„ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æŒ‰ç…§stateåˆ†ç»„ï¼Œå¹¶æŒ‰ç…§å·åçš„è®¡æ•°å€’åºæ’åºï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state"
      }
    }
  }
}'
```

æ³¨æ„æˆ‘ä»¬å°†sizeè®¾ç½®æˆ 0ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åªçœ‹åˆ°èšåˆç»“æœäº†ï¼Œè€Œä¸ä¼šæ˜¾ç¤ºå‘½ä¸­çš„ç»“æœã€‚

åœ¨å…ˆå‰èšåˆçš„åŸºç¡€ä¸Šï¼Œç°åœ¨è¿™ä¸ªä¾‹å­è®¡ç®—äº†æ¯ä¸ªå·çš„è´¦æˆ·çš„å¹³å‡å­˜æ¬¾ï¼ˆè¿˜æ˜¯æŒ‰ç…§è´¦æˆ·æ•°é‡å€’åºæ’åºçš„å‰10ä¸ªå·ï¼‰ï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state"
      },
      "aggs": {
        "average_balance": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}'
```

æ³¨æ„ï¼Œ æˆ‘ä»¬æŠŠaverage_balanceèšåˆåµŒå¥—åœ¨äº†group_by_stateèšåˆä¹‹ä¸­ã€‚è¿™æ˜¯æ‰€æœ‰èšåˆçš„ä¸€ä¸ªå¸¸ç”¨æ¨¡å¼ã€‚ä½ å¯ä»¥åœ¨ä»»æ„çš„èšåˆä¹‹ä¸­åµŒå¥—èšåˆï¼Œè¿™æ ·å°±å¯ä»¥ä»ä½ çš„æ•°æ®ä¸­æŠ½å–å‡ºæƒ³è¦çš„ç»“æœã€‚

åœ¨å‰é¢çš„èšåˆçš„åŸºç¡€ä¸Šï¼Œç°åœ¨è®©æˆ‘ä»¬æŒ‰ç…§å¹³å‡ä½™é¢è¿›è¡Œæ’åºï¼š

```
curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state",
        "order": {
          "average_balance": "desc"
        }
      },
      "aggs": {
        "average_balance": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}'
```


##s 6 æœç´¢API

æœç´¢APIå…è®¸å¼€å‘è€…æ‰§è¡Œæœç´¢æŸ¥è¯¢ï¼Œè¿”å›åŒ¹é…çš„æœç´¢ç»“æœã€‚è¿™æ ·æ—¢å¯ä»¥é€šè¿‡æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥è¯¢å®ä½“å®ç°ã€‚

### 6.1 å¤šç´¢å¼•ç±»å‹

æ‰€æœ‰çš„æœç´¢APIéƒ½å¯ä»¥è·¨å¤šä¸ªç±»å‹ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¤šç´¢å¼•è¯­æ³•è·¨ç´¢å¼•ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢twitterç´¢å¼•çš„è·¨ç±»å‹çš„æ‰€æœ‰çš„æ–‡æ¡£ã€‚

`GET http://localhost:9200/twittper/_search?q=user:ki`

æˆ‘ä»¬ä¹Ÿå¯ä»¥å¸¦ä¸Šç‰¹å®šæœç´¢çš„typeï¼š

`GET htto://localhost:9200/twittper/type1,type2/_search?q=user:ki`

æˆ‘ä»¬ä¹Ÿå¯ä»¥å¤¸indexæœç´¢

`GET http://localhost:9200/type1,type2/twitter/_search?q=user:ki`

æˆ‘ä»¬å¯ä»¥ç”¨`_all`æ¥å……å½“æ‰€æœ‰çš„å ä½ç¬¦

`GET http://localhost:9200/_all/twitter/_search?q=user:ki`

æˆ–è€…çœç•¥`_all`

`GET http://localhost:9200/twitter/_search?q=user:ki`

### 6.2 URLæœç´¢

ä¸€ä¸ªæœç´¢å¯ä»¥ç”¨uriæ¥æ‰§è¡Œï¼Œç”¨è¿™ç§æ–¹æ³•è¿›è¡Œæœç´¢ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„é€‰é¡¹éƒ½æ˜¯æš´éœ²å‡ºæ¥çš„ï¼Œä¸‹é¢æˆ‘ä»¬è®°å½•è¿™äº›å‚æ•°

|Name|Description|
|:---|:----------|
|q|è¡¨ç¤ºæŸ¥è¯¢|
|df|åœ¨æŸ¥è¯¢ä¸­ï¼Œå½“æ²¡æœ‰å®šä¹‰å­—æ®µçš„å‰ç¼€çš„æƒ…å†µä¸‹çš„é»˜è®¤å­—æ®µå‰ç¼€|
|analyzer|å½“åˆ†ææŸ¥è¯¢å­—ç¬¦ä¸²æ—¶ï¼Œåˆ†æå™¨çš„åå­—|
|explain|å¯¹äºå‘½ä¸­ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªå‘½ä¸­è§£é‡Š|
|_source|å°†å…¶è®¾ç½®ä¸ºfalseï¼ŒæŸ¥è¯¢å°±ä¼šæ”¾å¼ƒæ£€ç´¢_sourceå­—æ®µã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®_source_includeå’Œ_source_excludeæ£€ç´¢éƒ¨åˆ†æ–‡æ¡£|
|fields|  å‘½ä¸­çš„æ–‡æ¡£è¿”å›çš„å­—æ®µ|
|sort|æ’åºæ‰§è¡Œã€‚å¯ä»¥ä»¥fieldNameã€fieldName:ascæˆ–è€…fieldName:descçš„æ ¼å¼è®¾ç½®ã€‚fieldNameæ—¢å¯ä»¥æ˜¯å­˜åœ¨çš„å­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯_scoreå­—æ®µã€‚å¯ä»¥æœ‰å¤šä¸ªsortå‚æ•°|
|track_scores|å½“æ’åºçš„æ—¶å€™ï¼Œå°†å…¶è®¾ç½®ä¸ºtrueï¼Œå¯ä»¥è¿”å›ç›¸å…³åº¦å¾—åˆ†|
|timeout|é»˜è®¤æ²¡æœ‰timeout|
|from|é»˜è®¤0|
|size|é»˜è®¤10|
|search_type|æœç´¢æ“ä½œæ‰§è¡Œçš„ç±»å‹ï¼Œæœ‰dfs_query_then_fetch, dfs_query_and_fetch, query_then_fetch, query_and_fetch, count, scanå‡ ç§ï¼Œé»˜è®¤æ˜¯query_then_fetch|
|lowercase_expanded_terms|termsæ˜¯å¦è‡ªåŠ¨å°å†™ï¼Œé»˜è®¤æ˜¯true|
|analyze_wildcard|  æ˜¯å¦åˆ†é…é€šé…ç¬¦å’Œå‰ç¼€æŸ¥è¯¢ï¼Œé»˜è®¤æ˜¯false|

### 6.3 è¯·æ±‚ä½“æœç´¢

æœ‰æœç´¢DSLçš„æœç´¢è¯·æ±‚å¯ä»¥è¢«æ‰§è¡Œ

#### 6.3.1 æŸ¥è¯¢

ç²¾å‡†åŒ¹é…

```json
{
  "query":{
    "term":{
      "shop_name":"æµ‹è¯•"
    }
  }
}
```

æ¨¡ç³ŠåŒ¹é…(è¡¨è¾¾å¼åŒ¹é…)

```json
{
  "query":{
    "match":{
      "shop_name":"æµ‹è¯•"
    }
  }
}
```

#### 6.3.2 fromï¼size

```json
{
  "query":{
    "term":{
      "shop_name":"test"
    }
  },
  "from":0,
  "size":100
}
```

#### 6.3.3 æ’åº

```json
{
  "query":{
    "term":{
      "shop_name":"test"
    }
  },
  "sort":[{"age":"asc"},{"_score":"desc"}]
}
```

#### 6.3.4 æ’åºå€¼

esæ”¯æŒé€šè¿‡æ•°ç»„æ•°ç»„æˆ–è€…å¤šå€¼å­—æ®µæ’åº
modeé€‰é¡¹æ§åˆ¶ ç”¨å¤šå€¼å­—æ®µçš„ä»€ä¹ˆå€¼æ¥æ’åº

* min æœ€å°å€¼
* max æœ€å¤§å€¼
* sum å’Œ ï¼ˆä»…ç”¨æ•°å€¼ï¼‰
* avg å¹³å‡å€¼ï¼ˆä»…ç”¨æ•°å€¼ï¼‰

```json
{
  "query":{
    "term":{
      "shop_name":"test"
    }
  },
  "sort":[
    {"price":{"order":"desc", "mode":"avg"}}
  ]
}
```


#### 6.3.5 ç¼ºå¤±å­—æ®µçš„å¤„ç†æ–¹å¼

`missing` å‚æ•°æŒ‡ç¼ºå¤±å­—æ®µçš„å¤„ç†æ–¹å¼:"missing":"_last"/"missing":"true"

```json
{
    "sort" : [
        { "price" : {"missing" : "_last"} },
    ],
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```

#### 6.3.6 åœ°ç†ä½ç½®æ’åº

é€šè¿‡_geo_distanceæ’åºã€‚

```json
{
    "sort" : [
        {
            "_geo_distance" : {
                "pin.location" : [-70, 40],
                "order" : "asc",
                "unit" : "km",
                "mode" : "min",
                "distance_type" : "sloppy_arc"
            }
        }
    ],
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```

* distance_typeï¼šæ€æ ·è®¡ç®—è·ç¦»å¯ä»¥æœ‰sloppy_arc(é»˜è®¤),arcï¼ˆæ›´ç²¾ç¡®ä½†æ˜¯æ˜¾è‘—å˜æ…¢ï¼‰,plane(æœ€å¿«)

åœ°ç†è·ç¦»æ’åºæ”¯æŒçš„æ’åºmodeæœ‰maxï¼Œminå’Œavgã€‚

### 6.4 sourceè¿‡æ»¤

ç”¨äºæ§åˆ¶_sourceå­—æ®µçš„è¿”å›ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ“ä½œè¿”å›_sourceå­—æ®µçš„å†…å®¹ï¼Œé™¤éä½ ç”¨åˆ°äº†fieldså‚æ•°ï¼Œæˆ–è€…_sourceè¢«ç¦ç”¨äº†ã€‚ä½ èƒ½å¤Ÿé€šè¿‡_sourceå‚æ•°å…³æ‰_sourceæ£€ç´¢ã€‚

```json
{
    "_source": false,
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```

_sourceä¹Ÿæ¥å—ä¸€ä¸ªæˆ–è€…å¤šä¸ªé€šé…ç¬¦æ¨¡å¼æ§åˆ¶è¿”å›å€¼ã€‚

```json
{
  "_source":"obj.*",
  "query" : {
    "term" : { "user" : "kimchy" }
  }
}
```

or

```json
{
    "_source": [ "obj1.*", "obj2.*" ],
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```


_sourceé‡Œé¢ä¹Ÿå¯ä»¥æœ‰include/exclude

```json
{
  "query":{
    "term":{"shop_name":"test"}
  },
  "_source":{
    "include":["object.*", "a.*"],
    "exclude":["object1.*"]
  }
}
```

### 6.5 å­—æ®µ

eså…è®¸é€‰æ‹©æ€§åœ°åŠ è½½æ–‡æ¡£ç‰¹å®šçš„å­˜å‚¨å­—æ®µã€‚

```json
{
    "fields" : ["user", "postDate"],
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```

å¦‚æœfieldsæ•°ç»„ä¸ºç©ºï¼Œé‚£ä¹ˆå°±åªä¼šè¿”å›_idå’Œ_typeå­—æ®µã€‚

### 6.6 åˆ†æ•°

```json
{
    "min_score": 0.5,
    "query" : {
        "term" : { "user" : "kimchy" }
    }
}
```

è¿”å›çš„æ–‡æ¡£çš„å¾—åˆ†å°äºmin_scoreã€‚

## 7 java API

ESå¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ç”¨åˆ° java client

* åœ¨é›†ç¾¤ä¸­æ‰§è¡Œæ ‡å‡†çš„index, delete, get, search
* åœ¨é›†ç¾¤ä¸­æ‰§è¡Œç®¡ç†ä»»åŠ¡
* å½“ä½ è¦è¿è¡ŒåµŒå¥—åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­çš„Elasticsearchçš„æ—¶å€™æˆ–è€…å½“ä½ è¦è¿è¡Œå•å…ƒæµ‹è¯•æˆ–è€…é›†åˆæµ‹è¯•çš„æ—¶å€™ï¼Œå¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹

è·å¾—ä¸€ä¸ªClientæ˜¯éå¸¸å®¹æ˜“çš„ï¼Œæœ€é€šç”¨çš„æ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºï¼š

* åˆ›å»ºä¸€ä¸ªåµŒå¥—çš„èŠ‚ç‚¹ï¼Œå……å½“é›†ç¾¤çš„ä¸€ä¸ªèŠ‚ç‚¹
* ä»è¿™ä¸ªåµŒå¥—çš„èŠ‚ç‚¹è¯·æ±‚ä¸€ä¸ªClient

å¦å¤–ä¸€ç§æ–¹å¼æ˜¯åˆ›å»ºä¸€ä¸ªTransportClientæ¥è¿æ¥é›†ç¾¤ã€‚

é‡è¦æç¤ºï¼š å®¢æˆ·ç«¯å’Œé›†ç¾¤ç«¯æ¨èä½¿ç”¨ç›¸åŒçš„ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›ä¸å…¼å®¹çš„é—®é¢˜ã€‚


> åšå®¢è¿ç§»è‡ª [GC-CSDN](http://blog.csdn.net/GC_chao/article/details/61523751)

