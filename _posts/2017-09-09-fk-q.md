---
layout: post
title: "ForkJoin & Quasar"
description: "ç”¨ForkJoin&Quasarè¿›è¡ŒIOå¯†é›†å‹æœåŠ¡ä¼˜åŒ–"
categories: [å­¦ä¹ ]
tags: [java]
---

* Kramdown table of contents
{:toc .toc}

# ç”¨ForkJoin&Quasarå¯¹IOå¯†é›†å‹æœåŠ¡è¿›è¡Œä¼˜åŒ–

## èƒŒæ™¯ä»‹ç»

åšä¸šåŠ¡ç³»ç»Ÿå¼€å‘é¢å¯¹çš„æœåŠ¡å¤§éƒ½æ˜¯IOå¯†é›†å‹æœåŠ¡ï¼Œè¿™é‡ŒæŒ‡çš„IOå¯å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ï¼š

* æ•°æ®åº“ IO
* ç¼“å­˜ IO
* ç½‘ç»œ IO

è¿™é‡Œæš‚æ—¶ä¸è°ˆ ç¼“å­˜IOï¼Œå› ä¸ºç¼“å­˜IOéƒ½å‘ç”Ÿåœ¨å†…å­˜ä¸Šï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œå¯ä»¥å¿½ç•¥è¿™éƒ¨åˆ†IO

ä¹Ÿæœ‰äººå¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆä¼šå­˜åœ¨ç½‘è·¯IOï¼Ÿ

ç°åœ¨ç¨å¾®å¤§ä¸€ç‚¹çš„å…¬å¸éƒ½åœ¨åšå¾®æœåŠ¡ï¼Œæ ¹æ®ä¸šåŠ¡é¢†åŸŸè¿›è¡ŒæœåŠ¡åˆ’åˆ†ï¼Œå°†æœåŠ¡ä¸æœåŠ¡å°½å¯èƒ½çš„è¿›è¡Œè§£è€¦ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œæ–¹ä¾¿ç»´æŠ¤ï¼Œå°†å¼€å‘æ•ˆç‡æœ€å¤§åŒ–ã€‚

ä½†ä¹Ÿå› æ­¤ï¼Œå¾ˆå¤šå•æœåŠ¡ä¸å­˜åœ¨çš„é—®é¢˜ä¹Ÿä¼šéšå³è€Œæ¥ï¼Œæ¯”å¦‚å¢åŠ ç½‘ç»œIOï¼šæ‰€æœ‰ç‰¹å®šä¸šåŠ¡é¢†åŸŸå†…çš„æœåŠ¡å°†å¯æä¾›æœåŠ¡æ³¨å†Œåˆ°æ²»ç†ä¸­å¿ƒï¼Œç”±æ²»ç†ä¸­å¿ƒè¿›è¡ŒæœåŠ¡è°ƒåº¦åˆ†å‘ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´ä¸å†ç®€å•çš„é€šè¿‡å†…å­˜æ¥å£è¿›è¡Œäº¤æµï¼Œè€Œæ˜¯å°†è¯·æ±‚ä¿¡æ¯é€šè¿‡ç½‘ç»œæ‰“åˆ°æ‰€ä¾èµ–çš„æœåŠ¡ä¸Šï¼Œç½‘ç»œå»¶è¿Ÿå¯æ˜¯ä¸å¯é¿å…çš„ã€‚å¦‚æœç½‘ç»œè¾ƒå¥½çš„æƒ…å†µä¸‹å¤§æ¦‚å‡ æ¯«ç§’åˆ°å‡ åæ¯«ç§’ï¼Œå¦‚æœç½‘ç»œä¸å¥½å°±å¯èƒ½å‡ºç°å‡ ç™¾æ¯«ç§’ç”šè‡³ç§’çº§ã€‚


![å¾®æœåŠ¡è°ƒç”¨](http://7xoguv.com1.z0.glb.clouddn.com/fj-q-1.png)

è¿™é‡Œæˆ‘ä»¬ç»™å‡ºä¸ªæ¦‚å¿µå›¾ï¼Œå½“è¯·æ±‚`A`æœåŠ¡æ—¶ï¼Œ`A`æœåŠ¡è¦è°ƒç”¨`B`ã€`C`ã€`D`ä¸‰ä¸ªæœåŠ¡ï¼Œå¹¶ä¸”è¦æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ `E`ï¼Œ å¹¶ä¸”å°†å››ä¸ªç»“æœç»„è£…æˆä¸€ä¸ªå®ä½“è¿”å›å‡ºå»ã€‚ å¦‚æœ`A`å†…éƒ¨ä»£ç æ˜¯é¡ºåºå¤„ç†çš„ï¼Œé‚£ä¹ˆè¿™æ¬¡è¯·æ±‚çš„æ•´ä½“å“åº”æ—¶é—´åˆ™ä¸º `B`çš„å“åº”æ—¶é—´+`C`çš„å“åº”æ—¶é—´+`D`çš„å“åº”æ—¶é—´+`E`çš„å“åº”æ—¶é—´+`A`å†…éƒ¨é€»è¾‘å¤„ç†æ—¶é—´ã€‚ (`B`çš„å“åº”æ—¶é—´åŒ…æ‹¬`A`è¯·æ±‚`B`çš„ç½‘ç»œå»¶è¿Ÿæ—¶é—´)ã€‚ä¹Ÿå°±æ˜¯è¯´`A`çš„å“åº”æ—¶é—´ä¸å•å•ä¸è‡ªå·±çš„ä»£ç é€»è¾‘æœ‰å…³ï¼Œè¿˜è¦ä¸å…¶ä»–æœåŠ¡çš„ä»£ç é€»è¾‘æœ‰å…³ï¼Œè¿˜è¦ä¸ç½‘ç»œå»¶è¿Ÿæœ‰å…³ï¼Œ å¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªç¯èŠ‚å»¶è¿Ÿå¢åŠ éƒ½ä¼šå¢åŠ æ•´ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ã€‚

ä¸€ä¸ªè¯·æ±‚å¤§æ¦‚æ˜¯è¿™æ ·çš„(OtherServiceåŒ…æ‹¬DBè¯»å†™)ï¼š

![é¡ºåºæ—¶åºå›¾1](http://7xoguv.com1.z0.glb.clouddn.com/fj-q-2.png)


## ä¼˜åŒ–

æœåŠ¡å±‚é¢çš„ä¼˜åŒ–çš„æ–¹å‘å¤§è‡´æœ‰ä¸‹é¢è¿™å‡ ç§ï¼Œä¼˜åŒ–çš„åœ°æ–¹éƒ½æ˜¯åœ¨ `MyService` -> `OtherService` è¿™ä¸€æ­¥ä¸Šï¼š

* åˆå¹¶å¤šæ¬¡è¯·æ±‚
* è¯·æ±‚å¼‚æ­¥ä»£ç†
* è¯·æ±‚å¹¶å‘å¤„ç†

### åˆå¹¶å¤šæ¬¡è¯·æ±‚

å°†å¤šæ¬¡è¯·æ±‚åˆå¹¶æˆä¸€æ¬¡ï¼Œå°†å•é‡è°ƒç”¨æ”¹æˆæ‰¹é‡è°ƒç”¨ã€‚ è¿™ç§æ˜¯å˜åŠ¨æœ€å°ï¼Œé£é™©æœ€å°çš„åŠæ³•ï¼Œå´ä¹Ÿæ˜¯æ¯”è¾ƒéš¾æ¨åŠ¨çš„åŠæ³•ã€‚

å¦‚æœæˆ‘ä»¬è°ƒç”¨çš„æœåŠ¡ä»…ä»…æä¾›äº†å•é‡è°ƒç”¨æ¥å£ï¼Œå°±éœ€è¦è¢«è°ƒç”¨æ–¹è¿›è¡Œæ‰¹é‡æ¥å£æä¾›ã€‚éœ€è¦å„æœåŠ¡ä¹‹é—´åä½œæ”¯æŒï¼ˆä¹Ÿè®¸æˆ‘ä»¬æå‡ºçš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹åˆ«çš„éœ€æ±‚ï¼Œä¹Ÿè®¸æä¾›æ¥å£çš„æ€§ä»·æ¯”ä¸é«˜ï¼Œå¾ˆå®¹æ˜“é­å—åˆ°ä¾èµ–æ–¹çš„æ‹’ç»ï½ï¼‰ï¼Œè¿™ç§æ–¹æ³•æ— å…³æŠ€æœ¯ï¼Œå±äºäº¤æµè§£å†³é—®é¢˜ã€‚

### è¯·æ±‚å¼‚æ­¥ä»£ç†

è¿™ç§æ–¹æ³•éœ€è¦åœ¨ `MyService` å’Œ `OtherService` ä¹‹é—´å†ä»‹å…¥ä¸€å±‚ `Agent` ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹:

![è¯·æ±‚å¼‚æ­¥ä»£ç†1](http://7xoguv.com1.z0.glb.clouddn.com/fj-q-4.png)

å½“`A`è¦è°ƒç”¨`OtherService`çš„æ—¶å€™ï¼Œä¼šè®©`Agent`å¼‚æ­¥å»è¯·æ±‚`OtherService`ï¼Œå½“`Agent`å¯¹`OtherService`è¯·æ±‚æœ‰ç»“æœçš„æ—¶å€™å°†ç»“æœå¼‚æ­¥è¿”å›ç»™`A`ï¼Œè¿™æ ·æ•´ä½“çš„å“åº”æ—¶é—´ä¹Ÿå°±å˜æˆ å†…éƒ¨é€»è¾‘æ—¶é—´ + max(`OtherService Response Times`)

ä½†è¿™ç§æ¶æ„çš„ä¿®æ”¹å¸¦æ¥ç³»ç»Ÿç¨³å®šæ€§çš„é™ä½ï¼ŒæœåŠ¡Aå’ŒæœåŠ¡Bã€Cã€Dä¹‹é—´çš„é€šè®¯å¢åŠ äº†å¤æ‚æ€§ã€‚åŒæ—¶ï¼Œå› ä¸ºæ˜¯å¼‚æ­¥æ–¹å¼ï¼ŒæœåŠ¡Açš„ä¸šåŠ¡ä¹Ÿè¦å®ç°å¼‚æ­¥æ–¹å¼ï¼Œå¦åˆ™è¿˜æ˜¯ä¸€ä¸ªé˜»å¡çš„æ¶æ„ã€‚ è€Œä¸”å¯¹`Agent`çš„å®ç°ä¹Ÿæœ‰ç€æ¯”è¾ƒé«˜çš„å¹¶å‘è¦æ±‚ã€‚

### è¯·æ±‚å¹¶å‘å¤„ç†

è¯·æ±‚å¹¶å‘å¤„ç†åº”è¯¥æ˜¯ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ä¸”å®ç”¨çš„å®ç°åŠæ³•ï¼Œ è€Œä¸”æœ‰ç°æˆçš„æ¡†æ¶æ”¯æŒå¹¶å‘å¤„ç†ï¼Œæ¯”å¦‚Executor, ForkJoin, Quasar ...

#### Executor

æä¾›ç°æœ‰çš„çº¿ç¨‹æ± ï¼Œä»£ç ç®€å•

```java
ExecutorService executorPool = Executors.newFixedThreadPool(10);
Future<Object> future = executorService.submit(new Callable<Object>() {
    public Object call() throws Exception {
        OtherService otherService = new OtherService();
        return otherService.dispose();
    }
})
// future.get() æ‹¿åˆ°è¿”å›å€¼ OR å¼‚å¸¸
```

#### ForkJoin

ä¸ Executor ç±»ä¼¼ï¼Œ ForkJoin æä¾›çš„çº¿ç¨‹æ± ï¼ˆæ„Ÿè§‰ä¸åº”è¯¥å«åšçº¿ç¨‹æ± äº†ï¼‰æœ€å¤§ä¸º cpuæ ¸å¿ƒæ•°ï¼Œè™½ç„¶Excutorçº¿ç¨‹æ± å¤§å°å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†å…¶å®çœŸæ­£èƒ½å¹¶å‘è¿è¡Œçš„ä¸è¿‡CPUçš„æ ¸å¿ƒæ•°é‚£ä¹ˆå¤šï¼Œcpuæ ¸å¿ƒæ•° çš„çº¿ç¨‹æ± æ„Ÿè§‰è¶³å¤Ÿäº†ã€‚

ForkJoin è¿˜å¢åŠ äº†work-stealing(å·¥ä½œçªƒå–ç®—æ³•)ï¼Œä¸ºäº†æé«˜å¯¹ä»»åŠ¡çš„å¤„ç†æ•ˆç‡ã€‚

![å·¥ä½œçªƒå–1ï¼Œå›¾ç‰‡æ¥æºç½‘ç»œï¼Œä¾µåˆ ](http://7xoguv.com1.z0.glb.clouddn.com/fj-q-5.png)

ä¸¤ä¸ªçº¿ç¨‹é˜Ÿåˆ—åŒæ—¶å¤„ç†ä»»åŠ¡ï¼Œå¦‚æœçº¿ç¨‹é˜Ÿåˆ—1çš„ä»»åŠ¡å·²ç»å¤„ç†å®Œæ¯•ä¸”æ²¡æœ‰æ–°ä»»åŠ¡è¿›æ¥æ—¶ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹é˜Ÿåˆ—æœ‰ä»»åŠ¡æ²¡å¤„ç†å®Œï¼Œçº¿ç¨‹1å›å»å…¶ä»–é˜Ÿåˆ—é‡Œ"å·å–"ä»»åŠ¡ç”¨æ¥åŠ å¿«å¤„ç†ã€‚

> è¿™é‡Œä¸€å®šæ˜¯ä»é˜Ÿåˆ—å°¾å·ä»»åŠ¡

å…¶å®ä»£ç å†™èµ·æ¥ä¹Ÿæ˜¯è›®ç®€å•çš„ï¼Œ ä¸Executorç±»ä¼¼

```java
ForkJoinPool forkJoinPool = new ForkJoinPool();
Future<Object> future = forkJoinPool.submit(new Callable<Object>() {
    public Object call() throws Exception {
        OtherService otherService = new OtherService();
        return otherService.dispose();
    }
})
```

ç®—æ³•å’Œçº¿ç¨‹æ± çš„é…ç½®éƒ½æ˜¯å°è£…å¥½çš„ï¼Œæ²¡ä»€ä¹ˆå¯ä»¥è¯´çš„ã€‚

#### Quasar

è¿™ä¸ªæ˜¯Javaçš„ä¸€ä¸ªå®ç°åç¨‹çš„æ¡†æ¶ï¼Œå¤§è‡´çš„åŸç†å¦‚ä¸‹ï¼š

* Quasar ä¸­å­˜åœ¨é»˜è®¤çš„workçº¿ç¨‹
* workçº¿ç¨‹è½®è¯¢æ‰§è¡Œåç¨‹ä»»åŠ¡
* å½“è¯¥ä»»åŠ¡é‡åˆ°é˜»å¡çš„æ—¶å€™ï¼ˆæ¯”å¦‚IOä»»åŠ¡ï¼‰ï¼Œåç¨‹è‡ªåŠ¨æŒ‚èµ·
* å½“é˜»å¡å®Œæˆçš„æ—¶å€™ï¼Œæ¢å¤åç¨‹ï¼Œç»§ç»­æ‰§è¡Œ

æ˜¯ä¸æ˜¯å¾ˆåƒâ€œè¯·æ±‚å¼‚æ­¥ä»£ç†â€ï¼Œ workçº¿ç¨‹å°±åƒAgentæœåŠ¡ï¼Œåç¨‹å°±åƒæŠ›ç»™Agentçš„ä»»åŠ¡ï¼Œä¸åŒæ˜¯AgentæœåŠ¡ï¼ˆå‰ææ˜¯AgentæœåŠ¡æ˜¯ç”¨å¼‚æ­¥çº¿ç¨‹å®ç°çš„ï¼Œå¦‚æœç”¨åç¨‹å®ç°ï¼Œæ²¡å•¥åŒºåˆ«ï¼‰å°†ä¼šç”¨å¼‚æ­¥çº¿ç¨‹å»ç­‰å¾…IOå¹¶ä¸”è¿”å›ç»“æœï¼Œè€ŒQuasarçš„workçº¿ç¨‹æ˜¯è½®è¯¢è¿™äº›åç¨‹ä»»åŠ¡ï¼Œæœ‰IOå®Œæˆçš„ä¾¿è®©è¿™ä¸ªä»»åŠ¡è¿”å›ã€‚

åç¨‹ä¸æ˜¯çº¿ç¨‹ï¼Œæ›´ä¸æ˜¯è¿›ç¨‹ï¼Œæ‰€ä»¥åç¨‹å¹¶éå¼‚æ­¥ï¼Œä½†å´å¯ä»¥å……åˆ†åˆ©ç”¨CPUï¼Œä¸è¦å°†CPUçš„å®è´µèµ„æºæµªè´¹åœ¨ç­‰å¾…IOé˜»å¡ä¸Šï¼Œå› ä¸ºä¸æ˜¯çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒçº¿ç¨‹çš„ç»´æŠ¤ã€‚æ›´ä¸ç”¨æ‹…å¿ƒå¤§é‡çº¿ç¨‹é˜»å¡å¯¼è‡´ç³»ç»Ÿå¯ç”¨èµ„æºä¸‹é™ã€‚

ä½¿ç”¨ä»£ç éšä¸‹ç« èŠ‚ç»™å‡ºã€‚

## æ€§èƒ½æ¯”è¾ƒ

æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸‹é‡åˆ°çš„æœåŠ¡åœºæ™¯ï¼Œåˆ†åˆ«ç”¨ Executor, ForkJoin, Quasar è¿›è¡Œé¡ºåºè¯·æ±‚ä»£ç çš„ä¿®æ”¹ï¼Œçœ‹ä¸‹æ•ˆç‡å¦‚ä½•

ä»£ç ç»“æ„å¦‚ä¸‹:

- Main å……å½“è¯·æ±‚æ–¹ï¼Œå¯ä»¥å¹¶å‘å¯¹è°ƒç”¨MyServiceä¸­çš„æ–¹æ³•
- MyService å……å½“æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡ï¼Œå“åº”Mainè¿›æ¥çš„è¯·æ±‚
- OtherService å……å½“åˆ«äººçš„æœåŠ¡ï¼ŒMyServiceä¾èµ–OtherServiceä¸­çš„æ–¹æ³•
    - OtherService ä»¥Sleepæ¥æ¨¡æ‹Ÿå“åº”å»¶è¿Ÿ


### Main.java

```java

public class Main {
    private static ExecutorService executorPool;
    private static int poolSize = 300;
    private static int requestSize = 300;

    private static void init() {
        MyService.DEFAULT_DEPEND_COUNT = 5; //MyService è°ƒç”¨å…¶ä»–æœåŠ¡çš„æ¬¡æ•°
        MyService.disposeType = MyService.DISPOSE_TYPE.COROUTINE; //MyService å¤„ç†ç±»å‹ï¼Œåˆ†ä¸ºåç¨‹ï¼Œå•çº¿ç¨‹ï¼Œå¤šçº¿ç¨‹(forkjoin, executor)

        OtherService.IS_RANDOM_DELAY = Boolean.FALSE; // å»¶è¿Ÿæ˜¯å¦éšå³ç”Ÿæˆ
        OtherService.DEFAULT_DELAY = 500; //é»˜è®¤å»¶è¿Ÿæ—¶é—´ IS_RANDOM_DELAY==FALSE æ—¶å€™ç”Ÿæ•ˆ
        OtherService.DEFAULT_TIMEOUT = 10000; // é»˜è®¤è¶…æ—¶æ—¶é—´
        OtherService.DEFAULT_DELAY_UPPER = 10000; //éšæœºå»¶è¿Ÿçš„ä¸Šé™ IS_RANDOM_DELAY==TRUEçš„æ—¶å€™ç”Ÿæ•ˆ

        poolSize = 1; // è¯·æ±‚æ–¹çº¿ç¨‹æ± çš„å¤§å° è¿™ä¸ªæ— å…³ä¹MyServiceå’ŒOtherService
        requestSize = 1; //å¹¶å‘è¯·æ±‚æ¬¡æ•°
        executorPool = Executors.newFixedThreadPool(poolSize);
    }

    public static void main(String[] args) {
        init();
        int successCount = 0;
        int failCount = 0;
        Long startTime = System.currentTimeMillis();

        final CountDownLatch countDownLatch = new CountDownLatch(requestSize);
        final List<Future<Boolean>> results = new ArrayList<Future<Boolean>>();
        for (int i = 0; i < requestSize; i++) {
            results.add(executorPool.submit(new Callable<Boolean>() {
                public Boolean call() throws Exception {
                    boolean result = new MyService().dispose();
                    countDownLatch.countDown();
                    return result;
                }
            }));
        }
        try {
            countDownLatch.await();
        } catch (Exception e) {
            e.printStackTrace();
        }
        for (Future<Boolean> future : results) {
            try {
                if (future.get()) {
                    successCount++;
                } else {
                    failCount++;
                }
            } catch (Exception e) {
                failCount++;
            }
        }

        Long endTime = System.currentTimeMillis();

        System.out.println(String.format("è¯·æ±‚å®Œæˆ, è€—æ—¶ %s ms, è¯·æ±‚æˆåŠŸ%sæ¬¡, å¤±è´¥%sæ¬¡", (endTime - startTime), successCount, failCount));

        finish();
    }

    private static void finish() {
        executorPool.shutdown();
    }
}
```

### MyService.java

```java
public class MyService {
    public static int DEFAULT_DEPEND_COUNT = 3; // é»˜è®¤ä¾èµ–å…¶ä»–æœåŠ¡è°ƒç”¨æ¬¡æ•°
    public static DISPOSE_TYPE disposeType = DISPOSE_TYPE.SEQUENCE;
    private int dependCount = DEFAULT_DEPEND_COUNT;

    public enum DISPOSE_TYPE {MULTI_THREAD, FORKJOIN, COROUTINE, SEQUENCE}

    public MyService() {
    }

    public MyService(int dependCount) {
        if (dependCount < 0) {
            this.dependCount = DEFAULT_DEPEND_COUNT;
        }
    }

    public boolean dispose() {
        switch (disposeType) {
            case MULTI_THREAD:
                return disposeByExecutor();
            case COROUTINE:
                return disposeByCoroutine();
            case FORKJOIN:
                return disposeByForkJoin();
            default:
                return disposeBySequence();
        }
    }

    //forkjoinå¤„ç†
    private boolean disposeByForkJoin() {
        boolean result = false;

        List<Future<Boolean>> futures = new ArrayList<Future<Boolean>>(dependCount);
        //forkjoin çº¿ç¨‹æ±  å¸¦work-stealing
        ForkJoinPool forkJoinPool = new ForkJoinPool();
        final CountDownLatch countDownLatch = new CountDownLatch(dependCount);

        for (int i = 0; i < dependCount; i++) {
            futures.add(forkJoinPool.submit(new Callable<Boolean>() {
                public Boolean call() throws Exception {
                    OtherService otherService = new OtherService();
                    boolean result = otherService.dispose();
                    countDownLatch.countDown();
                    return result;
                }
            }));
        }

        try {
            countDownLatch.await();
            result = Boolean.TRUE;
            for (Future<Boolean> future : futures) {
                result &= future.get();
            }
        } catch (Exception e) {
            result = Boolean.FALSE;
        }

        return result;
    }

    // åç¨‹å¤„ç†
    private boolean disposeByCoroutine() {
        boolean result = false;

        List<Fiber<Boolean>> fibers = new ArrayList<Fiber<Boolean>>();
        for (int i = 0; i < dependCount; i++) {
            fibers.add(new Fiber<Boolean>(new SuspendableCallable<Boolean>() {
                public Boolean run() throws SuspendExecution, InterruptedException {
                    OtherService otherService = new OtherService();
                    return otherService.dispose();
                }
            }).start());
        }

        result = Boolean.TRUE;
        try {
            for (Fiber<Boolean> fiber : fibers) {
                result &= fiber.get();
            }
        } catch (Exception e) {
            result = Boolean.FALSE;
        }

        return result;
    }
    
    // Executor å¤„ç†
    private boolean disposeByExecutor() {
        boolean result = false;

        List<Future<Boolean>> futures = new ArrayList<Future<Boolean>>(dependCount);
        // æ™®é€šexecutorçº¿ç¨‹æ±  ä¸å¸¦work-stealing
        ExecutorService executorService = Executors.newFixedThreadPool(dependCount);
        final CountDownLatch countDownLatch = new CountDownLatch(dependCount);

        for (int i = 0; i < dependCount; i++) {
            futures.add(executorService.submit(new Callable<Boolean>() {
                public Boolean call() throws Exception {
                    OtherService otherService = new OtherService();
                    boolean result = otherService.dispose();
                    countDownLatch.countDown();
                    return result;
                }
            }));
        }

        try {
            countDownLatch.await();
            result = Boolean.TRUE;
            for (Future<Boolean> future : futures) {
                result &= future.get();
            }
        } catch (Exception e) {
            result = Boolean.FALSE;
        }

        executorService.shutdown();

        return result;
    }

    // é¡ºåºå¤„ç†
    private boolean disposeBySequence() {
        boolean result = false;

        OtherService otherService = new OtherService();

        try {
            for (int i = 0; i < dependCount; i++) {
                // è°ƒç”¨å…¶ä»–æœåŠ¡ï¼Œ300msçš„å»¶è¿Ÿ
                result = otherService.dispose();

                if (!result) {
                    break;
                }
            }
        } catch (Exception e) {
            result = Boolean.FALSE;
        }


        return result;
    }
}
```

### OtherService

``` java

public class OtherService {
    public static int DEFAULT_TIMEOUT = 3000; //é»˜è®¤è¶…æ—¶æ—¶é—´ 3s
    public static int DEFAULT_DELAY = 300; //é»˜è®¤å»¶è¿Ÿ300ms
    public static int DEFAULT_DELAY_UPPER = 5000; //é»˜è®¤å»¶è¿Ÿä¸Šé™ 10s
    public static boolean IS_RANDOM_DELAY = Boolean.FALSE; //å»¶è¿Ÿéšæœº

    // è¿™ä¸ªæ³¨è§£æ˜¯Quasaræä¾›çš„ï¼Œè¡¨æ˜è¿™ä¸ªæ–¹æ³•å‘ç”Ÿé˜»å¡çš„æ—¶å€™æ˜¯å¯ä»¥è¢«æŒ‚èµ·çš„
    @Suspendable
    public boolean dispose() {
        boolean result = false;

        int delay = DEFAULT_DELAY;

        if (IS_RANDOM_DELAY) {
            Random random = new Random();
            delay = random.nextInt(DEFAULT_DELAY_UPPER);

        }

        if (delay > DEFAULT_TIMEOUT) {
            result = false;
        } else {
            result = true;
        }

        try {
            Strand.sleep(delay);
        } catch (Exception e) {
            e.printStackTrace();
            result = false;
        }

        return result;
    }
}

```

ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œåœ¨Mainä¸­ï¼Œæˆ‘ä»¬åŠ å…¥äº†ä¸€äº›å¯é…ç½®çš„ä¸œè¥¿ï¼Œéƒ½åœ¨init()æ–¹æ³•ä¸­

### æµ‹è¯•æ•°æ®å’Œç»“æœ

|åºå·|è¯·æ±‚æ¬¡æ•°|æ¯æ¬¡è¯·æ±‚MyServiceè°ƒç”¨OtherServiceæ¬¡æ•°|å¹³å‡å»¶è¿Ÿ|è¶…æ—¶æ—¶é—´|è°ƒç”¨æ–¹å¼|å“åº”æ—¶é—´ms|å¤‡æ³¨|
|:----|:-----|:------|:-----|:----|:----|:----|
|1-0|1|5|500ms|3000ms|SEQUENCE|2730|
|1-1|1|5|500ms|3000ms|MULTI_THREAD|677|Executorçº¿ç¨‹æ± 10|
|1-2|1|5|500ms|3000ms|FORKJOIN|1160|
|1-3|1|5|500ms|3000ms|COROUTINE|1146|

|åºå·|è¯·æ±‚æ¬¡æ•°|æ¯æ¬¡è¯·æ±‚MyServiceè°ƒç”¨OtherServiceæ¬¡æ•°|å¹³å‡å»¶è¿Ÿ|è¶…æ—¶æ—¶é—´|è°ƒç”¨æ–¹å¼|å“åº”æ—¶é—´ms|å¤‡æ³¨|
|:----|:-----|:------|:-----|:----|:----|:----|
|2-0|1|1000|500ms|3000ms|SEQUENCE|è¿™ä¸ªæ—¶é—´é•¿çš„ä¸æƒ³ç­‰äº†|
|2-1|1|1000|500ms|3000ms|MULTI_THREAD|5235|Executorçº¿ç¨‹æ± 10|
|2-2|1|1000|500ms|3000ms|FORKJOIN|126118|
|2-3|1|1000|500ms|3000ms|COROUTINE|1146|

> ForkJoin å“åº”æ—¶é—´é•¿çš„æœ‰ç‚¹æƒŠäººï¼Œæ‰“å°jstackå‘ç°ä»…ä»…æœ‰4ä¸ªworkçº¿ç¨‹å¤„ç†ä»»åŠ¡ [jstack](http://7xoguv.com1.z0.glb.clouddn.com/fj-1-1000)

|åºå·|è¯·æ±‚æ¬¡æ•°|æ¯æ¬¡è¯·æ±‚MyServiceè°ƒç”¨OtherServiceæ¬¡æ•°|å¹³å‡å»¶è¿Ÿ|è¶…æ—¶æ—¶é—´|è°ƒç”¨æ–¹å¼|å“åº”æ—¶é—´ms|å¤‡æ³¨|
|:----|:-----|:------|:-----|:----|:----|:----|
|3-0|1000|5|500ms|3000ms|SEQUENCE|3027|
|3-1|1000|5|500ms|3000ms|MULTI_THREAD|OOM|Executorçº¿ç¨‹æ± 10|
|3-2|1000|5|500ms|3000ms|FORKJOIN|OOM|
|3-3|1000|5|500ms|3000ms|COROUTINE|1389|

|åºå·|è¯·æ±‚æ¬¡æ•°|æ¯æ¬¡è¯·æ±‚MyServiceè°ƒç”¨OtherServiceæ¬¡æ•°|å¹³å‡å»¶è¿Ÿ|è¶…æ—¶æ—¶é—´|è°ƒç”¨æ–¹å¼|å“åº”æ—¶é—´ms|å¤‡æ³¨|
|:----|:-----|:------|:-----|:----|:----|:----|
|4-0|10000|3|500ms|3000ms|SEQUENCE|21186|
|4-1|10000|3|500ms|3000ms|MULTI_THREAD|OOM|Executorçº¿ç¨‹æ± 10|
|4-2|10000|3|500ms|3000ms|FORKJOIN|OOM|
|4-3|10000|3|500ms|3000ms|COROUTINE|5906|


**æ˜¯ä¸æ˜¯æ„Ÿè§‰Quasarçš„è¡¨ç°æ£’æ£’çš„ï½**

### jstack

ä¸‹é¢æˆ‘ä»¬æŠŠå»¶è¿Ÿè°ƒé•¿ç‚¹ï¼š300000ï¼Œè¶…æ—¶æ—¶é—´ï¼š300000ï¼Œè¯·æ±‚æ¬¡æ•°5ï¼Œä¾èµ–è°ƒç”¨æ¬¡æ•°5æ¬¡ï¼Œ çœ‹ä¸‹çº¿ç¨‹æ ˆ(è°ƒé•¿ç‚¹æ˜¯ä¸ºäº†æ‰“å †æ ˆå¯ä»¥ååº”è¿‡æ¥) ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥å¯ä»¥ä¸‹è½½å †æ ˆæ–‡ä»¶:

ğŸ‘‰ [SEQUENCE](http://7xoguv.com1.z0.glb.clouddn.com/sq-5-5)    

ğŸ‘‰ [MULTI_THREAD](http://7xoguv.com1.z0.glb.clouddn.com/mt-5-5)    

ğŸ‘‰ [FORKJOIN](http://7xoguv.com1.z0.glb.clouddn.com/fj-5-5)    

ğŸ‘‰ [COROUTINE](http://7xoguv.com1.z0.glb.clouddn.com/co-5-5)    

ä¸Šé¢å †æ ˆä¿¡æ¯å¯ä»¥è§£é‡Šä¸Šé¢å‡ ä¸ªé—®é¢˜ï¼š

* 3-2 ï¼ 3-3 çš„ `OOM`:

1000 * 5 æ•°é‡çº§çš„çº¿ç¨‹è¢«åˆ›å»ºï¼Œä¼°è®¡å¾ˆå®¹æ˜“è¢«OOMå§ï½

* 2-2 å“åº”æ—¶é—´ `126118ms`

ä¸Šé¢çš„æ•°é‡çº§æ‰“åˆ°1000ï¼Œä»jstackæ¥çœ‹ ForkJoin ä»…ä»…å¼€äº†3ä¸ªworkçº¿ç¨‹ï¼Œå“åº”æ—¶é—´è‚¯å®šä¼šå¾ˆé•¿

* Quasar åº•å±‚çš„workçº¿ç¨‹æ˜¯ç”¨fork-join-poolå®ç°çš„

## è¿˜å¯ä»¥æ›´å¥½

æ¯•ç«ŸSleepæ¨¡æ‹ŸIOå»¶è¿Ÿä¸å¤ªåˆé€‚ï¼Œæœ¬æ¥æ˜¯å‡†å¤‡äº†1000Wçš„DBæ•°æ®åš `limit offset` æ¥æ¨¡æ‹Ÿ DBé•¿æ—¶é—´IOçš„ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å¤šçº¿ç¨‹è¯»DBæœ‰å›å¸¦æ¥å¦å¤–çš„é—®é¢˜ï¼ŒåŠ ä¸Šå®åœ¨æ˜¯å¤ªæ™šäº†ï¼ˆå·²ç»å‡Œæ™¨ä¸¤ç‚¹äº†ï¼Œç¬¬äºŒå¤©è¿˜è¦ä¸Šç­â€¦â€¦ï¼‰ï¼Œæ‰€ä»¥æƒ³äº†ä¸¤ä¸ªåŠæ³•ï¼Œ1. æ‰¾æ—¶é—´æä¸€æDBå»¶è¿Ÿã€‚ 2. æ‹¿å…¬å¸çš„é¡¹ç›®è¯•ä¸€ä¸‹ï¼Œçœ‹å‹æµ‹ç»“æœä¾¿çŸ¥é“æ•ˆæœäº†ã€‚

å¦‚æœä¸Šé¢Demoå†™çš„å“ªé‡Œæœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡å‡ºæ”¹è¿›ã€‚

## å‚è€ƒèµ„æ–™

* [èŠèŠå¹¶å‘](http://www.infoq.com/cn/articles/fork-join-introduction)
* [Javaä¸­çš„çº¤ç¨‹åº“](http://colobu.com/2016/07/14/Java-Fiber-Quasar/)
* [ç»§ç»­äº†è§£Javaçš„çº¤ç¨‹åº“](http://colobu.com/2016/08/01/talk-about-quasar-again/)
* [è¶…è¯¦ç»† java ä¸­çš„ ClassLoader è¯¦è§£](https://juejin.im/entry/58c0cb63a22b9d0058914057)
* [Quasarå®˜ç½‘æ‰‹å†Œ](http://docs.paralleluniverse.co/quasar/#specifying-the-java-agent-with-gradle)
* [æ¬¡æ—¶ä»£javaæ—¶ä»£](https://www.oschina.net/question/2680454_2180396)
* [æ¯”è¾ƒç¼–è¯‘æŠ€æœ¯](https://www.ibm.com/developerworks/cn/java/j-rtj2/index.html)
* [java7é‡Œçš„fork-join](http://ifeve.com/java7-fork-join-and-closure/)
* [Coroutine in Java - Quasar Fiberå®ç°](https://segmentfault.com/a/1190000006079389)
* [Javaå¹¶å‘çš„å››ç§é£å‘³](http://www.importnew.com/14506.html)

## æ„Ÿè°¢

æ„Ÿè°¢å…¬å¸åŒäº‹æä¾›çš„å„ç§å¸®åŠ©å’Œå¼•å¯¼ï¼Œåœ¨äº‰è®ºä¸­æˆé•¿ã€‚

## GitHub

è¿™é‡Œçš„ä»£ç æ˜¯ä»[å®˜æ–¹æ¨èä»£ç ](https://github.com/puniverse/quasar-gradle-template) Cloneä¸‹æ¥å¹¶ä¸”åšäº†äº›[ä¿®æ”¹ä¹‹åçš„ä»£ç ](https://github.com/SUT-GC/quasar-example)

