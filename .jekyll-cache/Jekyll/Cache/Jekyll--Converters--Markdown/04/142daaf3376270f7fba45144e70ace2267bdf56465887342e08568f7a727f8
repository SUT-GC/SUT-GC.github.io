I"ğÉ<ul class="toc" id="markdown-toc">
  <li><a href="#heading-ä½ è§‰å¾—åŸºç¡€æœåŠ¡çš„ä»£ç åº”è¯¥æ€ä¹ˆå†™å‘¢" id="markdown-toc-heading-ä½ è§‰å¾—åŸºç¡€æœåŠ¡çš„ä»£ç åº”è¯¥æ€ä¹ˆå†™å‘¢">ä½ è§‰å¾—åŸºç¡€æœåŠ¡çš„ä»£ç åº”è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿ</a>    <ul>
      <li><a href="#heading-èƒŒæ™¯" id="markdown-toc-heading-èƒŒæ™¯">èƒŒæ™¯</a>        <ul>
          <li><a href="#heading-æœåŠ¡åˆ†å±‚" id="markdown-toc-heading-æœåŠ¡åˆ†å±‚">æœåŠ¡åˆ†å±‚</a></li>
        </ul>
      </li>
      <li><a href="#heading-åŸºç¡€æœåŠ¡å±‚èƒ½åŠ›åˆ†æ" id="markdown-toc-heading-åŸºç¡€æœåŠ¡å±‚èƒ½åŠ›åˆ†æ">åŸºç¡€æœåŠ¡å±‚èƒ½åŠ›åˆ†æ</a>        <ul>
          <li><a href="#heading-é—¨é¢" id="markdown-toc-heading-é—¨é¢">é—¨é¢</a></li>
          <li><a href="#heading-æ ¸å¿ƒ" id="markdown-toc-heading-æ ¸å¿ƒ">æ ¸å¿ƒ</a></li>
          <li><a href="#heading-è¯´æ˜-1" id="markdown-toc-heading-è¯´æ˜-1">è¯´æ˜</a></li>
        </ul>
      </li>
      <li><a href="#heading-ä»£ç æ€ä¹ˆå†™" id="markdown-toc-heading-ä»£ç æ€ä¹ˆå†™">ä»£ç æ€ä¹ˆå†™</a>        <ul>
          <li><a href="#heading-è¯´åœ¨å‰é¢" id="markdown-toc-heading-è¯´åœ¨å‰é¢">è¯´åœ¨å‰é¢</a></li>
          <li><a href="#heading-ä»£ç ç»“æ„" id="markdown-toc-heading-ä»£ç ç»“æ„">ä»£ç ç»“æ„</a></li>
          <li><a href="#heading-ä¸Šä»£ç java" id="markdown-toc-heading-ä¸Šä»£ç java">ä¸Šä»£ç ï¼ˆJAVAï¼‰</a></li>
          <li><a href="#heading-è¯´åœ¨åé¢" id="markdown-toc-heading-è¯´åœ¨åé¢">è¯´åœ¨åé¢</a></li>
        </ul>
      </li>
      <li><a href="#heading-æ€»ç»“" id="markdown-toc-heading-æ€»ç»“">æ€»ç»“</a></li>
    </ul>
  </li>
</ul>

<h1 id="heading-ä½ è§‰å¾—åŸºç¡€æœåŠ¡çš„ä»£ç åº”è¯¥æ€ä¹ˆå†™å‘¢">ä½ è§‰å¾—åŸºç¡€æœåŠ¡çš„ä»£ç åº”è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿ</h1>

<h2 id="heading-èƒŒæ™¯">èƒŒæ™¯</h2>

<p>å…¬å¸å¾®æœåŠ¡åŒ–ä¹‹åï¼Œå¾ˆå¤šå¤§çš„é¡¹ç›®éƒ½è¢«æ‹†è§£æˆä¸åŒæ¨¡å—ï¼Œè¿™äº›æ¨¡å—å½¼æ­¤äº¤äº’ï¼Œäº’ç›¸ä¾èµ–ï¼Œæœ€ç»ˆä¸€èµ·æ”¯æ’‘èµ·çº¿ä¸Šåºå¤§çš„ä¸šåŠ¡é‡ã€‚</p>

<p><img src="/files/images/baseservice01.jpg" alt="ç³»ç»Ÿè°ƒç”¨é“¾è·¯" /></p>

<p>ä»¥é¤é¥®å¹³å°çš„åº—é“ºé¢†åŸŸä¸ºDemoï¼Œè¿™é‡Œç”¨ä¸€å¼ å›¾æ¥æè¿°ä¸‹ä¸€ä¸ªé¢†åŸŸå†…å¯èƒ½æ‹¥æœ‰çš„æœåŠ¡æ¨¡å—åŠå…¶ä¾èµ–å…³ç³»ï¼Œ ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çš„è¯´æ˜ä¸‹å…·ä½“æ¨¡å—åŠæ‰¿æ‹…çš„è§’è‰²ã€‚</p>

<h3 id="heading-æœåŠ¡åˆ†å±‚">æœåŠ¡åˆ†å±‚</h3>

<p>æ ¹æ®ä¸‰å±‚åŸåˆ™å°†æœåŠ¡åˆ†æˆå¹¿ä¹‰çš„ APIï¼Œ Businessï¼Œ Data ä¸‰å±‚ã€‚</p>

<h4 id="heading-apiå±‚">APIå±‚</h4>

<p>DTOä¸ºæ•°æ®ä¼ è¾“å±‚ï¼Œ å¯¹äºä¸€ä¸ªé¢†åŸŸæ¥è¯´æ˜¯å„ç§APIï¼Œ å¦‚ ç•Œé¢APIï¼Œ å¼€æ”¾å¹³å°APIï¼Œ å…¶ä»–é¢†åŸŸæœåŠ¡APIï¼Œå®šæ—¶ä»»åŠ¡APIã€‚</p>

<ul>
  <li>ç•Œé¢APIï¼š åº”å¯¹ä¸å‰ç«¯çš„apiæœåŠ¡ï¼Œä¸å‰ç«¯ç•Œé¢ç›´æ¥äº¤äº’ï¼Œ é‰´æƒï¼Œè·¨åŸŸï¼Œé˜²çˆ¬ç­‰æ‰‹æ®µéƒ½åšåœ¨è¯¥æœåŠ¡ä¸Šã€‚</li>
  <li>å¼€æ”¾å¹³å°APIï¼šåº”å¯¹ä¸ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œ åŒæ ·æœ‰é‰´æƒï¼Œé˜²çˆ¬ï¼Œé™æµç­‰èƒ½åŠ›</li>
  <li>å…¶ä»–é¢†åŸŸæœåŠ¡APIï¼šå³ä¸ºå…¶ä»–é¢†åŸŸçš„æœåŠ¡ï¼Œåœ¨é€”ä¸­å¯¹åº”ä¸ºother_serviceï¼Œ è¿™äº›æœåŠ¡ä¸å±äºæœ¬é¢†åŸŸï¼Œä½†å› ä¸ºé¢†åŸŸä¹‹é—´ç›¸äº’ä¾èµ–èƒ½åŠ›ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨å…¶ä»–é¢†åŸŸçš„æœåŠ¡åˆ°è‡ªå·±é¢†åŸŸçš„è°ƒç”¨ï¼ˆå¯èƒ½æ˜¯åŒæ­¥rpcï¼Œä¹Ÿå¯èƒ½æ˜¯å¼‚æ­¥messageï¼‰</li>
  <li>å®šæ—¶ä»»åŠ¡APIï¼šå¯¹åº”å›¾ä¸­job_service,  åœ¨cièƒ½åŠ›å…¨ä¸€ç‚¹çš„å…¬å¸ï¼Œä¼šæœ‰ä»»åŠ¡è§¦å‘ä¸­é—´ä»¶ï¼Œå®ƒè´Ÿè´£å®šæ—¶è§¦å‘é…ç½®å¥½çš„ä»»åŠ¡ï¼Œæ–¹ä¾¿ç®¡ç†å’Œç›‘æ§ã€‚å…·æœ‰è¿™ä¸ªèƒ½åŠ›çš„ä¸­é—´ä»¶æœåŠ¡ç§°ä¸ºjob_serviceã€‚</li>
</ul>

<h4 id="heading-businesså±‚">Businesså±‚</h4>

<p>Businesså±‚ä¸ºä¸šåŠ¡ä½“ç°å±‚ï¼Œé¢†åŸŸå†…çš„å…·ä½“ä¸šåŠ¡åœ¨è¿™ä¸€å±‚ä½“ç°ï¼Œä¸¾ä¸ªä¾‹å­ï¼šåº—é“ºé¢†åŸŸæ¥åˆ°äº†ä¸€ä¸ªäº§å“éœ€æ±‚ï¼Œå•†å®¶æŠŠåº—é“ºå…³åº—çš„æ—¶å€™è¦æŠŠæ‰€æœ‰çš„å•†å“éƒ½ä¸‹çº¿ï¼ˆè¿™ä¸ªä¾‹å­ä¸å¤ªåˆç†ï¼‰ã€‚ é‚£ä¹ˆå…³åº—åŠ¨ä½œè‚¯å®šæ˜¯å‘ç”Ÿåœ¨apiå±‚ï¼Œ å¯èƒ½æ˜¯é¡µé¢ï¼Œå¯èƒ½æ˜¯å¼€æ”¾å¹³å°ï¼Œå¯èƒ½æ˜¯å…¶ä»–æœåŠ¡åšå…³åº—æ“ä½œï¼Œä½†â€œå…³åº—&amp;ä¸‹çº¿å•†å“â€æ˜¯æ¶‰åŠåˆ°ä¸¤ä¸ªé¢†åŸŸçš„ä¸šåŠ¡é€»è¾‘ï¼Œ æ‰€ä»¥è¦å°†è¿™ä¸ªé€»è¾‘åœ¨å†™
businessè¿™ä¸€å±‚ã€‚</p>

<h4 id="heading-dataå±‚">Dataå±‚</h4>

<p>Dataå±‚æ˜¯åŸºç¡€æœåŠ¡å±‚ï¼Œæä¾›åŸºç¡€çš„æ•°æ®èƒ½åŠ›ï¼Œä¸ºä¸Šå±‚ä¸šåŠ¡æä¾›èƒ½åŠ›æ”¯æŒï¼Œ æ•°æ®å±‚ä¸ºé¢†åŸŸå†…æ•°æ®æ“ä½œçš„åŸå­åŠ¨ä½œï¼Œ åœ¨åº—é“ºé¢†åŸŸï¼Œæ¯”å¦‚å¼€å…³åº—ï¼Œä¸Šä¸‹çº¿ï¼Œä¿®æ”¹åº—é“ºçš„ä¸€ä¸ªæˆ–è€…å‡ ä¸ªä¿¡æ¯ï¼Œè¿™ä¸€å±‚çš„æœåŠ¡èƒ½åŠ›å’Œä»£ç å°±æ˜¯æœ¬æ–‡è¦æ¢è®¨çš„ã€‚</p>

<h4 id="heading-è¯´æ˜">è¯´æ˜</h4>

<p>ä¸Šè¿°ä¸ªæ¨¡å—å¹¶ä¸æ˜¯ä¸€å®šè¦å­˜åœ¨çš„ï¼Œ ç”±äºå…¬å¸ä¸šåŠ¡çš„å¤æ‚åº¦å’Œå¾®æœåŠ¡åŒ–ç²’åº¦ä¸åŒï¼Œéƒ½ä¼šæœ‰ä¸åŒçš„ä½“ç°ï¼Œ ä½†ä¸ªäººè®¤ä¸ºå¹¿ä¹‰ä¸Šæ¥è¯´éƒ½ä¼šå­˜åœ¨ä»¥ä¸Šçš„è§’è‰²ï¼Œåªä¸è¿‡ä¸€ä¸ªæœåŠ¡å¯èƒ½åŒæ—¶æ‰¿æ‹…ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è§’è‰²ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½å­˜åœ¨å¤šä¸ªæœåŠ¡å…±åŒæ‰¿æ‹…ä¸€ä¸ªè§’è‰²ã€‚</p>

<h2 id="heading-åŸºç¡€æœåŠ¡å±‚èƒ½åŠ›åˆ†æ">åŸºç¡€æœåŠ¡å±‚èƒ½åŠ›åˆ†æ</h2>

<p>ä½œä¸ºåŸºç¡€æœåŠ¡å±‚æä¾›è¯¥é¢†åŸŸå†…æ ¸å¿ƒæ•°æ®çš„CRUDåŸå­èƒ½åŠ›ï¼Œ ä½†ä¸å•å•æ˜¯DBçš„CRUDï¼Œæ˜¯æŠ½è±¡åˆ°ä¸€ä¸ªé¢†åŸŸå†…çš„æ“ä½œï¼Œè¿™äº›æ“ä½œåœ¨åŸºæœ¬DBçš„æ“ä½œä¸Šä¼šåšä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼Œæ¯”å¦‚noticeï¼Œæ¯”å¦‚change record çš„è½åœ°ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½ä¼šæœ‰rpcè°ƒç”¨ï¼ˆä¸æ¨èï¼‰ã€‚</p>

<p><img src="/files/images/baseservice02.jpg" alt="ç³»ç»Ÿè°ƒç”¨é“¾è·¯" /></p>

<p>æˆ‘è®¤ä¸ºï¼ŒåŸºç¡€æœåŠ¡å¯ä»¥å¤§è‡´åˆ†ä¸º é—¨é¢ å’Œ æ ¸å¿ƒ ä¸¤å±‚ï¼Œ é—¨é¢å±‚è´Ÿè´£å¯¹å¤–ï¼Œæ ¸å¿ƒå±‚è´Ÿè´£åŒ…è£…é¢†åŸŸçš„æ“ä½œã€‚</p>

<h3 id="heading-é—¨é¢">é—¨é¢</h3>

<p>é—¨é¢å±‚æ˜¯å¯¹å¤–éƒ¨æŒ‡å®šæ–¹çš„èƒ½åŠ›æä¾›ï¼Œæ¯”å¦‚å•†å“é¢†åŸŸå¯ä»¥æ§åˆ¶åº—é“ºè¥ä¸šçŠ¶æ€ï¼Œä¹Ÿåªèƒ½æ§åˆ¶åº—é“ºè¥ä¸šçŠ¶æ€ï¼Œ åˆ™é—¨åº—å±‚è¦å¯¹å•†å“é€å‡ºä¸”ä»…é€å‡ºè¥ä¸šçŠ¶æ€çš„æ§åˆ¶ï¼Œè¿™æ ·è™½ç„¶æ¥å…¥èµ·æ¥éº»çƒ¦ï¼Œä½†ä½¿å¾—å¯¹ä¸åŒçš„é¢†åŸŸå¯ä»¥æœ‰ä¸åŒçš„å®ç°ï¼Œ ä½¿å¾—æ§åˆ¶æœ€å¤§åŒ–ã€‚ ä¸åŒå®ç°æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ æ¯”å¦‚é¢ä¸Šå•†æˆ·ä½¿ç”¨çš„æ“ä½œæ˜¯æœ€å¤§æœŸæœ›æˆåŠŸçš„ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨é¢ä¸Šå•†æˆ·æ“ä½œçš„Facadeä¸Šè¿›è¡Œå†…éƒ¨é‡è¯•ï¼Œ å°½å¯èƒ½çš„é™ä½å¤±è´¥æ¦‚ç‡ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒæœ€å¥½ã€‚</p>

<h3 id="heading-æ ¸å¿ƒ">æ ¸å¿ƒ</h3>

<p>æ ¸å¿ƒå±‚æ˜¯é¢†åŸŸå†…æœ€å¤§èƒ½åŠ›çš„è¡¨ç°ï¼Œæ ¸å¿ƒå±‚çš„æ¥å£å¯¹å¤–é€å‡ºè¯¥é¢†åŸŸèƒ½æä¾›çš„æœ€å¤§èƒ½åŠ›ï¼Œ æ¯”å¦‚é—¨åº—é¢†åŸŸï¼Œ æ ¸å¿ƒå±‚æ¥å£å¯ä»¥æ›´æ–°æ‰€æœ‰ä¼šè¢«æ›´æ–°çš„å­—æ®µï¼Œé—¨åº—æœ‰ name, address, location, logo, servingTime, servingStatus ç­‰å­—æ®µï¼Œé‚£ä¹ˆæ ¸å¿ƒå±‚æ¥å°±å¯ä»¥å¯¹ä¸Šé¢ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µè¿›è¡Œæ›´æ–°ã€‚</p>

<p>æ ¸å¿ƒå±‚æ¥å£åŒ…è£…é¢†åŸŸå†…çš„â€œåŸå­â€æ“ä½œï¼Œè¿™äº›æ“ä½œå¯ä»¥åˆ†ä¸ºï¼šæ‰§è¡Œå‰ï¼Œæ‰§è¡Œï¼Œæ‰§è¡Œåã€‚</p>

<ul>
  <li>æ‰§è¡Œå‰ï¼š å„ç§æ ¡éªŒï¼Œå¦‚å‚æ•°åˆæ³•æ€§æ ¡éªŒï¼Œ ä¸šåŠ¡åˆæ³•æ€§æ ¡éªŒï¼ˆæ¯”å¦‚æ›´æ–°æŸä¸ªå­—æ®µçš„æ—¶å€™å¿…é¡»é‚£ä¸ªå­—æ®µæœ‰å€¼ç­‰ï¼‰ç­‰ï¼Œä¸šåŠ¡å¼‚å¸¸å¯ä»¥åœ¨è¿™é‡ŒæŠ›å‡ºã€‚</li>
  <li>æ‰§è¡Œï¼šçœŸæ­£DBæ•°æ®çš„CRUDï¼Œè¿™é‡Œç†è®ºä¸Šä¸åº”è¯¥æŠ›ä¹‰åŠ¡å¼‚å¸¸ï¼Œå¯ä»¥æŠ›RuntimeExceptionæˆ–è€…SystemException</li>
  <li>æ‰§è¡Œåï¼šè¿™é‡Œåšæ‰§è¡ŒæˆåŠŸåçš„ä¸€äº›åäº‹çš„å¤„ç†ï¼Œæ¯”å¦‚ scene noticeï¼Œlog recordï¼Œç†è®ºä¸Šè¿™é‡Œä¸åº”è¯¥æŠ›å¼‚å¸¸ï¼Œä½†å¦‚æœå‡ºç°å¼‚å¸¸å¯ä»¥åšä¸€äº›æ‰“ç‚¹/ç›‘æ§/æŠ¥è­¦ç­‰ã€‚ï¼ˆæŠ›å¼‚å¸¸ä¹Ÿæ²¡å…³ç³»ï¼Œä½†è¿™æ ·è¦æ±‚æ‰§è¡Œæ¨¡å—åšå¥½å¹‚ç­‰ï¼Œå› ä¸ºåº•å±‚çš„å¼‚å¸¸å¾ˆå¯èƒ½å¯¼è‡´ä¸Šå±‚æœåŠ¡çš„é‡è¯•ï¼‰</li>
</ul>

<h3 id="heading-è¯´æ˜-1">è¯´æ˜</h3>

<p>é—¨é¢çš„æ¥å£æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨æ ¸å¿ƒæœåŠ¡æä¾›çš„æ¥å£ï¼Œ é—¨é¢çš„æ¥å£å®ç°ä¸Šå¯ä»¥æœ€å¯¹ä¸åŒè°ƒç”¨æ–¹ç‹¬ç‰¹çš„é€»è¾‘ï¼Œä½†ä¸è¦å†—ä½™å…¬å…±é€»è¾‘ï¼Œå…¬å…±é€»è¾‘åº”è¯¥æŠ½è±¡åˆ°æ ¸å¿ƒå±‚ã€‚</p>

<h2 id="heading-ä»£ç æ€ä¹ˆå†™">ä»£ç æ€ä¹ˆå†™</h2>

<h3 id="heading-è¯´åœ¨å‰é¢">è¯´åœ¨å‰é¢</h3>

<p>ä¸‹é¢ä»£ç å’Œç»“æ„çº¯å±ä¸ªäººè§è§£ï¼Œå¹¶ä¸ä¿è¯æœ€ä¼˜ç»“æ„ï¼Œå¯ä»¥æ¢è®¨ã€‚</p>

<h3 id="heading-ä»£ç ç»“æ„">ä»£ç ç»“æ„</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shop-base
+-- shop-base-inner
	+-- dao
	+-- util
	+-- event
	+-- service
+-- shop-base-api
	+-- facade.api
	     +-- facadeApi1.java
	     +-- facadeApi2.java 
    +-- core.api
	    +-- coreApi1.java
	    +-- coreApi2.java
+-- shop-base-impl
	+-- impl.facade
		+-- facadeApi1Impl.java
		+-- facadeApi2Impl.java
	+-- impl.core
		+-- coreApi1Impl.java
		+-- coreApi2Impl.java
	+-- transformers
	+-- publishers
	+-- validators
	+-- utils
	
</code></pre></div></div>

<h3 id="heading-ä¸Šä»£ç java">ä¸Šä»£ç ï¼ˆJAVAï¼‰</h3>

<h4 id="heading-é—¨é¢æ¥å£">é—¨é¢æ¥å£</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShopInfoForLpdBalanceFacadeSoaServiceImpl</span> <span class="kd">implements</span> <span class="nc">ShopInfoForLpdBalanceFacadeSoaService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="c1">// æ ¸å¿ƒæ¥å£</span>
    <span class="kd">private</span> <span class="nc">ShopInfoSoaServiceImpl</span> <span class="n">shopInfoSoaService</span><span class="o">;</span>

    <span class="cm">/**
     * å…³åº—å¹¶ä¸Šé”
     * @param shopId åº—é“ºid
     * @param blockShop æ˜¯å¦é”åº—
     * @param busyLevel è¥ä¸šçŠ¶æ€
     * @param userId æ“ä½œäººid
     * @param remark å¤‡æ³¨
     * @param sourceDTO æ¥æº
     * @throws ServiceException ä¸šåŠ¡å¼‚å¸¸
     **/</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeAndLockShop</span><span class="o">(</span><span class="kt">long</span> <span class="n">shopId</span><span class="o">,</span> <span class="nc">Boolean</span> <span class="n">blockShop</span><span class="o">,</span> <span class="nc">BusyLevelDTO</span> <span class="n">busyLevel</span><span class="o">,</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">remark</span><span class="o">,</span> <span class="nc">UpdateSourceDTO</span> <span class="n">sourceDTO</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span> <span class="o">{</span>
        <span class="nc">ShopDTO</span> <span class="n">shopDTO</span> <span class="o">=</span> <span class="n">shopInfoSoaService</span><span class="o">.</span><span class="na">getBindMaster</span><span class="o">(</span><span class="n">shopId</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">shopDTO</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="nc">MyExceptionFactory</span><span class="o">.</span><span class="na">instance</span><span class="o">(</span><span class="nc">ErrorCode</span><span class="o">.</span><span class="na">RESTAURANT_NOT_FOUND</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">blockShop</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">busyLevel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// ..... çœç•¥å°†å‚æ•°å¦‚ä½•è½¬æ¢ä¸ºæ ¸å¿ƒæ¥å£éœ€è¦å‚æ•°çš„ä»£ç </span>
        
        <span class="c1">// è°ƒç”¨æ ¸å¿ƒæ¥å£</span>
        <span class="n">shopInfoSoaService</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">shopId</span><span class="o">,</span> <span class="n">shopUpdateDTO</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">remark</span><span class="o">,</span> <span class="n">sourceDTO</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å¯¹åº”ä¸Šé¢çš„å›¾ï¼Œé—¨é¢æ¥å£å¯¹å¤–æš´éœ²çš„æ¥å…¥æ–¹æ–¹ä¾¿è¯†åˆ«çš„å®šä¹‰ï¼Œè€Œä¸æ˜¯é¢†åŸŸå†…çš„å®šä¹‰ï¼Œæ‰€ä»¥æ¥å£ä½¿ç”¨æ–¹åªéœ€è¦å…³æ³¨å®ƒæƒ³åšçš„äº‹æƒ…å³å¯ï¼Œä¸éœ€è¦è¿‡åº¦ç†è§£å…·ä½“é¢†åŸŸå†…çš„ä¸œè¥¿</p>

<h4 id="heading-æ ¸å¿ƒæ¥å£">æ ¸å¿ƒæ¥å£</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ShopInfoSoaService</span> <span class="o">{</span>

    <span class="cm">/**
     * æŸ¥è¯¢åº—é“ºä¿¡æ¯
     * @param shopId åº—é“ºid
     * @return åº—é“ºä¿¡æ¯ æœªæŸ¥åˆ°è¿”å›null
     */</span>
    <span class="nc">ShopDTO</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">shopId</span><span class="o">);</span>

    <span class="cm">/**
     * æ‰¹é‡æŸ¥è¯¢åº—é“ºä¿¡æ¯
     * @param shopIds åº—é“ºidåˆ—è¡¨
     * @return åº—é“ºid:åº—é“ºä¿¡æ¯ åº—é“ºä¿¡æ¯æœªæŸ¥åˆ°ï¼Œè¿”å›null
     */</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">ShopDTO</span><span class="o">&gt;</span> <span class="nf">batchGet</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">shopIds</span><span class="o">);</span>

    <span class="cm">/**
     * Replaceåº—é“ºä¿¡æ¯
     *
     * &lt;p&gt;å°†åº—é“ºä¿¡æ¯æŒ‰ç…§updateDTOè¿›è¡ŒReplaceï¼Œå¦‚æœupdateDTOå±æ€§ä¸ºnull,åˆ™èµ‹äºˆé»˜è®¤å€¼&lt;/p&gt;
     *
     * @param shopId åº—é“ºid
     * @param updateDTO æœ€æ–°ä¿¡æ¯
     * @param userId ç”¨æˆ·id
     * @param remark å¤‡æ³¨
     * @param source æ›´æ–°æ¥æº
     * @return æ›´æ–°ä¹‹åçš„åº—é“ºä¿¡æ¯
     * @throws ServiceException ä¸šåŠ¡å¼‚å¸¸
     */</span>
    <span class="nc">ShopDTO</span> <span class="nf">replace</span><span class="o">(</span><span class="kt">long</span> <span class="n">shopId</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">ShopUpdateDTO</span> <span class="n">updateDTO</span><span class="o">,</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">String</span> <span class="n">remark</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">UpdateSourceDTO</span> <span class="n">source</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span><span class="o">;</span>

    <span class="cm">/**
     * Replaceåº—é“ºä¿¡æ¯
     *
     * &lt;p&gt;å°†åº—é“ºä¿¡æ¯æŒ‰ç…§updateDTOè¿›è¡ŒUpdateï¼Œå¦‚æœupdateDTOå±æ€§ä¸ºnull,åˆ™ä¸æ›´æ–°&lt;/p&gt;
     *
     * @param shopId åº—é“ºid
     * @param updateDTO æœ€æ–°ä¿¡æ¯
     * @param userId ç”¨æˆ·id
     * @param remark å¤‡æ³¨
     * @param source æ›´æ–°æ¥æº
     * @return æ›´æ–°ä¹‹åçš„åº—é“ºä¿¡æ¯
     * @throws ServiceException ä¸šåŠ¡å¼‚å¸¸
     */</span>
    <span class="nc">ShopDTO</span> <span class="nf">update</span><span class="o">(</span><span class="kt">long</span> <span class="n">shopId</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">ShopUpdateDTO</span> <span class="n">updateDTO</span><span class="o">,</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">String</span> <span class="n">remark</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">UpdateSourceDTO</span> <span class="n">source</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="heading-replaceå’Œupdateä¹‹äº‰">Replaceå’ŒUpdateä¹‹äº‰</h4>

<p>æ˜¯å¦éœ€è¦Replaceæ¥å£è¦çœ‹æœåŠ¡çš„ä¸šåŠ¡ï¼Œ ä¸€èˆ¬ä¸šåŠ¡ä¸­æ ¹æœ¬ä¸æ¶‰åŠåˆ°Replaceï¼Œä¹Ÿä¸å»ºè®®åœ¨æœåŠ¡æä¾›Replaceæ¥å£ï¼Œä¸€èˆ¬åªéœ€è¦ [ADDï¼Œ UPDATEï¼ŒDELETEï¼ŒSELECT,   BATCH_SELECT]</p>

<h4 id="heading-updateæ¥å£ä»£ç ">UPDATEæ¥å£ä»£ç </h4>

<p>æŸ¥è¯¢æ¥å£å°±æ²¡æœ‰ä»€ä¹ˆå¯è¯´çš„äº†ï¼Œ ä¸»è¦æ˜¯çœ‹æ›´æ–°æ¥å£</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">ShopDTO</span> <span class="nf">update</span><span class="o">(</span><span class="kt">long</span> <span class="n">shopId</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">ShopUpdateDTO</span> <span class="n">updateDTO</span><span class="o">,</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">String</span> <span class="n">remark</span><span class="o">,</span> <span class="nd">@NotNull</span> <span class="nc">UpdateSourceDTO</span> <span class="n">source</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span> <span class="o">{</span>
    <span class="nc">PShopInfo</span> <span class="n">oldInfo</span> <span class="o">=</span> <span class="n">shopInfoService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">shopId</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oldInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="nc">MyExceptionFactory</span><span class="o">.</span><span class="na">instance</span><span class="o">(</span><span class="nc">ErrorCode</span><span class="o">.</span><span class="na">INVALID_PARAMETERS</span><span class="o">,</span> <span class="s">"åº—é“ºä¿¡æ¯ä¸å­˜åœ¨"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">updateDTO</span><span class="o">.</span><span class="na">setShopId</span><span class="o">(</span><span class="n">shopId</span><span class="o">);</span>

    <span class="c1">// shopInfoService å°±æ˜¯PO Service</span>
    <span class="c1">// shopInfoService.setForUpdate æ˜¯å°†OldShopInfo å’Œ updateDTOç»“åˆç»„è£…æˆæœ€ç»ˆæ›´æ–°åˆ°DBä¸­çš„newShopInfo</span>
    <span class="nc">PShopInfo</span> <span class="n">newInfo</span> <span class="o">=</span> <span class="n">shopInfoService</span><span class="o">.</span><span class="na">setForUpdate</span><span class="o">(</span><span class="n">shopId</span><span class="o">,</span> <span class="n">oldInfo</span><span class="o">,</span> <span class="n">shopInfoTransformer</span><span class="o">.</span><span class="na">transformShopInfoPO</span><span class="o">(</span><span class="n">updateDTO</span><span class="o">));</span>

    <span class="c1">// Validator è¿›è¡Œç»Ÿç­¹æ ¡éªŒå™¨ï¼Œå¯¹åº—é“ºä¿¡æ¯è¿›è¡Œæ ¡éªŒï¼Œä¼ å…¥userId, oldInfo, newInfo æ˜¯å› ä¸ºæœ‰äº›æ ¡éªŒå™¨å¯èƒ½å¯¹æ•°å€¼çš„å˜åŒ–æ ¡éªŒï¼Œæ¯”å¦‚æŸäº›å±æ€§å˜åŒ–ä¸èƒ½è¶…è¿‡ä¸€ä¸ªèŒƒå›´</span>
    <span class="c1">// Validator.of æ“ä½œæ˜¯æ³¨å†Œæ ¡éªŒå™¨</span>
    <span class="c1">// shopInfoValidator å°±æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ ¡éªŒå™¨</span>
    <span class="c1">// Validator.validates æ˜¯ç”¨æ‰€æœ‰æ³¨å†Œçš„æ ¡éªŒå™¨å¼€å§‹è¿›è¡Œæ ¡éªŒ</span>
    <span class="nc">Validator</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">shopInfoValidator</span><span class="o">).</span><span class="na">validates</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">oldInfo</span><span class="o">,</span> <span class="n">newInfo</span><span class="o">);</span>

    <span class="c1">// æ ¡éªŒé€šè¿‡åè¿›è¡Œæ›´æ–°</span>
    <span class="n">newInfo</span> <span class="o">=</span> <span class="n">shopInfoService</span><span class="o">.</span><span class="na">createOrUpdate</span><span class="o">(</span><span class="n">shopId</span><span class="o">,</span> <span class="n">oldInfo</span><span class="o">,</span> <span class="n">newInfo</span><span class="o">);</span>

    <span class="c1">// æ›´æ–°æˆåŠŸåå¼€å§‹å¤„ç†åäº‹</span>
    <span class="c1">// Publisher æ˜¯ç”¨æ¥ç›‘å¬è€…æ¨¡å¼</span>
    <span class="c1">// Publisher.subscribe æ³¨å†Œç›‘å¬è€…</span>
    <span class="c1">// Publisher.publish å°†äº‹ä»¶é€šçŸ¥æ‰€æœ‰ç›‘å¬è€…</span>
    <span class="nc">Publisher</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">changeRecordSubscriber</span><span class="o">,</span> <span class="n">shopInfoChangeMessageNoticeSubscriber</span><span class="o">,</span> <span class="n">syncAggregateSubscriber</span><span class="o">)</span>
        <span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="nc">ShopInfoEvent</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">oldInfo</span><span class="o">,</span> <span class="n">newInfo</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">enumTransformer</span><span class="o">.</span><span class="na">transformUpdateSourcePO</span><span class="o">(</span><span class="n">source</span><span class="o">),</span> <span class="n">remark</span><span class="o">));</span>

    <span class="c1">// è¿”å›æ›´æ–°åçš„æœ€æ–°å€¼</span>
    <span class="k">return</span> <span class="n">shopInfoTransformer</span><span class="o">.</span><span class="na">transformShopInfoDTO</span><span class="o">(</span><span class="n">newInfo</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ ¹æ®ä¹‹å‰çš„åŸºç¡€æœåŠ¡èƒ½åŠ›updateæ¥å£å¯ä»¥åˆ’åˆ†ä¸ºä¸‰æ®µ</p>

<ul>
  <li>æ‰§è¡Œå‰æ ¡éªŒæ®µ <code class="language-plaintext highlighter-rouge">Validator.of(shopInfoValidator).validates(userId, oldInfo, newInfo);</code> è¿™æ ·å†™çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœå¢åŠ ä¸€ä¸ªæ ¡éªŒè€…ï¼Œåªéœ€è¦åœ¨ofé‡Œé¢æ’å…¥å³å¯</li>
  <li>æ‰§è¡Œæ®µ <code class="language-plaintext highlighter-rouge">shopInfoService.createOrUpdate(shopId, oldInfo, newInfo);</code></li>
  <li>æ‰§è¡Œåé€šçŸ¥æ®µ <code class="language-plaintext highlighter-rouge">Publisher.subscribe(changeRecordSubscriber, shopInfoChangeMessageNoticeSubscriber)
      .publish(ShopInfoEvent.of(oldInfo, newInfo, userId, enumTransformer.transformUpdateSourcePO(source), remark));</code> è¿™æ®µä»£ç é‡Œé¢é€šçŸ¥äº†ä¸¤ä¸ªç›‘å¬è€…ï¼Œä¸€ä¸ªç”¨æ¥å‘æ¶ˆæ¯ï¼Œä¸€ä¸ªç”¨æ¥è®°å½•å˜æ›´æ—¥å¿—ã€‚</li>
</ul>

<h4 id="heading-validator">Validator</h4>

<h5 id="heading-ç»Ÿç­¹æ ¡éªŒå™¨validator">ç»Ÿç­¹æ ¡éªŒå™¨Validator</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Validator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ValidatorContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">validators</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Validator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">of</span><span class="o">(</span><span class="nc">ValidatorContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Validator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Validator</span><span class="o">(</span><span class="nc">ValidatorContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">validators</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validates</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="no">T</span> <span class="n">origin</span><span class="o">,</span> <span class="no">T</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ValidatorContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">validatorContext</span> <span class="o">:</span> <span class="n">validators</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">validatorContext</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">origin</span><span class="o">,</span> <span class="n">target</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h5 id="heading-å…·ä½“çš„ä¸€ä¸ªæ ¡éªŒå™¨shopinfovalidator">å…·ä½“çš„ä¸€ä¸ªæ ¡éªŒå™¨ShopInfoValidator</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShopInfoValidator</span> <span class="kd">implements</span> <span class="nc">ValidatorContext</span><span class="o">&lt;</span><span class="nc">PShopInfo</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">PShopInfo</span> <span class="n">origin</span><span class="o">,</span> <span class="nc">PShopInfo</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="nc">MyExceptionFactory</span><span class="o">.</span><span class="na">instance</span><span class="o">(</span><span class="nc">ErrorCode</span><span class="o">.</span><span class="na">INVALID_PARAMETERS</span><span class="o">,</span> <span class="s">"æ›´æ–°å†…å®¹ä¸èƒ½ä¸ºNULL"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Long</span> <span class="n">shopId</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getShopId</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">shopId</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">shopId</span> <span class="o">&lt;=</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="nc">MyExceptionFactory</span><span class="o">.</span><span class="na">instance</span><span class="o">(</span><span class="nc">ErrorCode</span><span class="o">.</span><span class="na">INVALID_PARAMETERS</span><span class="o">,</span> <span class="s">"åº—é“ºIDä¸åˆæ³•"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="heading-publisher">Publisher</h4>

<h5 id="heading-ç›‘å¬è€…ç»Ÿç­¹å™¨publisher">ç›‘å¬è€…ç»Ÿç­¹å™¨Publisher</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Publisher</span><span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">BaseEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Subscriber</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">subscribers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">BaseEvent</span><span class="o">&gt;</span> <span class="nc">Publisher</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">subscribe</span><span class="o">(</span><span class="nc">Subscriber</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">Publisher</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;();</span>
        <span class="o">}</span>

        <span class="nc">Publisher</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Publisher</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">subscribers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">publish</span><span class="o">(</span><span class="no">T</span> <span class="n">event</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Subscriber</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">subscriber</span> <span class="o">:</span> <span class="n">subscribers</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">subscriber</span><span class="o">.</span><span class="na">consumer</span><span class="o">(</span><span class="n">event</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="heading-åŸºæœ¬äº‹ä»¶æ ¼å¼-baseevent">åŸºæœ¬äº‹ä»¶æ ¼å¼ BaseEvent</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">abstract</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseEvent</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">shopId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>

    <span class="kd">private</span> <span class="no">T</span> <span class="n">origin</span><span class="o">;</span>

    <span class="kd">private</span> <span class="no">T</span> <span class="n">target</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">remark</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">PUpdateSource</span> <span class="n">source</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">occurredTime</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">POperateType</span> <span class="nf">operateType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">origin</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">POperateType</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">origin</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">POperateType</span><span class="o">.</span><span class="na">CREATE</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">origin</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">POperateType</span><span class="o">.</span><span class="na">REMOVE</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">diff</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">origin</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">POperateType</span><span class="o">.</span><span class="na">UPDATE</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nc">POperateType</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Data</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PEventContext</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">String</span> <span class="n">requestId</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nc">String</span> <span class="n">appId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="nc">POperateType</span> <span class="o">{</span>
        <span class="no">CREATE</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span>
        <span class="no">UPDATE</span><span class="o">(</span><span class="mi">200</span><span class="o">),</span>
        <span class="no">REMOVE</span><span class="o">(</span><span class="mi">300</span><span class="o">),</span>
        <span class="no">NORMAL</span><span class="o">(</span><span class="mi">400</span><span class="o">),</span>
        <span class="o">;</span>

        <span class="nd">@Getter</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@AllArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="nc">PUpdateSource</span> <span class="o">{</span>
        <span class="no">SOURCE1</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span>
        <span class="no">SOURCE2</span><span class="o">(</span><span class="mi">200</span><span class="o">),</span>
        <span class="o">;</span>
        <span class="nd">@Getter</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h5 id="heading-åº—é“ºå…·è±¡äº‹ä»¶æè¿°-shopinfoevent">åº—é“ºå…·è±¡äº‹ä»¶æè¿° ShopInfoEvent</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShopInfoEvent</span> <span class="kd">extends</span> <span class="nc">BaseEvent</span><span class="o">&lt;</span><span class="nc">PShopInfo</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ShopInfoEvent</span> <span class="nf">of</span><span class="o">(</span><span class="nc">PShopInfo</span> <span class="n">oldShopInfo</span><span class="o">,</span> <span class="nc">PShopInfo</span> <span class="n">newShopInfo</span><span class="o">,</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">PUpdateSource</span> <span class="n">source</span><span class="o">,</span> <span class="nc">String</span> <span class="n">remark</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">shopId</span> <span class="o">=</span> <span class="n">oldShopInfo</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">newShopInfo</span><span class="o">.</span><span class="na">getShopId</span><span class="o">()</span> <span class="o">:</span> <span class="n">oldShopInfo</span><span class="o">.</span><span class="na">getShopId</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">version</span> <span class="o">=</span> <span class="n">newShopInfo</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">oldShopInfo</span><span class="o">.</span><span class="na">version</span><span class="o">()</span> <span class="o">:</span> <span class="n">newShopInfo</span><span class="o">.</span><span class="na">version</span><span class="o">();</span>

        <span class="nc">LocalDateTime</span> <span class="n">occurredTime</span> <span class="o">=</span> <span class="n">newShopInfo</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">oldShopInfo</span><span class="o">.</span><span class="na">getUpdatedAt</span><span class="o">()</span> <span class="o">:</span> <span class="n">newShopInfo</span><span class="o">.</span><span class="na">getUpdatedAt</span><span class="o">();</span>

        <span class="nc">ShopInfoEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShopInfoEvent</span><span class="o">();</span>

        <span class="n">event</span><span class="o">.</span><span class="na">setShopId</span><span class="o">(</span><span class="n">shopId</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setOrigin</span><span class="o">(</span><span class="n">oldShopInfo</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setTarget</span><span class="o">(</span><span class="n">newShopInfo</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="n">remark</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setOccurredTime</span><span class="o">(</span><span class="n">occurredTime</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">event</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>#####å˜æ›´æ¶ˆæ¯é€šçŸ¥ç›‘å¬è€… ChangeMessageNoticeSubscriber ï¼ˆå…·ä½“çš„ä¸€ä¸ªç›‘å¬è€…ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChangeMessageNoticeSubscriber</span> <span class="kd">implements</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">ShopInfoEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="c1">// è´Ÿè´£å‘é€MQçš„å·¥å…·ç±»å°è£…</span>
    <span class="nc">ShopMessageProducer</span> <span class="n">shopMessageProducer</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="c1">// POåˆ°DTOçš„å¯¹è±¡è½¬æ¢</span>
    <span class="nc">ShopInfoTransformer</span> <span class="n">shopInfoTransformer</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="c1">// POåˆ°DTOçš„æšä¸¾è½¬æ¢</span>
    <span class="nc">EnumTransformer</span> <span class="n">enumTransformer</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">consumer</span><span class="o">(</span><span class="nc">ShopInfoEvent</span> <span class="n">event</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServiceException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">PShopInfo</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getOrigin</span><span class="o">();</span>
        <span class="nc">PShopInfo</span> <span class="n">target</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getTarget</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">diff</span><span class="o">(</span><span class="n">origin</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">sendShopInfoMessage</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">origin</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendShopInfoMessage</span><span class="o">(</span><span class="nc">ShopInfoEvent</span> <span class="n">event</span><span class="o">,</span> <span class="nc">PShopInfo</span> <span class="n">origin</span><span class="o">,</span> <span class="nc">PShopInfo</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ShopMessageDTO</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShopMessageDTO</span><span class="o">();</span>

        <span class="n">message</span><span class="o">.</span><span class="na">setShopId</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getShopId</span><span class="o">());</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getVersion</span><span class="o">());</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setOccurredTime</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getOccurredTime</span><span class="o">());</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getRemark</span><span class="o">());</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">enumTransformer</span><span class="o">.</span><span class="na">transformUpdateSourceDTO</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getSource</span><span class="o">()));</span>

        <span class="n">message</span><span class="o">.</span><span class="na">setOrigin</span><span class="o">(</span><span class="n">shopInfoTransformer</span><span class="o">.</span><span class="na">transformShopInfoDTO</span><span class="o">(</span><span class="n">origin</span><span class="o">));</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setTarget</span><span class="o">(</span><span class="n">shopInfoTransformer</span><span class="o">.</span><span class="na">transformShopInfoDTO</span><span class="o">(</span><span class="n">target</span><span class="o">));</span>

		<span class="c1">// å‘é€mqçš„æ¶ˆæ¯ï¼Œ messageæ˜¯æ¶ˆæ¯ä½“</span>
        <span class="n">shopMessageProducer</span><span class="o">.</span><span class="na">sendShopInfoMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç›‘å¬è€…å¯ä»¥å¾ˆå®¹æ˜“çš„æ‰©å±•ï¼Œä¹Ÿå¯ä»¥æ ¹æ®æ•°æ®åšå¾ˆå¤šäº‹æƒ…ï¼Œ æ¯”å¦‚æœåŠ¡ç¼“å­˜çš„åˆ·æ–°ç­‰</p>

<h3 id="heading-è¯´åœ¨åé¢">è¯´åœ¨åé¢</h3>

<p>ä¸Šé¢çš„ä»£ç æ ¼å¼æ˜¯æˆ‘ä»¬å…¶ä¸­ä¸€ä¸ªåº•å±‚æœåŠ¡ä¸­æå–å‡ºæ¥çš„ï¼Œ æ©ç›–/åˆ é™¤äº†ä¸€äº›å…·ä½“ä¸šåŠ¡ç›¸å…³çš„ï¼Œ ä½†ç»“æ„ä¸€è‡´ï¼Œå†™tpsåœ¨å‡ kå·¦å³ï¼Œä»£ç æ‰©å±•è¾ƒå®¹æ˜“ï¼Œè¿˜æœ‰ä¸€äº›è®¾è®¡ä¸Šçš„ç»†èŠ‚å¹¶æ²¡æœ‰å†™å‡ºæ¥ã€‚</p>

<h2 id="heading-æ€»ç»“">æ€»ç»“</h2>

<p>è¿™ç§ç»“æ„çº¯å±æœ¬äººä¸ªäººè§è§£ï¼Œ æ˜¯ç»“åˆè¿‘ä¸¤å¹´å·¥ä½œç»éªŒæ€»ç»“å‡ºæ¥çš„ã€‚ ä¸ªäººè®¤ä¸ºä»£ç ç»“æ„è¦ç»“åˆå®é™…èƒŒæ™¯è¯´æ‰ä¼šæ›´åŠ æœ‰æ„ä¹‰ï¼Œä¸šåŠ¡ä¸åŒï¼Œæ‰€è®¾è®¡å‡ºå¾—æœåŠ¡æ¶æ„å’Œä»£ç ç»“æ„ä¹Ÿä¸å°½ç›¸åŒã€‚æ¯”å¦‚å•†å“å’Œåº—é“ºçš„ä¸šåŠ¡åœºæ™¯å°±ä¸ä¸€æ ·ï¼Œ å•†å“æ•°æ®é‡æ˜¯æŒ‘æˆ˜ï¼Œå‡ äº¿ï¼Œå‡ åäº¿çš„å•†å“æ•°æ®é‡ã€‚ åº—é“ºçš„æŒ‘æˆ˜æ˜¯qpså’Œæ‰©å±•ä¸Šï¼Œæˆ‘ä»¬åº—é“ºæ ¸å¿ƒæœåŠ¡çš„qpsé«˜å³°æœŸæœ‰200kå·¦å³ï¼Œ æ¯ä¸ªæœˆéƒ½è¢«è¦æ±‚æœ‰å‡ ä¸ªç”šè‡³å‡ åä¸ªå±æ€§/æ ‡ç­¾éœ€è¦æ‰©å±•ï¼Œè€Œä¸”åœ¨å¯é¢„è§çš„æœªæ¥ï¼Œå°†ä¼šæ›´æœ‰ç”šï¼ˆæ‰©å±•æ€§å’ŒQPSä¸Šåé¢ä¼šæœ‰æ–‡ç« æ›´è¯¦ç»†çš„æè¿°ï¼‰ï¼Œæ‰€ä»¥åº—é“ºå’Œå•†å“çš„æœåŠ¡è®¾è®¡æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚</p>

<p><strong>åŸºç¡€æœåŠ¡çš„ä»£ç ä½ è®¤ä¸ºåº”è¯¥æ€ä¹ˆå†™ï¼Ÿ</strong> å¯ä»¥è¯´å‡ºä½ çš„è§è§£ï¼Œ è®¨è®ºæ— è¾¹ç•Œï¼Œè®¾è®¡æ— æœ€å¥½ã€‚</p>
:ET