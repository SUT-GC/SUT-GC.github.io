I"Ñ|<ul class="toc" id="markdown-toc">
  <li><a href="#heading-ç®€å•çš„æœåŠ¡é‡è¯•é™çº§æ¶å­" id="markdown-toc-heading-ç®€å•çš„æœåŠ¡é‡è¯•é™çº§æ¶å­">ç®€å•çš„æœåŠ¡é‡è¯•é™çº§æ¶å­</a>    <ul>
      <li><a href="#heading-èƒŒæ™¯" id="markdown-toc-heading-èƒŒæ™¯">èƒŒæ™¯</a></li>
      <li><a href="#heading-é—®é¢˜" id="markdown-toc-heading-é—®é¢˜">é—®é¢˜</a></li>
      <li><a href="#heading-åŠæ³•" id="markdown-toc-heading-åŠæ³•">åŠæ³•</a></li>
      <li><a href="#heading-ä½¿ç”¨å§¿åŠ¿" id="markdown-toc-heading-ä½¿ç”¨å§¿åŠ¿">ä½¿ç”¨å§¿åŠ¿</a>        <ul>
          <li><a href="#heading-callandfallback" id="markdown-toc-heading-callandfallback">callAndFallBack</a></li>
          <li><a href="#heading-call" id="markdown-toc-heading-call">call</a></li>
          <li><a href="#heading-callnotcoverserviceexception" id="markdown-toc-heading-callnotcoverserviceexception">callNotCoverServiceException</a></li>
          <li><a href="#heading-callnotcoverserviceexceptionandfallback" id="markdown-toc-heading-callnotcoverserviceexceptionandfallback">callNotCoverServiceExceptionAndFallBack</a></li>
        </ul>
      </li>
      <li><a href="#heading-æºç " id="markdown-toc-heading-æºç ">æºç </a>        <ul>
          <li><a href="#heading-callserviceinterfacecontext" id="markdown-toc-heading-callserviceinterfacecontext">CallServiceInterfaceContext</a></li>
          <li><a href="#heading-callservicewrapper" id="markdown-toc-heading-callservicewrapper">CallServiceWrapper</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="heading-ç®€å•çš„æœåŠ¡é‡è¯•é™çº§æ¶å­">ç®€å•çš„æœåŠ¡é‡è¯•é™çº§æ¶å­</h1>

<h2 id="heading-èƒŒæ™¯">èƒŒæ™¯</h2>

<p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œè¿™ç§ <code class="language-plaintext highlighter-rouge">A --è°ƒç”¨--&gt; B</code> çš„æœåŠ¡è°ƒç”¨é“¾è·¯å†å¸¸è§ä¸è¿‡ã€‚ å½“ <code class="language-plaintext highlighter-rouge">A</code> æœåŠ¡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">B</code> æœåŠ¡çš„æ—¶å€™ç»å¸¸ç”±äºä¸€äº›åŸå› ï¼ˆæ¯”å¦‚BæœåŠ¡å¼‚å¸¸å®•æœºç­‰ï¼‰å¯¼è‡´<code class="language-plaintext highlighter-rouge">B</code>æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚ è€Œä¸ºäº†ä¿æŠ¤<code class="language-plaintext highlighter-rouge">A</code>æœåŠ¡ï¼Œé¿å…å‘ç”Ÿå¤§è§„æ¨¡â€œé›ªå´©â€ã€â€œè¿é”ååº”â€ç­‰é—®é¢˜ï¼ŒåŸºæœ¬çš„SOAæ¡†æ¶ï¼ˆspring cloudã€dubboã€pylonï¼‰ç­‰éƒ½ä¼šæä¾› å¿ƒè·³æ£€æŸ¥ã€ç†”æ–­(åˆ†ä¸ºå®¢æˆ·ç«¯ç†”æ–­ or æœåŠ¡ç«¯ç†”æ–­)ã€é™çº§(pylonè²Œä¼¼åªæœ‰æœåŠ¡ç«¯é™çº§)ã€‚ä½†æ˜¯è¿™äº›æ¡†æ¶ä¸ºäº†æ›´å¥½çš„é€‚ç”¨ä¸æ‰€æœ‰ç»å¤§å¤šæ•°åœºæ™¯ï¼Œæ‰€ä»¥ä¼šç›¸åº”çš„æ‘’å¼ƒä¸€äº›ä¸é€šç”¨çš„ä¸œè¥¿ã€‚</p>

<h2 id="heading-é—®é¢˜">é—®é¢˜</h2>

<p>å½“ <code class="language-plaintext highlighter-rouge">A</code>æœåŠ¡è°ƒç”¨<code class="language-plaintext highlighter-rouge">B</code>æœåŠ¡ï¼Œä¸èƒ½ä¿è¯<code class="language-plaintext highlighter-rouge">B</code>æœåŠ¡100%å¯ç”¨ï¼Œ ä¹Ÿä¸èƒ½ä¿è¯åˆ°<code class="language-plaintext highlighter-rouge">B</code>çš„ç½‘ç»œ100%å¯è¾¾ï¼Œæ‹¿<code class="language-plaintext highlighter-rouge">shop.core_service</code>è¿™ä¸ªæœåŠ¡ä¸¾ä¾‹ï¼Œè°ƒç”¨è¥é”€æŸ¥è¯¢é…é€è¡¥è´´çš„æ¥å£ QPS åœ¨é«˜å³°æœŸå°†è¿‘30Kï¼Œå¹³å‡ç›¸åº”æ—¶é—´åœ¨10msä»¥å†…</p>

<p><img src="/files/images/retry-1.png" alt="t" /></p>

<p><img src="/files/images/retry-2.png" alt="t" /></p>

<p>ä½†æ˜¯åœ¨è¿™30Kçš„è°ƒç”¨é‡Œé¢ï¼Œå­˜åœ¨300å†…çš„ timeout è¯·æ±‚ï¼ˆå®¢æˆ·ç«¯é™åˆ¶æœåŠ¡ç«¯ç›¸åº”æ—¶é—´ä¸èƒ½è¶…è¿‡300msï¼Œè¶…è¿‡å³è¶…æ—¶ï¼‰ï¼Œçœ‹ä¸‹æœ€å¤§å“åº”æ—¶é—´ å‘ç°æœ€å¤§å€¼ä¸º5.322sã€‚</p>

<p>è¿™ä¸ªæ¥å£çš„å½±å“æ˜¯ï¼šå¦‚æœä¸€æ¬¡è°ƒç”¨è¶…æ—¶ï¼Œä¾¿å¯èƒ½é€ æˆç”¨æˆ·ä¸‹çš„è¿™ä¸€å•ä¸äº«å—å•†å®¶è®¾ç½®çš„é…é€è´¹è¡¥è´´ï¼ˆå‰ææ˜¯ä¸‹å•é¡µé¢è°ƒç”¨è¿™ä¸ªæ¥å£ä¸”è¿™å®¶åº—åœ¨æ­¤æ—¶æœ‰å•†å®¶è¡¥è´´æ´»åŠ¨ï¼‰ã€‚  è¿™ç§æŸå¤±æ— è®ºå‘ç”Ÿåœ¨å“ªä½ç”¨æˆ·ä¸Šéƒ½ä¼šé€ æˆä¸è‰¯ä½“éªŒã€‚</p>

<blockquote>
  <p>å‰ä¸¤å¤©å¬åˆ°ä¸ªæœ‰è¶£çš„æ•…äº‹ä¹Ÿåˆ†äº«ä¸‹ï¼šä¸€ä¸ªåˆ¶é€ å†›ç”¨é™è½ä¼çš„å…¬å¸ï¼Œåˆ¶é€ å·¥è‰ºéå¸¸ç²¾ç»†ï¼Œæ£€æŸ¥åˆ¶åº¦éå¸¸ä¸¥æ ¼ï¼Œå·²ç»å°†æ ‡å“çš„åˆæ ¼ç‡æé«˜åˆ°äº†99.99%ï¼Œå‡ ä¹æ— æ³•å†æ¬¡æé«˜ã€‚ å†›æ–¹è·Ÿé™è½ä¼å…¬å¸çš„CEOè¯´ï¼šâ€œæˆ‘çŸ¥é“ä½ ä»¬99.99%çš„åˆæ ¼ç‡å·²ç»éå¸¸é«˜äº†ï¼Œä½†æ˜¯è¿™ä¹Ÿå°±è¯´æ˜æˆ‘ä»¬10000ä¸ªå°†å£«è·³ä¼ï¼Œå°±ä¼šæœ‰1ä¸ªå°†å£«ç‰ºç‰²ï¼Œè¿™ä¸ªä»£ä»·æ˜¯å¾ˆä¸¥é‡çš„â€ã€‚CEOæ‘‡äº†æ‘‡å¤´ï¼šâ€œsorry siræˆ‘ä»¬å·²ç»è¿‘äº†æœ€å¤§çš„åŠªåŠ›ï¼ä½ è¦ç†è§£æˆ‘ä»¬ï¼Œå†å·¥è‰ºä¸­å‡ºç°ä¸ç‚¹åå·®éƒ½ä¼šé€ æˆé™è½ä¼ä¸åˆæ ¼ï¼Œ99.99%å·²ç»æ˜¯ä¸–ç•Œä¸Šæœ€é«˜çš„åˆæ ¼ç‡äº†ï¼ŒçœŸçš„æ²¡æœ‰åŠæ³•å†æé«˜äº†â€ã€‚å°†å†›æƒ³äº†æƒ³ï¼Œå¹äº†å£æ°”è¯´ï¼šâ€œå“ï¼Œå¥½å§ï¼Œæˆ‘ä¹Ÿç†è§£ä½ ä»¬ï¼Œä»¥åçš„é‡‡è´­åˆåŒè¿˜ä¼šè·Ÿä½ ä»¬ç»§ç»­ä¿æŒï¼Œä¸è¿‡æˆ‘è¦åœ¨åˆåŒä¸ŠåŠ ä¸€æ¡ï¼Œæ¯æ¬¡ä½ ä»¬å…¬å¸äº¤è´§çš„æ—¶å€™éƒ½è¦ä»è¿™æ‰¹è´§ä¸­éšæœºæŒ‘é€‰å‡º10ä¸ªé™è½ä¼æ¥ï¼Œè®©top10çš„é«˜ç®¡äº²è‡ªè·³ä¼éªŒæ”¶ä¸‹ï¼Œç„¶åæˆ‘ä»¬å†æ”¶è¿™æ‰¹è´§â€ã€‚ç»“æœä¸‰ä¸ªæœˆä¹‹åï¼Œè¿™å®¶å…¬å¸é™è½ä¼çš„åˆæ ¼ç‡è¾¾åˆ°äº†100%ã€‚</p>
</blockquote>

<h2 id="heading-åŠæ³•">åŠæ³•</h2>

<p>åœ¨æ— æ³•ä¿è¯æœåŠ¡100%å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆåšåˆ°é™ä½å¤±è´¥ç‡å‘¢ï¼Ÿ å¯èƒ½æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œæˆ‘é€‰æ‹©çš„æ˜¯ï¼š<code class="language-plaintext highlighter-rouge">å¿«é€Ÿå¤±è´¥é‡è¯•</code>ã€‚</p>

<p>æˆ‘ä»¬è®¡ç®—ä¸‹<code class="language-plaintext highlighter-rouge">A</code>è°ƒç”¨<code class="language-plaintext highlighter-rouge">B</code>çš„æœåŠ¡ä¸å¯ç”¨ç‡æ˜¯ 0.001% ( 300/30K å¾—å‡º),  å¦‚æœæœåŠ¡è°ƒç”¨å¤±è´¥çš„æ—¶å€™é‡è¯•3æ¬¡ï¼Œåˆ™ æœåŠ¡ä¸å¯ç”¨ç‡å³ä¸º 0.001% * 0.001% * 0.001%ã€‚</p>

<p>ä½†æ˜¯å•çº¯çš„é‡è¯•ä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜:</p>

<ul>
  <li>
    <p>æ¯”å¦‚é™ä½<code class="language-plaintext highlighter-rouge">A</code>æœåŠ¡çš„æ•´ä½“æ€§èƒ½ï¼Œæœ€å·®æƒ…å†µä¸‹æœ¬æ¥è°ƒç”¨<code class="language-plaintext highlighter-rouge">B</code> æœåŠ¡æœ€å¤šåœ¨300mså°±ä¼šæœ‰è¿”å›ï¼ˆå¼‚å¸¸ä¹Ÿæ˜¯è¿”å›ï¼‰ï¼Œå³<code class="language-plaintext highlighter-rouge">A</code>æœåŠ¡å¤„ç†ä¸€æ¬¡è¯·æ±‚æœ€æ¶ˆè€—500msï¼Œå•çº¿ç¨‹1så¯ä»¥å¤„ç†2ä¸ªè¯·æ±‚ï¼Œä¸€å°æœºå™¨ä¸Šå‡è®¾å¯ä»¥æœ€å¤šå¤„ç†1kä¸ªçº¿ç¨‹çš„æƒ…å†µï¼Œå³<code class="language-plaintext highlighter-rouge">A</code>æœåŠ¡æ¥å£çš„QPS == 2K, 100å°æœºå™¨æœ€é«˜QPS==200K, å½“å¤±è´¥é‡è¯•ä¸‰æ¬¡çš„æ—¶å€™ï¼Œ æ•´ä½“çš„æ¥å£æ€§èƒ½ä¼šé™ä½åˆ°200/3 Kä¸Šã€‚æ€ä¹ˆè§£å†³ï¼Ÿ ç¼©çŸ­<code class="language-plaintext highlighter-rouge">A</code>è°ƒç”¨<code class="language-plaintext highlighter-rouge">B</code>çš„è¶…æ—¶æ—¶é—´ï¼ŒæŠŠè¿™ä¸ªæ—¶é—´æ¨èè®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">B</code>æ¥å£å¹³å‡ç›¸åº”æ—¶é—´ <code class="language-plaintext highlighter-rouge">upper 99çº¿*3ï¼ˆå…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼‰</code>æ¯”å¦‚æŠŠä¸Šé¢æŸ¥è¯¢è¡¥è´´çš„æ¥å£è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º50msï¼Œé‡è¯•3æ¬¡ï¼Œæœ€åæƒ…å†µæ‰æŸè€—150msï¼ŒæœåŠ¡ä¸å¯ç”¨ç‡é™ä½åˆ°äº†0.001% * 0.001% * 0.001%ï¼Œå´è¿˜èƒ½æé«˜QPSåˆ°200K*2ã€‚å°±ç®—æŠŠè¶…æ—¶æ—¶é—´è°ƒæ•´åˆ°100msï¼Œæ•´ä½“æœåŠ¡çš„æ¥å£æ€§èƒ½ä¹Ÿä¸ä¼šé™ä½</p>
  </li>
  <li>
    <p>åŠ äº†é‡è¯•è¿˜ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœ<code class="language-plaintext highlighter-rouge">B</code>æœåŠ¡æŒ‚æ‰äº†ï¼Œå¯¹<code class="language-plaintext highlighter-rouge">B</code>æœåŠ¡çš„å‹åŠ›ä¼šæš´å¢3å€ï¼ˆå¦‚æœé‡è¯•ä¸‰æ¬¡çš„è¯ï¼‰è¿™æ ·<code class="language-plaintext highlighter-rouge">A</code>å°±è¦åšå¥½ç›´æ¥é™çº§<code class="language-plaintext highlighter-rouge">B</code>çš„å‡†å¤‡ï¼Œåšåˆ°ä¸€é”®é™çº§ã€‚</p>
  </li>
</ul>

<h2 id="heading-ä½¿ç”¨å§¿åŠ¿">ä½¿ç”¨å§¿åŠ¿</h2>

<p>æ ¹æ®ç›¸å…³ä¸šåŠ¡å’Œéƒ¨é—¨çš„æŠ€æœ¯æ ˆç”¨åˆ°äº†Huskar+Vineå†™äº†ä¸ªç®€å•çš„é‡è¯•æ¶å­ï¼Œå…ˆçœ‹ä½¿ç”¨å§¿åŠ¿ï¼Œåé¢ä¸Šæºç </p>

<h3 id="heading-callandfallback">callAndFallBack</h3>

<p><strong>æ”¯æŒFallBackçš„è°ƒç”¨å§¿åŠ¿</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestCallUtil</span> <span class="kd">extends</span> <span class="nc">ComponentTest</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">ErsClient</span> <span class="n">ersClient</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">logger</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCallAndFallBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Restaurant</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CallServiceWrapper</span><span class="o">.</span><span class="na">callAndFallBack</span><span class="o">(</span>
            <span class="k">new</span> <span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="nc">Restaurant</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
	                <span class="c1">// å¿…é¡»å®ç°ï¼ŒBæœåŠ¡çš„æ¥å£è°ƒç”¨</span>
                    <span class="k">return</span> <span class="n">ersClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">969343L</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">String</span> <span class="nf">key</span><span class="o">()</span> <span class="o">{</span>
	                <span class="c1">// åšæœåŠ¡é™çº§å¯ä»¥ä½¿ç”¨çš„key</span>
	                <span class="c1">// å¿…é¡»å®ç°</span>
                    <span class="k">return</span> <span class="s">"ElemeRestaurantService#get"</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">fallBack</span><span class="o">()</span> <span class="o">{</span>
	                <span class="c1">// å¦‚æœå®¢æˆ·ç«¯æŠŠæœåŠ¡ç«¯é™çº§æ‰ï¼Œä¼šç›´æ¥èµ°åˆ°fallBacké‡Œé¢</span>
	                <span class="c1">// å¦‚æœå®¢æˆ·ç«¯é‡è¯•æ¬¡æ•°è¾¾åˆ°æœ€å¤§ä½†æ˜¯ä»ç„¶å¤±è´¥ï¼Œä¼šåˆ°fallbacké‡Œé¢</span>
					<span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤è¿”å›null</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">Restaurant</span><span class="o">();</span>                 
                <span class="o">}</span>

                <span class="nd">@Override</span>
				<span class="kd">public</span> <span class="kt">int</span> <span class="nf">callMaxCount</span><span class="o">()</span> <span class="o">{</span>
					<span class="c1">// æœ€å¤§è°ƒç”¨æ¬¡æ•°</span>
					<span class="c1">// å¯ä»¥ä¸Overrideï¼Œé»˜è®¤1</span>
			       <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
			    <span class="o">}</span>

                <span class="nd">@Override</span>			
			    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">silenceMaxCount</span><span class="o">()</span> <span class="o">{</span>
				    <span class="c1">// æœ€å¤§æ²‰é»˜æ¬¡æ•° å½“è°ƒç”¨æ¬¡æ•° &gt; è¯¥å€¼çš„æ—¶å€™ ä¼šè§¦å‘silenceMaxHookå‡½æ•°ï¼Œå¯ä»¥åœ¨silenceMaxHooké‡Œé¢åšç›‘æ§oræ‰“ç‚¹</span>
				    <span class="c1">// å¯ä»¥ä¸Overrideï¼Œé»˜è®¤1</span>
			        <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
			    <span class="o">}</span>

                <span class="nd">@Override</span>			
			    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">alwaysMiddleHook</span><span class="o">()</span> <span class="o">{</span>
				    <span class="c1">// å½“è°ƒç”¨æ¬¡æ•° &gt; æœ€å¤§æ²‰é»˜æ¬¡æ•°çš„æ—¶å€™ï¼Œæ˜¯å¦è¶…è¿‡çš„éƒ¨åˆ†æ€»æ˜¯è§¦å‘silenceMaxHook</span>
				    <span class="c1">// å¯ä»¥ä¸Overrideï¼Œé»˜è®¤falseï¼ˆåªè§¦å‘ä¸€æ¬¡ï¼‰			    </span>
			        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
			    <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCount</span><span class="o">)</span> <span class="o">{</span>
	                <span class="c1">// å¦‚æœè°ƒç”¨è¾¾åˆ°äº†æœ€å¤§æ¬¡æ•°ä¸”ä»ç„¶ä»ç„¶å¤±è´¥ï¼Œä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•ï¼Œä¸»è¦ç”¨æ¥æ‰“ç‚¹oræ—¥å¿—æ¥åšç›‘æ§</span>
					<span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"æœ€å¤§è°ƒç”¨æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">maxCount</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">silenceMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">nowCount</span><span class="o">)</span> <span class="o">{</span>
	                <span class="c1">// å¯å®¹å¿è°ƒç”¨çš„æœ€å¤§æ¬¡æ•°</span>
	                <span class="c1">// æ¯”å¦‚å…è®¸è°ƒç”¨æœ€å¤§æ¬¡æ•°5æ¬¡ï¼Œä½†æ˜¯è¶…è¿‡3æ¬¡çš„å·²ç»æ˜¯å±äºæç«¯caseäº†ï¼Œæƒ³è¦æ„ŸçŸ¥è¶…è¿‡ä¸‰æ¬¡çš„æœ‰å¤šå°‘ï¼Œä¾¿å¯ä»¥åœ¨è¿™é‡Œæ‰“ç‚¹oræ—¥å¿—</span>
	                <span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"å¯å¿å—çš„æœ€å¤§æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">nowCount</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downgradeCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
	                <span class="c1">// å¦‚æœé“¾è·¯èµ°äº†fallbackï¼Œå®Œæˆfallbackä¹‹åä¼šå°†fallbackçš„è¿”å›ç»“æœä¼ å…¥è¿™ä¸ªæ–¹æ³•é‡Œï¼Œæ–¹ä¾¿ç›‘æ§ï¼Œæ‰“æ—¥å¿—ç­‰</span>
	                <span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"é™çº§å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionHook</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
	                <span class="c1">// å¦‚æœå‡ºç°Exceptionï¼Œåˆ™ä¼šcallä¸€æ¬¡è¿™ä¸ªæ¥å£ï¼Œå¹¶ä¸”å°†å¼‚å¸¸ä¿¡æ¯ä¸¢è¿›æ¥ï¼Œæ–¹ä¾¿æ‰“æ—¥å¿—</span>
	                <span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceExceptionHook</span><span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
	                <span class="c1">// å¦‚æœå‡ºç°ServiceExceptionï¼Œåˆ™ä¼šcallä¸€æ¬¡è¿™ä¸ªæ¥å£ï¼Œå¹¶ä¸”å°†å¼‚å¸¸ä¿¡æ¯ä¸¢è¿›æ¥ï¼Œæ–¹ä¾¿æ‰“æ—¥å¿—</span>
	                <span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"ServiceException é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
	                <span class="c1">// å¦‚æœè°ƒç”¨æˆåŠŸï¼Œä¼šå°†è¿”å›è¿”å›ç»“æœå…ˆä¸¢åˆ°è¿™é‡Œæ¥ï¼Œæ–¹ä¾¿æ‰“æ—¥å¿—</span>
	                <span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è°ƒç”¨å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„ä»£ç ä¾¿å®Œæˆäº†ä¸€æ¬¡æœåŠ¡é‡è¯• å’Œ é™çº§é…ç½®æœºåˆ¶ï¼Œä¸Šé¢æŠŠæ‰€æœ‰çš„å¯Overrideæ¥å£å…¨éƒ¨Orverrideäº†ï¼Œ ä¸‹é¢ç»™ä¸€ä¸ªç®€å•çš„ï¼Œå¯ä»¥æ»¡è¶³åŸºæœ¬éœ€æ±‚çš„å®ç°æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestCallUtil</span> <span class="kd">extends</span> <span class="nc">ComponentTest</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">ErsClient</span> <span class="n">ersClient</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">logger</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCallAndFallBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Restaurant</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CallServiceWrapper</span><span class="o">.</span><span class="na">callAndFallBack</span><span class="o">(</span>
            <span class="k">new</span> <span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="nc">Restaurant</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
	                <span class="c1">// å¿…é¡»å®ç°ï¼ŒBæœåŠ¡çš„æ¥å£è°ƒç”¨</span>
                    <span class="k">return</span> <span class="n">ersClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">969343L</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">String</span> <span class="nf">key</span><span class="o">()</span> <span class="o">{</span>
	                <span class="c1">// åšæœåŠ¡é™çº§å¯ä»¥ä½¿ç”¨çš„key</span>
	                <span class="c1">// å¿…é¡»å®ç°</span>
                    <span class="k">return</span> <span class="s">"ElemeRestaurantService#get"</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">fallBack</span><span class="o">()</span> <span class="o">{</span>
	                <span class="c1">// å¦‚æœå®¢æˆ·ç«¯æŠŠæœåŠ¡ç«¯é™çº§æ‰ï¼Œä¼šç›´æ¥èµ°åˆ°fallBacké‡Œé¢</span>
	                <span class="c1">// å¦‚æœå®¢æˆ·ç«¯é‡è¯•æ¬¡æ•°è¾¾åˆ°æœ€å¤§ä½†æ˜¯ä»ç„¶å¤±è´¥ï¼Œä¼šåˆ°fallbacké‡Œé¢</span>
					<span class="c1">// å¯ä»¥ä¸Overrideï¼Œ é»˜è®¤è¿”å›null</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">Restaurant</span><span class="o">();</span>                 
                <span class="o">}</span>
            <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™æ ·å†™çš„è¯å¾ˆç®€å•ï¼ŒåŸºæœ¬æ»¡è¶³éœ€æ±‚ï¼š æ¥å£å¯é™çº§ï¼Œé™çº§åorè¶…è¿‡æœ€å¤§è°ƒç”¨æ¬¡æ•°ä¼šèµ°fallbackæ–¹æ³•ï¼Œå¦‚æœä½ æ‡’ä¸€äº›çš„è¯ fallbackéƒ½å¯ä»¥çœç•¥ï¼Œå› ä¸ºfallbacké»˜è®¤è¿”å›nullã€‚</p>

<p>çœ‹ç¬¬äºŒæ®µä»£ç æ˜¯ä¸æ˜¯æ¯”è¾ƒå¥½å¥‡ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°å’Œæœ€å¤§å¯å®¹å¿æ¬¡æ•°éƒ½æ²¡æœ‰Overrideï¼Œéƒ½èµ°é»˜è®¤1çš„è¯å²‚ä¸æ˜¯æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ Noï¼Œ å› ä¸ºä½ Overrideäº†key()æ–¹æ³•ï¼Œä»–å°†å¸®ä½ åšåˆ°çµæ´»é…ç½®ï¼Œ åªéœ€è¦åœ¨Huskarçš„<strong>Config</strong>ä¸Šé¢é…ç½®ï¼š</p>

<p><img src="/files/images/retry-3.png" alt="t2" /></p>

<p>è€Œä¸”æ˜¯éšæ—¶å¯ä»¥æ”¹å˜ï¼Œä¸éœ€è¦rerollæœåŠ¡å“¦ï½ ä¸è¿‡è€ƒè™‘configé‡Œé¢çš„ä¸œè¥¿ä¸å¤ªå¯èƒ½ç»å¸¸å˜ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€‚å½“çš„ä¼˜åŒ–ä¸‹é¢çš„æºç ï¼Œä½¿å…¶åœ¨æœåŠ¡åˆå§‹åŒ–çš„æ—¶å€™åŠ è½½ä¸€æ¬¡ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½æ‹‰huskar configäº†ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘æŠŠé™çº§æ“ä½œä»configé‡Œé¢æ‹†å‡ºæ¥çš„ä¸€ä¸ªåŸå› ï¼‰</p>

<p>å¦å¤–ä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„åœ°æ–¹åœ¨äºæœåŠ¡é™çº§ï¼Œè‚¯å®šä¹Ÿæ˜¯è¦å¯é…ç½®çš„ï¼Œç”±äºé¥¿äº†ä¹ˆhuskar switchæ¯”è¾ƒé€‚åˆåšå¼€å…³ï¼Œæ‰€ä»¥æˆ‘å¹¶æ²¡æœ‰æŠŠé™çº§å¼€å…³ä¹Ÿé…ç½®åœ¨huskar configçš„jsoné‡Œé¢ï¼Œè€Œæ˜¯å•ç‹¬æ‹å‡ºæ¥åˆ°switché‡Œé¢äº†ï¼Œé…ç½®å¦‚å›¾ã€‚0 ä¸ºé™çº§ï¼Œ100 ä¸ºä¸é™çº§</p>

<p><img src="/files/images/retry-4.png" alt="t3" /></p>

<p>å…·ä½“çš„è¯»å–é…ç½®é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š åœ¨huskarä¸­é…ç½®äº†çš„ä¼˜å…ˆè¯»å–huskaré…ç½®ï¼Œæ²¡æœ‰é…ç½®çš„è¯»ä»£ç Overrideï¼Œå¦‚æœè¿Overrideéƒ½æ²¡æœ‰ï¼Œé‚£å°±èµ°é»˜è®¤å€¼å•¦ã€‚ä¸è¿‡å¼ºçƒˆå»ºè®®èµ°huskarï¼Œä¸è¦Hard Codeã€‚</p>

<ul>
  <li>1 å†™å¥½run()</li>
  <li>2 å†™å¥½key() æ³¨æ„ä¸è¦åœ¨stringé‡Œé¢å†™<code class="language-plaintext highlighter-rouge">$</code>ç¬¦å·ï¼Œå†™äº†çš„è¯ä¹Ÿä¼šè‡ªåŠ¨å°†<code class="language-plaintext highlighter-rouge">$</code>è½¬æ¢ä¸º<code class="language-plaintext highlighter-rouge">#</code>ï¼Œé¿å…å’Œé¥¿äº†ä¹ˆSoaæ¡†æ¶pylonçš„æ¥å£é™çº§å†²çª</li>
  <li>3 å†™å¥½fallback()</li>
</ul>

<p>åšå¥½ä¸Šé¢ä¸‰æ­¥ä¹‹åï¼Œä¾¿å¯ä»¥å¾ˆæ„‰å¿«çš„åœ¨å®¢æˆ·ç«¯æŠŠæœåŠ¡ç«¯çš„æ¥å£åšé‡è¯• or  é™çº§ï¼ˆè¿™æ˜¯å®¢æˆ·ç«¯é™æ‰æœåŠ¡ç«¯ï¼Œpylonå¯ä¸æ”¯æŒå“¦ï½ï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘ä»£ç æ²¡æ‰¾åˆ°ï¼‰ã€‚</p>

<blockquote>
  <p>âš ï¸ ä¸€å®šè¦æ³¨æ„ï¼Œä¸šåŠ¡é‡Œé¢æœ‰äº›æ¥å£æ˜¯ä¸èƒ½é™çº§çš„ï¼Œè¦è¯„ä¼°å¥½ï¼</p>
</blockquote>

<p>ä¸‹é¢ç»™ä¸ªçº¿ä¸Šçš„ä»£ç Demo</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ReduceDeliveryFeeRespDto</span><span class="o">&gt;</span> <span class="nf">getShopProductPromotionWithUserInfoCanDowngrade</span><span class="o">(</span><span class="nc">DeliveryFeeCalculateResultDTO</span> <span class="n">calculateResult</span><span class="o">,</span> <span class="nc">ShopDTO</span> <span class="n">shopDTO</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ReduceDeliveryFeeRespDto</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="nc">CartInfoReqDto</span> <span class="n">cartInfoReqDto</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CartInfoReqDto</span><span class="o">();</span>
    <span class="n">cartInfoReqDto</span><span class="o">.</span><span class="na">setRestaurant_id</span><span class="o">(</span><span class="n">calculateResult</span><span class="o">.</span><span class="na">getShopId</span><span class="o">());</span>
    <span class="n">cartInfoReqDto</span><span class="o">.</span><span class="na">setStandardId</span><span class="o">(</span><span class="n">calculateResult</span><span class="o">.</span><span class="na">getProductId</span><span class="o">());</span>

    <span class="nc">ReduceDeliveryFeeRespDto</span> <span class="n">reduceDeliveryFeeRespDto</span> <span class="o">=</span> <span class="n">calculateReduceDeliveryFee</span><span class="o">(</span><span class="n">cartInfoReqDto</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">reduceDeliveryFeeRespDto</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">reduceDeliveryFeeRespDto</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">private</span> <span class="nc">ReduceDeliveryFeeRespDto</span> <span class="nf">calculateReduceDeliveryFee</span><span class="o">(</span><span class="nc">CartInfoReqDto</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">ReduceDeliveryFeeRespDto</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CallServiceWrapper</span><span class="o">.</span><span class="na">callAndFallBack</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="nc">ReduceDeliveryFeeRespDto</span><span class="o">&gt;()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">ReduceDeliveryFeeRespDto</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">marketingActivityPromotionService</span><span class="o">.</span><span class="na">calculateReduceDeliveryFee</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">key</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"MarketingActivityPromotionService#calculateReduceDeliveryFee"</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">ReduceDeliveryFeeRespDto</span> <span class="nf">fallBack</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceExceptionHook</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">ele</span><span class="o">.</span><span class="na">contract</span><span class="o">.</span><span class="na">exception</span><span class="o">.</span><span class="na">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                    <span class="s">"MarketingActivityPromotionService.calculateReduceDeliveryFee ServiceException, request:%s"</span><span class="o">,</span>
                    <span class="nc">VJson</span><span class="o">.</span><span class="na">writeAsString</span><span class="o">(</span><span class="n">request</span><span class="o">)),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionHook</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                    <span class="s">"MarketingActivityPromotionService.calculateReduceDeliveryFee Exception, request:%s"</span><span class="o">,</span>
                    <span class="nc">VJson</span><span class="o">.</span><span class="na">writeAsString</span><span class="o">(</span><span class="n">request</span><span class="o">)),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downgradeCompleteHook</span><span class="o">(</span><span class="nc">ReduceDeliveryFeeRespDto</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Trace</span><span class="o">.</span><span class="na">newCounter</span><span class="o">(</span><span class="s">"calculate-downgrade"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addTag</span><span class="o">(</span><span class="s">"source"</span><span class="o">,</span> <span class="s">"marketing"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addTag</span><span class="o">(</span><span class="s">"method"</span><span class="o">,</span> <span class="s">"calculate-reduce-delivery-fee"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">once</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">silenceMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">nowCount</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Trace</span><span class="o">.</span><span class="na">newCounter</span><span class="o">(</span><span class="s">"call-silence"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addTag</span><span class="o">(</span><span class="s">"class"</span><span class="o">,</span> <span class="s">"MarketingActivityPromotionService"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addTag</span><span class="o">(</span><span class="s">"method"</span><span class="o">,</span> <span class="s">"calculateReduceDeliveryFee"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addTag</span><span class="o">(</span><span class="s">"count"</span><span class="o">,</span> <span class="n">nowCount</span> <span class="o">+</span> <span class="s">""</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">once</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<h3 id="heading-call">call</h3>

<p><strong>ä¸åšFallBackçš„è°ƒç”¨</strong></p>

<p>è¿™ä¸ªä¸callAndFallBackçš„åŒºåˆ«å°±æ˜¯å½“å‘ç”Ÿé™çº§æ“ä½œ or é‡è¯•è¾¾åˆ°è°ƒç”¨ä¸Šé™åä¸ä¼šè°ƒç”¨fallbackå‡½æ•°ï¼Œç›´æ¥æŠ›Exceptionå‡ºæ¥ã€‚</p>

<ul>
  <li>é™çº§åçš„Exceptionå°±æ˜¯ <code class="language-plaintext highlighter-rouge">new Exception(String.format("%så·²ç»é™çº§", key()))</code></li>
  <li>é‡è¯•æ— æ•ˆåçš„Exceptionå°±æ˜¯æœ€åå¤±è´¥æ—¶runæ–¹æ³•æŠ›å‡ºæ¥çš„Exception</li>
</ul>

<p>ä½¿ç”¨ä»£ç åŸºæœ¬æ²¡æœ‰å˜</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCall</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Restaurant</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CallServiceWrapper</span><span class="o">.</span><span class="na">call</span><span class="o">(</span> <span class="c1">//å°±è¿™é‡Œä¸ä¸€æ ·</span>
                <span class="k">new</span> <span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="nc">Restaurant</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ers.get"</span> <span class="o">+</span> <span class="mi">969343L</span><span class="o">);</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"fuck Exception"</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">key</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="s">"ElemeRestaurantService#get"</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">fallBack</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="k">new</span> <span class="nf">Restaurant</span><span class="o">();</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"æœ€å¤§è°ƒç”¨æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">maxCount</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">silenceMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">nowCount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"å½“å‰è°ƒç”¨æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">nowCount</span> <span class="o">+</span> <span class="s">", å·²ç»ä¸èƒ½å¿å—"</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downgradeCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"é™çº§å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionHook</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceExceptionHook</span><span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"ServiceException é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è°ƒç”¨å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="heading-callnotcoverserviceexception">callNotCoverServiceException</h3>

<p>é¡¾åæ€ä¹‰ï¼Œä¸å»é‡è¯•ServiceExceptionï¼Œå¦‚æœå‡ºæ–°ServiceExceptionï¼Œç›´æ¥ä¸­æ–­é‡è¯•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ å…¶ä»–Exceptionä¼šç»§ç»­retryï¼Œç›´åˆ°è¾¾åˆ°retryæœ€å¤§å€¼ï¼Œå°†æœ€åä¸€æ¬¡è§¦å‘å¾—åˆ°çš„å¼‚å¸¸æŠ›å‡ºæ¥ã€‚   <br />
å¦‚æœæ¥å£è¢«é™çº§ï¼Œåˆ™æŠ›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">new ServiceException(String.format("%så·²ç»é™çº§", serviceInterfaceContext.key()));</code>ï¼Œ <strong>ä¸ä¼šèµ°åˆ°fallbacké‡Œé¢</strong></p>

<p>ä½¿ç”¨å§¿åŠ¿ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCallNotCoverServiceException</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Restaurant</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CallServiceWrapper</span><span class="o">.</span><span class="na">callNotCoverServiceException</span><span class="o">(</span>
                <span class="k">new</span> <span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="nc">Restaurant</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ers.get"</span> <span class="o">+</span> <span class="mi">969343L</span><span class="o">);</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServiceException</span><span class="o">(</span><span class="s">"fuck Service Exception"</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">key</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="s">"ElemeRestaurantService#get"</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">fallBack</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="k">new</span> <span class="nf">Restaurant</span><span class="o">();</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"æœ€å¤§è°ƒç”¨æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">maxCount</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">silenceMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">nowCount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"å½“å‰è°ƒç”¨æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">nowCount</span> <span class="o">+</span> <span class="s">", å·²ç»ä¸èƒ½å¿å—"</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downgradeCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"é™çº§å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionHook</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceExceptionHook</span><span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"ServiceException é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è°ƒç”¨å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="heading-callnotcoverserviceexceptionandfallback">callNotCoverServiceExceptionAndFallBack</h3>

<p>è¿™ä¸ªå°±æ˜¯ ä¸å»è¦†ç›–ServiceExceptionï¼Œä½†æ˜¯å½“å‡ºç° å…¶ä»–Exceptionçš„æ—¶å€™ä¼šåšé‡è¯•ï¼Œç›´åˆ°é‡è¯•åˆ°æœ€å¤§å€¼å è°ƒç”¨fallbackã€‚</p>

<p>å½“è§¦å‘æ¥å£é™çº§çš„æ—¶å€™ä¹Ÿæ˜¯è°ƒç”¨fallbackï¼Œå¹¶ä¸æŠ›å¼‚å¸¸</p>

<p>ä½¿ç”¨å§¿åŠ¿ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCallNotCoverServiceExceptionAndFallBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Restaurant</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CallServiceWrapper</span><span class="o">.</span><span class="na">callNotCoverServiceExceptionAndFallBack</span><span class="o">(</span>
                <span class="k">new</span> <span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="nc">Restaurant</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ers.get"</span> <span class="o">+</span> <span class="mi">969343L</span><span class="o">);</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServiceException</span><span class="o">(</span><span class="s">"fuck Service Exception"</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">key</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="s">"ElemeRestaurantService#get"</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">Restaurant</span> <span class="nf">fallBack</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="k">new</span> <span class="nf">Restaurant</span><span class="o">();</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"æœ€å¤§è°ƒç”¨æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">maxCount</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">silenceMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">nowCount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"å½“å‰è°ƒç”¨æ¬¡æ•°:"</span> <span class="o">+</span> <span class="n">nowCount</span> <span class="o">+</span> <span class="s">", å·²ç»ä¸èƒ½å¿å—"</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downgradeCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"é™çº§å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionHook</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceExceptionHook</span><span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"ServiceException é’©å­"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callCompleteHook</span><span class="o">(</span><span class="nc">Restaurant</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è°ƒç”¨å®Œæˆé’©å­:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<h2 id="heading-æºç ">æºç </h2>

<p>æºç å¾ˆç®€å•ï¼Œå„ä½å°†ä»£ç è´´åˆ°è‡ªå·±é¡¹ç›®é‡Œé¢ï¼Œå¯ä»¥å®šåˆ¶åŒ–çš„ä¿®æ”¹å¼€å‘ï¼š</p>

<h3 id="heading-callserviceinterfacecontext">CallServiceInterfaceContext</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">me.ele.config.HuskarHandle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">me.ele.contract.exception.ServiceException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">me.ele.napos.vine.common.json.VJson</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="cm">/**
     * çœŸæ­£çš„æ¥å£è°ƒç”¨ï¼Œæ¯”å¦‚å®ç°
     */</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="no">T</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>

    <span class="cm">/**
     * huskar keyï¼Œä¸ºnullçš„è¯ä¼šé»˜è®¤ä¸ä½¿ç”¨
     */</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">key</span><span class="o">();</span>

    <span class="cm">/**
     * é™çº§å¤„ç†
     */</span>
    <span class="kd">public</span> <span class="no">T</span> <span class="nf">fallBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ¥å£è°ƒç”¨æ¬¡æ•°æœ€å¤§å€¼
     * &lt;p&gt;
     * return 1: åªå…è®¸æ¥å£è°ƒç”¨ä¸€æ¬¡ï¼Œå°±ç®—æ˜¯è¿™æ¬¡å¤±è´¥äº†ä¹Ÿä¸å›ç»§ç»­è°ƒç”¨
     * return n (n&gt;1): å…è®¸æ¥å£è°ƒç”¨næ¬¡ï¼Œå¦‚æœç¬¬1æ¬¡å¤±è´¥äº†ï¼Œè¿˜å¯ä»¥é‡è¯•n-1æ¬¡
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">callMaxCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å¯å®¹å¿æœ€å¤§è°ƒç”¨æ¬¡æ•°
     * &lt;p&gt;
     * return 1: å½“è°ƒç”¨æœåŠ¡æ¥å£æ¬¡æ•°è¶…è¿‡1, åˆ™è¶…è¿‡1çš„è°ƒç”¨è§¦å‘silenceMaxHook
     * return n: å½“è°ƒç”¨æœåŠ¡æ¥å£æ¬¡æ•°è¶…è¿‡n, åˆ™è¶…è¿‡nçš„è°ƒç”¨è§¦å‘silenceMaxHook
     * &lt;p&gt;
     * æ³¨æ„å½“silenceMaxCount&gt;=callMaxCountçš„æ—¶å€™, å°†æ°¸è¿œä¸ä¼šè§¦å‘silenceMaxHook
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">silenceMaxCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å½“è°ƒç”¨æ¬¡æ•° &gt; å¯å®¹å¿å€¼åæ˜¯å¦æ€»æ˜¯è§¦å‘ silenceMaxHook
     * &lt;p&gt;
     * return false: è¶…è¿‡çš„éƒ¨åˆ†åªä¼šè§¦å‘ä¸€æ¬¡silenceMaxHook
     * return true: è¶…è¿‡çš„éƒ¨åˆ†æ€»æ˜¯è§¦å‘silenceMaxHook
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">alwaysMiddleHook</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * é‡è¯•è¾¾åˆ°æœ€å¤§å€¼åcall back
     * @param maxCount è°ƒç”¨æœ€å¤§å€¼
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxCount</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="cm">/**
     * è¶…è¿‡å¯å®¹å¿æœ€å¤§è°ƒç”¨æ¬¡æ•° call back
     * @param nowCount è°ƒç”¨å½“å‰æ¬¡æ•°
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">silenceMaxHook</span><span class="o">(</span><span class="kt">int</span> <span class="n">nowCount</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="cm">/**
     * é™çº§å®Œæˆ
     * @param result å¦‚æœè°ƒç”¨fallBackï¼Œåˆ™ä¼šå°†fallBackè¿”å›å€¼å½“ä½œresultå‚æ•°
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downgradeCompleteHook</span><span class="o">(</span><span class="no">T</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="cm">/**
     * æœåŠ¡å¼‚å¸¸é’©å­
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceExceptionHook</span><span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="cm">/**
     * å¼‚å¸¸é’©å­
     * @param e å¼‚å¸¸ä¿¡æ¯
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionHook</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="cm">/**
     * æœåŠ¡è°ƒç”¨å®Œæˆé’©å­
     * @param result æœåŠ¡è°ƒç”¨ç»“æœ
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">callCompleteHook</span><span class="o">(</span><span class="no">T</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="cm">/**
     * è·å–huskar key
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">huskarKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// å°†æ‰€æœ‰çš„$è½¬æ¢æˆ#ï¼Œé¿å…è·Ÿpyloné™çº§å†²çª</span>
        <span class="k">return</span> <span class="nf">key</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="n">key</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\$"</span><span class="o">,</span> <span class="s">"#"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * é™çº§
     * &lt;p&gt;
     * return true: å¼€å¯é™çº§
     * return false: å…³é—­é™çº§
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">downgrade</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// huskar switch ä¸­ huskarkeyçš„å€¼ &lt; 50, åˆ™é™çº§æ‰</span>
        <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">HuskarHandle</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getMySwitch</span><span class="o">().</span><span class="na">getInt</span><span class="o">(</span><span class="n">huskarKey</span><span class="o">(),</span> <span class="mi">100</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * è°ƒç”¨æœåŠ¡é…ç½®
     * 1. å¯ä»¥æ ¹æ® huskarKey é…ç½®åœ¨huskar configä¸Š
     * 2. å¦‚æœhuskarä¸­è¯»å–ä¸åˆ°æˆ–è€…è¯»å–é”™è¯¯, åˆ™ä½¿ç”¨ Override callMaxCount,silenceMaxCount,alwaysMiddleHook
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">CallServiceInterfaceConfig</span> <span class="nf">config</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">huskarValue</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">huskarKey</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">huskarKey</span><span class="o">().</span><span class="na">trim</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">huskarValue</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">huskarValue</span> <span class="o">=</span> <span class="nc">HuskarHandle</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getMyConfig</span><span class="o">().</span><span class="na">getProperty</span><span class="o">(</span><span class="n">huskarKey</span><span class="o">(),</span> <span class="s">""</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">CallServiceInterfaceConfig</span> <span class="n">callServiceInterfaceConfig</span> <span class="o">=</span> <span class="nc">CallServiceInterfaceConfig</span><span class="o">.</span><span class="na">getInstanceByJsonString</span><span class="o">(</span><span class="n">huskarValue</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">callServiceInterfaceConfig</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">callServiceInterfaceConfig</span> <span class="o">=</span> <span class="nc">CallServiceInterfaceConfig</span><span class="o">.</span><span class="na">getInstanceByValue</span><span class="o">(</span><span class="n">callMaxCount</span><span class="o">(),</span> <span class="n">silenceMaxCount</span><span class="o">(),</span> <span class="n">alwaysMiddleHook</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">callServiceInterfaceConfig</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallServiceInterfaceConfig</span><span class="o">{</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">callMaxCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">silenceMaxCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">alwaysMiddleHook</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setCallMaxCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">callMaxCount</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">callMaxCount</span> <span class="o">=</span> <span class="n">callMaxCount</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setSilenceMaxCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">silenceMaxCount</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">silenceMaxCount</span> <span class="o">=</span> <span class="n">silenceMaxCount</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setAlwaysMiddleHook</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">alwaysMiddleHook</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">alwaysMiddleHook</span> <span class="o">=</span> <span class="n">alwaysMiddleHook</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getCallMaxCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">callMaxCount</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getSilenceMaxCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">silenceMaxCount</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isAlwaysMiddleHook</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">alwaysMiddleHook</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CallServiceInterfaceConfig</span> <span class="nf">getInstanceByJsonString</span><span class="o">(</span><span class="nc">String</span> <span class="n">jsonString</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">jsonString</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">jsonString</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="nc">VJson</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">jsonString</span><span class="o">,</span> <span class="nc">CallServiceInterfaceConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CallServiceInterfaceConfig</span> <span class="nf">getInstanceByValue</span><span class="o">(</span><span class="kt">int</span> <span class="n">callMaxCount</span><span class="o">,</span> <span class="kt">int</span> <span class="n">silenceMaxCount</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">alwaysMiddleHook</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">CallServiceInterfaceConfig</span> <span class="n">callServiceInterfaceConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CallServiceInterfaceConfig</span><span class="o">();</span>
            <span class="n">callServiceInterfaceConfig</span><span class="o">.</span><span class="na">setCallMaxCount</span><span class="o">(</span><span class="n">callMaxCount</span><span class="o">);</span>
            <span class="n">callServiceInterfaceConfig</span><span class="o">.</span><span class="na">setSilenceMaxCount</span><span class="o">(</span><span class="n">silenceMaxCount</span><span class="o">);</span>
            <span class="n">callServiceInterfaceConfig</span><span class="o">.</span><span class="na">setAlwaysMiddleHook</span><span class="o">(</span><span class="n">alwaysMiddleHook</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">callServiceInterfaceConfig</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="heading-callservicewrapper">CallServiceWrapper</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">me.ele.contract.exception.ServiceException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CallServiceWrapper</span> <span class="o">{</span>
    <span class="cm">/**
     * 0 é™çº§å¼€å…³å…³é—­ï¼ŒæœåŠ¡æ­£å¸¸å“åº”ï¼Œæ­£å¸¸è¿”å›
     * 1 é™çº§å¼€å…³å…³é—­ï¼ŒæœåŠ¡å¼‚å¸¸ï¼Œèµ°é‡è¯•é€»è¾‘ï¼Œé‡è¯•è¾¾åˆ°æœ€å¤§å€¼èµ°fallback&amp;hook
     * 2 é™çº§å¼€å…³æ‰“å¼€ï¼Œèµ°fallback&amp;hook
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">callAndFallBack</span><span class="o">(</span><span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">serviceInterfaceContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgrade</span><span class="o">())</span> <span class="o">{</span>

            <span class="c1">// æ¥å£è¢«é™çº§ï¼Œåˆ™ç›´æ¥callBackï¼Œå¹¶ä¸”è§¦å‘downgradeCompleteHook</span>
            <span class="no">T</span> <span class="n">callBackResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">fallBack</span><span class="o">();</span>
            <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgradeCompleteHook</span><span class="o">(</span><span class="n">callBackResult</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">callBackResult</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">CallServiceInterfaceContext</span><span class="o">.</span><span class="na">CallServiceInterfaceConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">config</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="na">getCallMaxCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="no">T</span> <span class="n">callResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callCompleteHook</span><span class="o">(</span><span class="n">callResult</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">callResult</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">serviceExceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">exceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// å½“è°ƒç”¨æ¬¡æ•°è¶…è¿‡å¯å®¹å¿æ¬¡æ•°åæ—¶å€™è§¦å‘silenceMaxHook</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="na">getSilenceMaxCount</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">middleHook</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">silenceMaxHook</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="c1">// æ²¡æœ‰æ‰“å¼€alwaysMiddleHookçš„è¯ åªè§¦å‘ä¸€æ¬¡middleHook</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">config</span><span class="o">.</span><span class="na">isAlwaysMiddleHook</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// é‡è¯•æ¬¡æ•°è¾¾åˆ° retryMaxCount åˆ™è§¦å‘retryMaxHook</span>
        <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callMaxHook</span><span class="o">(</span><span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callMaxCount</span><span class="o">());</span>

        <span class="c1">// é‡è¯•æœ€å¤§ è°ƒç”¨fallBack</span>
        <span class="no">T</span> <span class="n">callBackResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">fallBack</span><span class="o">();</span>
        <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgradeCompleteHook</span><span class="o">(</span><span class="n">callBackResult</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">callBackResult</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 0 é™çº§å¼€å…³å…³é—­ï¼ŒæœåŠ¡æ­£å¸¸å“åº”ï¼Œæ­£å¸¸è¿”å›
     * 1 é™çº§å¼€å…³å…³é—­ï¼ŒæœåŠ¡å¼‚å¸¸èµ°é‡è¯•é€»è¾‘ï¼Œé‡è¯•æ»¡åªä¼šæŠ›æœ€åä¸€æ¬¡é‡è¯•çš„å¼‚å¸¸
     * 2 é™çº§å¼€å…³æ‰“å¼€ï¼ŒæŠ›æ¥å£å·²é™çº§å¼‚å¸¸
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">call</span><span class="o">(</span><span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">serviceInterfaceContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgrade</span><span class="o">())</span> <span class="o">{</span>

            <span class="c1">// æ¥å£è¢«é™çº§ï¼Œç›´æ¥æŠ›Exception</span>
            <span class="c1">// è¿™é‡ŒdowngradeCompleteHookä¼ å…¥nullï¼Œ å› ä¸ºæ²¡æœ‰ç»“æœä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¯ä»¥ä¼ å…¥çš„</span>
            <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgradeCompleteHook</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%så·²ç»é™çº§"</span><span class="o">,</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">huskarKey</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">Exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">CallServiceInterfaceContext</span><span class="o">.</span><span class="na">CallServiceInterfaceConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">config</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="na">getCallMaxCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="no">T</span> <span class="n">callResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callCompleteHook</span><span class="o">(</span><span class="n">callResult</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">callResult</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">serviceExceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="n">exception</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">exceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="n">exception</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// å½“è°ƒç”¨æ¬¡æ•°è¶…è¿‡å¯å®¹å¿æ¬¡æ•°åæ—¶å€™è§¦å‘silenceMaxHook</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="na">getSilenceMaxCount</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">middleHook</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">silenceMaxHook</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="c1">// æ²¡æœ‰æ‰“å¼€alwaysMiddleHookçš„è¯ åªè§¦å‘ä¸€æ¬¡middleHook</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">config</span><span class="o">.</span><span class="na">isAlwaysMiddleHook</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// é‡è¯•æ¬¡æ•°è¾¾åˆ° retryMaxCount åˆ™è§¦å‘retryMaxHook</span>
        <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callMaxHook</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getCallMaxCount</span><span class="o">());</span>

        <span class="c1">// æŠ›å‡ºæœ€æœ‰ä¸€æ¬¡å¼‚å¸¸ä¿¡æ¯</span>
        <span class="k">throw</span> <span class="n">exception</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">Exception</span><span class="o">(</span><span class="s">"æ— å¼‚å¸¸ä¿¡æ¯"</span><span class="o">)</span> <span class="o">:</span> <span class="n">exception</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 0 é™çº§å¼€å…³å…³é—­ï¼ŒæœåŠ¡æ­£å¸¸å“åº”ï¼Œæ­£å¸¸è¿”å›
     * 1 é™çº§å¼€å…³å…³é—­ï¼ŒServiceException ç›´æ¥æŠ›ï¼ŒExceptionèµ°é‡è¯•ï¼Œé‡è¯•æ»¡äº†æŠ›Exception
     * 2 é™çº§å¼€å…³æ‰“å¼€ï¼ŒæŠ›æ¥å£å·²ç»é™çº§çš„ServiceException
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">callNotCoverServiceException</span><span class="o">(</span><span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">serviceInterfaceContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgrade</span><span class="o">())</span> <span class="o">{</span>

            <span class="c1">// æ¥å£è¢«é™çº§ï¼Œç›´æ¥æŠ›Exception</span>
            <span class="c1">// è¿™é‡ŒdowngradeCompleteHookä¼ å…¥nullï¼Œ å› ä¸ºæ²¡æœ‰ç»“æœä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¯ä»¥ä¼ å…¥çš„</span>
            <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgradeCompleteHook</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServiceException</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%så·²ç»é™çº§"</span><span class="o">,</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">huskarKey</span><span class="o">()));</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">Exception</span> <span class="n">exception</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">CallServiceInterfaceContext</span><span class="o">.</span><span class="na">CallServiceInterfaceConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">config</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="na">getCallMaxCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="no">T</span> <span class="n">callResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callCompleteHook</span><span class="o">(</span><span class="n">callResult</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">callResult</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">serviceExceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">exceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="n">exception</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// å½“è°ƒç”¨æ¬¡æ•°è¶…è¿‡å¯å®¹å¿æ¬¡æ•°åæ—¶å€™è§¦å‘silenceMaxHook</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="na">getSilenceMaxCount</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">middleHook</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">silenceMaxHook</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="c1">// æ²¡æœ‰æ‰“å¼€alwaysMiddleHookçš„è¯ åªè§¦å‘ä¸€æ¬¡middleHook</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">config</span><span class="o">.</span><span class="na">isAlwaysMiddleHook</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// é‡è¯•æ¬¡æ•°è¾¾åˆ° retryMaxCount åˆ™è§¦å‘retryMaxHook</span>
        <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callMaxHook</span><span class="o">(</span><span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callMaxCount</span><span class="o">());</span>

        <span class="c1">// æŠ›å‡ºæœ€åä¸€æ¬¡å¼‚å¸¸ä¿¡æ¯</span>
        <span class="k">throw</span> <span class="n">exception</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">ServiceException</span><span class="o">(</span><span class="s">"æ— å¼‚å¸¸ä¿¡æ¯"</span><span class="o">)</span> <span class="o">:</span> <span class="n">exception</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 0 é™çº§å¼€å…³å…³é—­ï¼ŒæœåŠ¡æ­£å¸¸å“åº”ï¼Œæ­£å¸¸è¿”å›
     * 1 é™çº§å¼€å…³å…³é—­ï¼ŒServiceException ç›´æ¥æŠ›ï¼ŒExceptionèµ°é‡è¯•ï¼Œé‡è¯•æ»¡äº†èµ° ballback&amp;hook
     * 2 é™çº§å¼€å…³æ‰“å¼€ï¼Œç›´æ¥èµ° fallback&amp;hook
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">callNotCoverServiceExceptionAndFallBack</span><span class="o">(</span><span class="nc">CallServiceInterfaceContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">serviceInterfaceContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgrade</span><span class="o">())</span> <span class="o">{</span>

            <span class="c1">// æ¥å£è¢«é™çº§ï¼Œåˆ™ç›´æ¥callBackï¼Œå¹¶ä¸”è§¦å‘downgradeCompleteHook</span>
            <span class="no">T</span> <span class="n">callBackResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">fallBack</span><span class="o">();</span>
            <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgradeCompleteHook</span><span class="o">(</span><span class="n">callBackResult</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">callBackResult</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">CallServiceInterfaceContext</span><span class="o">.</span><span class="na">CallServiceInterfaceConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">config</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="na">getCallMaxCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="no">T</span> <span class="n">callResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callCompleteHook</span><span class="o">(</span><span class="n">callResult</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">callResult</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">serviceExceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">exceptionHook</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// å½“è°ƒç”¨æ¬¡æ•°è¶…è¿‡å¯å®¹å¿æ¬¡æ•°åæ—¶å€™è§¦å‘silenceMaxHook</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="na">getSilenceMaxCount</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">middleHook</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">silenceMaxHook</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="c1">// æ²¡æœ‰æ‰“å¼€alwaysMiddleHookçš„è¯ åªè§¦å‘ä¸€æ¬¡middleHook</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">config</span><span class="o">.</span><span class="na">isAlwaysMiddleHook</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">middleHook</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// é‡è¯•æ¬¡æ•°è¾¾åˆ° retryMaxCount åˆ™è§¦å‘retryMaxHook</span>
        <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callMaxHook</span><span class="o">(</span><span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">callMaxCount</span><span class="o">());</span>

        <span class="c1">// é‡è¯•æœ€å¤§ è°ƒç”¨fallBack</span>
        <span class="no">T</span> <span class="n">callBackResult</span> <span class="o">=</span> <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">fallBack</span><span class="o">();</span>
        <span class="n">serviceInterfaceContext</span><span class="o">.</span><span class="na">downgradeCompleteHook</span><span class="o">(</span><span class="n">callBackResult</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">callBackResult</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>
:ET