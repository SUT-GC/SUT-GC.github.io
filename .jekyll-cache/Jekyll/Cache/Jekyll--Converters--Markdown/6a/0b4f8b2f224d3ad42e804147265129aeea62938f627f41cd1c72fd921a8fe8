I"è„<ul class="toc" id="markdown-toc">
  <li><a href="#heading-amqp" id="markdown-toc-heading-amqp">AMQP</a>    <ul>
      <li><a href="#heading-amqp-1" id="markdown-toc-heading-amqp-1">AMQP</a></li>
      <li><a href="#heading-amqp-0-9-1" id="markdown-toc-heading-amqp-0-9-1">AMQP 0-9-1</a></li>
      <li><a href="#heading-äº¤æ¢æœº" id="markdown-toc-heading-äº¤æ¢æœº">äº¤æ¢æœº</a></li>
      <li><a href="#heading-é»˜è®¤äº¤æ¢æœº" id="markdown-toc-heading-é»˜è®¤äº¤æ¢æœº">é»˜è®¤äº¤æ¢æœº</a>        <ul>
          <li><a href="#heading-demo" id="markdown-toc-heading-demo">Demo</a></li>
        </ul>
      </li>
      <li><a href="#heading-ç›´è¿äº¤æ¢æœº" id="markdown-toc-heading-ç›´è¿äº¤æ¢æœº">ç›´è¿äº¤æ¢æœº</a>        <ul>
          <li><a href="#heading-demo-1" id="markdown-toc-heading-demo-1">demo</a></li>
        </ul>
      </li>
      <li><a href="#heading-æ‰‡è¡Œäº¤æ¢æœº" id="markdown-toc-heading-æ‰‡è¡Œäº¤æ¢æœº">æ‰‡è¡Œäº¤æ¢æœº</a>        <ul>
          <li><a href="#heading-demo-2" id="markdown-toc-heading-demo-2">demo</a></li>
        </ul>
      </li>
      <li><a href="#heading-ä¸»é¢˜äº¤æ¢æœº" id="markdown-toc-heading-ä¸»é¢˜äº¤æ¢æœº">ä¸»é¢˜äº¤æ¢æœº</a>        <ul>
          <li><a href="#heading-demo-3" id="markdown-toc-heading-demo-3">demo</a></li>
        </ul>
      </li>
      <li><a href="#heading-å¤´äº¤æ¢æœº" id="markdown-toc-heading-å¤´äº¤æ¢æœº">å¤´äº¤æ¢æœº</a></li>
    </ul>
  </li>
  <li><a href="#heading-å‚è€ƒæ–‡æ¡£" id="markdown-toc-heading-å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</a></li>
</ul>

<h1 id="heading-amqp">AMQP</h1>

<h2 id="heading-amqp-1">AMQP</h2>

<p>é«˜çº§æ¶ˆæ¯åè®®ï¼Œ æ¶ˆæ¯ä»£ç† FROM æ¶ˆæ¯ç”Ÿäº§è€… GET æ¶ˆæ¯ GIVE TO æ¶ˆæ¯æ¶ˆè´¹è€… BY è·¯ç”±è§„åˆ™</p>

<h2 id="heading-amqp-0-9-1">AMQP 0-9-1</h2>

<p>AMQP 0-9-1 å·¥ä½œæµç¨‹ï¼šæ¶ˆæ¯ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘ç»™äº¤æ¢æœºï¼Œäº¤æ¢æœºå†æ ¹æ®è·¯ç”±è§„åˆ™ï¼Œå°†æ¶ˆæ¯å‘ç»™æ¶ˆæ¯æ¶ˆè´¹è€…ã€‚</p>

<ul>
  <li>
    <p>å‘å¸ƒè€… å¯ä»¥åœ¨æ¶ˆæ¯ä¸ŠæŒ‡å®šå„ç§æ¶ˆæ¯å±æ€§ï¼Œæœ‰äº›å±æ€§å¯ä»¥è¢«æ¶ˆæ¯ä»£ç†ä½¿ç”¨ï¼Œ æœ‰äº›åˆ™ä¼šé€ä¼ ç»™æ¶ˆæ¯æ¶ˆè´¹è€…ã€‚</p>
  </li>
  <li>
    <p>AMQP æ¨¡å‹ä¸ºäº†å°½å¯èƒ½ä¿è¯æ¶ˆæ¯åˆ°è¾¾ï¼Œå…·æœ‰ACKæœºåˆ¶ï¼Œå½“æ¶ˆæ¯å‘ç»™æ¶ˆè´¹è€…ä¹‹åï¼Œç­‰å¾…æ¶ˆè´¹è€…å‘å‡ºACKåŠ¨ä½œè¡¨æ˜æ¶ˆæ¯æ¥æ”¶åˆ°ï¼Œè¿™ä¸ªå¯ä»¥æ˜¯è‡ªåŠ¨çš„ä¹Ÿå¯ä»¥ç”±å¤„ç†æ¶ˆæ¯çš„åº”ç”¨çš„å¼€å‘è€…æ‰§è¡Œã€‚å½“â€œæ¶ˆæ¯ç¡®è®¤â€è¢«å¯ç”¨çš„æ—¶å€™ï¼Œæ¶ˆæ¯ä»£ç†ä¸ä¼šå®Œå…¨å°†æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œç›´åˆ°å®ƒæ”¶åˆ°æ¥è‡ªæ¶ˆè´¹è€…çš„ç¡®è®¤å›æ‰§ã€‚</p>
  </li>
  <li>
    <p>é˜Ÿåˆ—ï¼Œäº¤æ¢æœºå’Œç»‘å®šç»Ÿç§°ä¸ºAMQPå®ä½“</p>
  </li>
  <li>
    <p>AMQP æ˜¯ä¸€ä¸ªå¯ç¼–ç¨‹çš„åè®®ï¼Œ æŸç§æ„ä¹‰ä¸Šè¯´AMQPçš„å®ä½“å’Œè·¯ç”±è§„åˆ™æ˜¯ç”±åº”ç”¨æœ¬èº«å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯ç”±æ¶ˆæ¯ä»£ç†å®šä¹‰ã€‚åŒ…æ‹¬åƒå£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºï¼Œå®šä¹‰ä»–ä»¬ä¹‹é—´çš„ç»‘å®šï¼Œè®¢é˜…é˜Ÿåˆ—ç­‰ç­‰å…³äºåè®®æœ¬èº«çš„æ“ä½œã€‚</p>
  </li>
</ul>

<h2 id="heading-äº¤æ¢æœº">äº¤æ¢æœº</h2>

<p>äº¤æ¢æœºæ˜¯ç”¨æ¥å‘æ¶ˆæ¯çš„AMQPçš„å®ä½“ï¼Œäº¤æ¢æœºæ‹¿åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¹‹åä¼šæŠŠæ¶ˆæ¯å‘ç»™ &gt;= 0 ä¸ªé˜Ÿåˆ—ï¼Œè‡³äºä½¿ç”¨å“ªç§è·¯ç”±ç®—æ³•ï¼Œåˆ™ç”±äº¤æ¢æœºç±»å‹å’Œè¢«ç»‘å®šçš„è§„åˆ™å†³å®šï¼Œä¸‹é¢æ˜¯å››ç§äº¤æ¢æœºï¼š</p>

<ul>
  <li>ç›´è¿äº¤æ¢æœºï¼ˆDIRCETï¼‰ <code class="language-plaintext highlighter-rouge">'' or 'amq.direct'</code></li>
  <li>æ‰‡å½¢äº¤æ¢æœºï¼ˆFOUNTï¼‰ <code class="language-plaintext highlighter-rouge">amq.fanout</code></li>
  <li>ä¸»é¢˜äº¤æ¢æœºï¼ˆTOPICï¼‰ <code class="language-plaintext highlighter-rouge">amq.topic</code></li>
  <li>å¤´äº¤æ¢æœº  ï¼ˆHEADERï¼‰<code class="language-plaintext highlighter-rouge">amq.match</code></li>
</ul>

<p>é™¤äº†äº¤æ¢æœºç±»å‹ä¹‹å¤–ï¼Œå£°æ˜äº¤æ¢æœºçš„æ—¶å€™è¿˜å¯ä»¥æŒ‡å®šä¸€äº›å±æ€§:</p>
<ul>
  <li>Name</li>
  <li>Durablity</li>
  <li>Auto-delete</li>
  <li>Argument</li>
</ul>

<p>äº¤æ¢æœºå¯ä»¥æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼šæŒä¹…ï¼ˆdurableï¼‰ã€æš‚å­˜ï¼ˆtransientï¼‰ã€‚æŒä¹…åŒ–çš„äº¤æ¢æœºä¼šåœ¨æ¶ˆæ¯ä»£ç†ï¼ˆbrokerï¼‰é‡å¯åä¾æ—§å­˜åœ¨ï¼Œè€Œæš‚å­˜çš„äº¤æ¢æœºåˆ™ä¸ä¼šï¼ˆå®ƒä»¬éœ€è¦åœ¨ä»£ç†å†æ¬¡ä¸Šçº¿åé‡æ–°è¢«å£°æ˜ï¼‰ã€‚ç„¶è€Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨åœºæ™¯éƒ½éœ€è¦æŒä¹…åŒ–çš„äº¤æ¢æœºã€‚</p>

<h2 id="heading-é»˜è®¤äº¤æ¢æœº">é»˜è®¤äº¤æ¢æœº</h2>

<p>é»˜è®¤äº¤æ¢æœºæ˜¯æ¶ˆæ¯ä»£ç†é»˜è®¤ç”Ÿæˆçš„ä¸€ä¸ªæ²¡æœ‰åå­—çš„ç›´è¿äº¤æ¢æœºï¼Œå®ƒæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ä½¿å¾—å®ƒå¯¹äºç®€å•åº”ç”¨ç‰¹åˆ«æœ‰ç”¨å¤„ï¼šé‚£å°±æ˜¯æ¯ä¸ªæ–°å»ºé˜Ÿåˆ—ï¼ˆqueueï¼‰éƒ½ä¼šè‡ªåŠ¨ç»‘å®šåˆ°é»˜è®¤äº¤æ¢æœºä¸Šï¼Œç»‘å®šçš„è·¯ç”±é”®ï¼ˆrouting keyï¼‰åç§°ä¸é˜Ÿåˆ—åç§°ç›¸åŒã€‚</p>

<p>ğŸŒ° å½“ä½ å£°æ˜äº†ä¸€ä¸ªåä¸º"search-indexing-online"çš„é˜Ÿåˆ—ï¼ŒAMQPä»£ç†ä¼šè‡ªåŠ¨å°†å…¶ç»‘å®šåˆ°é»˜è®¤äº¤æ¢æœºä¸Šï¼Œç»‘å®šï¼ˆbindingï¼‰çš„è·¯ç”±é”®åç§°ä¹Ÿæ˜¯ä¸º"search-indexing-online"ã€‚å› æ­¤ï¼Œå½“æºå¸¦ç€åä¸º"search-indexing-online"çš„è·¯ç”±é”®çš„æ¶ˆæ¯è¢«å‘é€åˆ°é»˜è®¤äº¤æ¢æœºçš„æ—¶å€™ï¼Œæ­¤æ¶ˆæ¯ä¼šè¢«é»˜è®¤äº¤æ¢æœºè·¯ç”±è‡³åä¸º"search-indexing-online"çš„é˜Ÿåˆ—ä¸­ã€‚æ¢å¥è¯è¯´ï¼Œé»˜è®¤äº¤æ¢æœºçœ‹èµ·æ¥è²Œä¼¼èƒ½å¤Ÿç›´æ¥å°†æ¶ˆæ¯æŠ•é€’ç»™é˜Ÿåˆ—ï¼Œå°½ç®¡æŠ€æœ¯ä¸Šå¹¶æ²¡æœ‰åšç›¸å…³çš„æ“ä½œã€‚</p>

<h3 id="heading-demo">Demo</h3>

<p><strong>æ¶ˆæ¯æ¥å—è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>


<span class="c1"># ç”Ÿå‘½Q
</span><span class="n">queue_result</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">'demo_default_q'</span><span class="p">)</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">queue_result</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">queue</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">method</span>
    <span class="k">print</span> <span class="n">properties</span>
    <span class="k">print</span> <span class="n">body</span>


<span class="c1"># æ¥å—æ¶ˆæ¯, æŒ‡å®šæ¥å—çš„é˜Ÿåˆ—
</span><span class="n">channel</span><span class="p">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                     <span class="p">)</span>


<span class="k">print</span> <span class="s">'start consuming'</span>

<span class="n">channel</span><span class="p">.</span><span class="n">start_consuming</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>æ¶ˆæ¯å‘é€è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># é“¾æ¥rabbitmq
</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">body</span> <span class="o">=</span> <span class="s">"hello world"</span>


<span class="c1"># exchange = '' è¡¨ç¤ºä½¿ç”¨é»˜è®¤äº¤æ¢æœºï¼Œå¾€é»˜è®¤äº¤æ¢æœºä¸Šå‘æ¶ˆæ¯ï¼Œå¹¶ä¸”å¸¦ç€routingkey
</span><span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s">'demo_default_q'</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

<span class="k">print</span> <span class="s">'send success, body :%s'</span> <span class="o">%</span> <span class="n">body</span>

<span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="heading-ç›´è¿äº¤æ¢æœº">ç›´è¿äº¤æ¢æœº</h2>

<p>ç›´è¿äº¤æ¢æœºæ˜¯æ ¹æ®æ¶ˆæ¯æºå¸¦çš„è·¯ç”±é”®å°†æ¶ˆæ¯å‘ç»™åŒåçš„é˜Ÿåˆ—ï¼Œç›´è¿äº¤æ¢æœºæ˜¯å¤„ç†å•æ’­è·¯ç”±çš„</p>

<ul>
  <li>
    <p>å°†ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°ä¸€ä¸ªäº¤æ¢æœºä¸Šï¼Œå¹¶èµ‹äºˆè¯¥ç»‘å®šä¸€ä¸ªä¸é˜Ÿåˆ—åå­—åŒæ ·çš„è·¯ç”±é”®</p>
  </li>
  <li>
    <p>å½“å¸¦ç€Rè·¯ç”±é”®çš„æ¶ˆæ¯å‘ç»™ç›´è¿äº¤æ¢æœºä¹‹åï¼Œäº¤æ¢æœºä¼šå°†è¿™ä¸ªæ¶ˆæ¯è·¯ç”±ç»™åŒæ ·ä¸ºRçš„é˜Ÿåˆ—</p>
  </li>
</ul>

<blockquote>
  <p>ç›´è¿äº¤æ¢æœºç»å¸¸ç”¨æ¥å¾ªç¯åˆ†å‘ä»»åŠ¡ç»™å¤šä¸ªå·¥ä½œè€…ï¼ˆworkersï¼‰ã€‚å½“è¿™æ ·åšçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç™½ä¸€ç‚¹ï¼Œåœ¨AMQP 0-9-1ä¸­ï¼Œæ¶ˆæ¯çš„è´Ÿè½½å‡è¡¡æ˜¯å‘ç”Ÿåœ¨æ¶ˆè´¹è€…ï¼ˆconsumerï¼‰ä¹‹é—´çš„ï¼Œè€Œä¸æ˜¯é˜Ÿåˆ—ï¼ˆqueueï¼‰ä¹‹é—´ã€‚</p>
</blockquote>

<h3 id="heading-demo-1">demo</h3>

<p><strong>æ¶ˆæ¯æ¥å—è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>

<span class="c1"># å£°æ˜ä¸€ä¸ªç›´è¿äº¤æ¢æœºE
</span><span class="n">channel</span><span class="p">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_direct'</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s">'direct'</span><span class="p">)</span>
<span class="c1"># å£°æ˜ä¸€ä¸ªQ
</span><span class="n">channel</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">'demo_direct_q'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">body</span>

<span class="c1"># å°†Eå’ŒQç»‘å®š
</span><span class="n">channel</span><span class="p">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_direct'</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s">'demo_direct_q'</span><span class="p">)</span>

<span class="c1"># è¿™ä¸ªQæ¥å—æ¶ˆæ¯ï¼Œä¸å¸¦routingkeyï¼Œå› ä¸ºç›´è¿äº¤æ¢æœºä¼šå°†Qå’ŒkeyåŒå
</span><span class="n">channel</span><span class="p">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="s">'demo_direct_q'</span><span class="p">,</span>
                     <span class="p">)</span>


<span class="k">print</span> <span class="s">'start consuming'</span>

<span class="n">channel</span><span class="p">.</span><span class="n">start_consuming</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>æ¶ˆæ¯å‘é€è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>

<span class="c1"># å£°æ˜ä¸€ä¸ªç›´è¿äº¤æ¢æœºE
</span><span class="n">channel</span><span class="p">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_direct'</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s">'direct'</span><span class="p">)</span>

<span class="c1"># ç”±äºå¾€ç›´è¿äº¤æ¢æœºå¸¦rutingkeyå‘é€æ¶ˆæ¯ï¼Œä¼šè¢«è‡ªåŠ¨è½¬å‘ç»™ ä¸è¯¥Eç»‘å®šçš„ä¸”ä¸routingkeyåŒåçš„Q
</span><span class="n">body</span> <span class="o">=</span> <span class="s">"hello world"</span>
<span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span>
                      <span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_direct'</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s">'demo_direct_q'</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

<span class="k">print</span> <span class="s">'send success, body :%s'</span> <span class="o">%</span> <span class="n">body</span>

<span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p>AMQPçš„Qå’ŒEå’Œç»‘å®šè°ƒç†å¾ˆæ¸…æ™°çš„ï¼Œ æˆ‘å¤§è‡´æ¢³ç†ä¸€ä¸‹æ€è·¯:</p>
  <ol>
    <li>æ¶ˆæ¯å‘é€è€…      <br />
1.1 å£°æ˜ä¸€ä¸ªäº¤æ¢æœºE   <br />
1.2 å‘è¿™ä¸ªäº¤æ¢æœºå‘é€å¸¦routingkeyçš„æ¶ˆæ¯</li>
  </ol>

  <p>2 æ¶ˆæ¯æ¥å—è€…     <br />
2.1 å£°æ˜ä¸€ä¸ªäº¤æ¢æœºE  <br />
2.2 å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—Q  <br />
2.3 å°†è¿™ä¸ªQå’ŒEç»‘å®š (å¦‚æœä¸æ˜¾å¼ç»‘å®šä¸€ä¸ªQå’ŒE, åˆ™Qé»˜è®¤ç»‘å®šåˆ°é»˜è®¤äº¤æ¢æœº)  <br />
2.4 æ¥å—Qè¿‡æ¥çš„æ¶ˆæ¯ï¼ˆå¯ä»¥å¸¦routingkey, ä¹Ÿå¯ä»¥ä¸å¸¦)</p>

  <p>âš ï¸ å½“ä¸æ˜¾ç¤ºå£°æ˜ä¸€ä¸ªäº¤æ¢æœºEçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨rabbitMQé»˜è®¤æä¾›çš„å‡ ä¸ªäº¤æ¢æœºï¼Œå½“ä¸æ˜¾å¼å°†Qå’ŒEç»‘å®šèµ·æ¥çš„è¯ï¼Œåˆ™ä¼šé»˜è®¤å°†Qç»‘å®šåˆ°æ˜ä¸º<code class="language-plaintext highlighter-rouge">''</code>çš„Eä¸Š</p>
</blockquote>

<p><img src="/files/images/rabbitMQ.png" alt="rabbitMQ" /></p>

<h2 id="heading-æ‰‡è¡Œäº¤æ¢æœº">æ‰‡è¡Œäº¤æ¢æœº</h2>

<p>æ‰‡å½¢äº¤æ¢æœº å°†æ¶ˆæ¯å‘é€åˆ°ç»‘å®šè¯¥äº¤æ¢æœºä¸Šçš„æ‰€æœ‰é˜Ÿåˆ—ï¼Œè€Œä¸åœ¨æ„è·¯ç”±é”®ï¼Œå½“æ¶ˆæ¯å‘ç»™é˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¼šcopyæ¶ˆæ¯å‘ç»™æ‰€æœ‰é˜Ÿåˆ—ã€‚</p>

<p>ğŸŒ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œäº¤æ¢æœºï¼Œç»‘å®šå…³ç³»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>my-exchange ---my-routing-key1--- my-queue1    
            +--my-routing-key2--- my-queue2    
            +--my-routing1-key1-- my-queue3    
</code></pre></div></div>

<p>ç»™ my-exchange, my-routing-key* å‘æ¶ˆæ¯ï¼Œmy-queue1 å’Œ my-queue2 ä¼šæ”¶åˆ°ï¼Œmy-quque3 æ”¶ä¸åˆ°</p>

<h3 id="heading-demo-2">demo</h3>

<p><strong>æ¶ˆæ¯æ¥å—è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">exchange_result</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_fanout'</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s">'fanout'</span><span class="p">)</span>
<span class="n">queue_result</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">'demo_fanout_q'</span><span class="p">)</span>

<span class="k">print</span> <span class="n">exchange_result</span>
<span class="k">print</span> <span class="n">exchange_result</span><span class="p">.</span><span class="n">method</span>

<span class="n">queue</span> <span class="o">=</span> <span class="n">queue_result</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">queue</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">body</span>


<span class="n">channel</span><span class="p">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_fanout'</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s">'demo_fanout_q'</span><span class="p">)</span>

<span class="n">channel</span><span class="p">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="s">'demo_fanout_q'</span><span class="p">,</span>
                     <span class="p">)</span>


<span class="k">print</span> <span class="s">'start consuming'</span>

<span class="n">channel</span><span class="p">.</span><span class="n">start_consuming</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>æ¶ˆæ¯å‘é€è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="p">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_fanout'</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s">'fanout'</span><span class="p">)</span>


<span class="n">body</span> <span class="o">=</span> <span class="s">"hello world"</span>

<span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span>
                      <span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_fanout'</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

<span class="k">print</span> <span class="s">'send success, body :%s'</span> <span class="o">%</span> <span class="n">body</span>

<span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></div></div>

<blockquote>
  <p>âš ï¸ å¯ä»¥æŠŠæ¥å—è€…å¯åŠ¨å¤šä¸ªä¸åŒåçš„é˜Ÿåˆ—ï¼Œè¿™æ ·å‘é€è€…å‘é€æ¶ˆæ¯ï¼Œå°†ä¼šå…¨éƒ¨é€è¾¾ç»™ç»‘å®šè¯¥Eçš„æ¶ˆæ¯æ¥å—è€…ï¼Œè€Œä¸å…³å¿ƒroutingkey</p>
</blockquote>

<h2 id="heading-ä¸»é¢˜äº¤æ¢æœº">ä¸»é¢˜äº¤æ¢æœº</h2>

<p>ä¸»é¢˜äº¤æ¢æœº å°†å¸¦ç€è·¯ç”±é”®çš„æ¶ˆæ¯å‘ç»™ äº¤æ¢æœºå’Œé˜Ÿåˆ—ä¸”è·¯ç”±é”®åŒ¹é…çš„ç»‘å®šä¸Š</p>

<h3 id="heading-demo-3">demo</h3>

<p><strong>æ¶ˆæ¯æ¥å—è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">exchange_result</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_topic'</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s">'topic'</span><span class="p">)</span>
<span class="n">queue_result</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">'demo_topic_q'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">body</span>


<span class="n">channel</span><span class="p">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_topic'</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s">'demo_topic_q'</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="s">'demo.*'</span><span class="p">)</span>

<span class="n">channel</span><span class="p">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="s">'demo_topic_q'</span><span class="p">,</span>
                      <span class="n">no_ack</span><span class="o">=</span><span class="bp">True</span>
                     <span class="p">)</span>


<span class="k">print</span> <span class="s">'start consuming'</span>

<span class="n">channel</span><span class="p">.</span><span class="n">start_consuming</span><span class="p">()</span>

</code></pre></div></div>

<p><strong>æ¶ˆæ¯å‘é€è€…</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">'guest'</span><span class="p">,</span> <span class="s">'guest'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>  <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="p">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_topic'</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s">'topic'</span><span class="p">)</span>


<span class="n">body</span> <span class="o">=</span> <span class="s">"hello world"</span>

<span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span>
                      <span class="n">exchange</span><span class="o">=</span><span class="s">'demo_exchange_topic'</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s">'demo.topic'</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

<span class="k">print</span> <span class="s">'send success, body :%s'</span> <span class="o">%</span> <span class="n">body</span>

<span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></div></div>

<blockquote>
  <p>âš ï¸ æ¶ˆæ¯æ¥å—è€… çš„ routing_key å¿…é¡»æ˜¯ <code class="language-plaintext highlighter-rouge">.</code> åˆ†å‰²ï¼Œ å¯ä»¥ç”¨ <code class="language-plaintext highlighter-rouge">*</code>ä»£è¡¨ä¸€ä¸ªä»»æ„å•è¯ï¼Œ <code class="language-plaintext highlighter-rouge">#</code>ä»£è¡¨0ä¸ªæˆ–è€…å¤šä¸ªå•è¯ (ps å½“ç„¶ç”¨ é™¤äº†<code class="language-plaintext highlighter-rouge">.</code>ä¹‹å¤–çš„å…¶ä»–å­—ç¬¦è¡¨ç¤ºrouting_keyä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯éƒ½ä¸ä¼šåœ¨ <code class="language-plaintext highlighter-rouge">*/#</code>ä¸Šèµ·ä½œç”¨)</p>
</blockquote>

<blockquote>
  <p>å°æç¤º:</p>
  <ul>
    <li>å¦‚æœä¸çŸ¥é“pythonå…·ä½“æ¥å£å’Œæ–‡æ¡£ï¼Œ ä½¿ç”¨help(model) å³å¯ï¼Œæ¯”å¦‚ help(pika)</li>
  </ul>
</blockquote>

<h2 id="heading-å¤´äº¤æ¢æœº">å¤´äº¤æ¢æœº</h2>

<p>å¤´äº¤æ¢æœºä½¿ç”¨å¤šä¸ªæ¶ˆæ¯å±æ€§æ¥ä»£æ›¿è·¯ç”±é”®å»ºç«‹è·¯ç”±è§„åˆ™ã€‚é€šè¿‡åˆ¤æ–­æ¶ˆæ¯å¤´çš„å€¼èƒ½å¦ä¸æŒ‡å®šçš„ç»‘å®šç›¸åŒ¹é…æ¥ç¡®ç«‹è·¯ç”±è§„åˆ™.</p>

<p>å¤´äº¤æ¢æœºå¯ä»¥è§†ä¸ºç›´è¿äº¤æ¢æœºçš„å¦ä¸€ç§è¡¨ç°å½¢å¼ã€‚å¤´äº¤æ¢æœºèƒ½å¤Ÿåƒç›´è¿äº¤æ¢æœºä¸€æ ·å·¥ä½œï¼Œä¸åŒä¹‹å¤„åœ¨äºå¤´äº¤æ¢æœºçš„è·¯ç”±è§„åˆ™æ˜¯å»ºç«‹åœ¨å¤´å±æ€§å€¼ä¹‹ä¸Šï¼Œè€Œä¸æ˜¯è·¯ç”±é”®ã€‚è·¯ç”±é”®å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œå¤´å±æ€§å€¼åˆ™æ²¡æœ‰è¿™ä¸ªçº¦æŸï¼Œå®ƒä»¬ç”šè‡³å¯ä»¥æ˜¯æ•´æ•°æˆ–è€…å“ˆå¸Œå€¼ï¼ˆå­—å…¸ï¼‰ç­‰</p>

<h1 id="heading-å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h1>

<blockquote>
  <p><a href="http://rabbitmq.mr-ping.com/">RabbitMQ GitBook æ–‡æ¡£</a></p>
</blockquote>

:ET